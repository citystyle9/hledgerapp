<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HomeLedger v1.4.9 (G-Sheets)</title>
  <style>
    /* ------------------------------------------------------------------- */
    /* 1. CSS Variables and Theme Setup */
    /* ------------------------------------------------------------------- */
    :root{
      /* CORE COLORS */
      --bg:#0a0d14; 
      --panel:#1f2937;
      --glass-border:#4b5563;
      --muted:#f3f4f6; 
      
      /* UTILITY COLORS */
      --accent:#60a5fa; --success:#34d399; --warning:#fbbf24; --danger:#ef4444;
      
      /* SEMANTIC VARIABLES */
      --text-color: var(--muted);
      --input-bg: var(--bg); 
      --input-border: var(--glass-border);
      --focus-outline-color: var(--accent);
      --active-filter-bg: var(--accent);

      --font:Inter,ui-sans-serif,system-ui; --gap:12px;
    }
    
    body[data-theme="light"]{
      --bg:#f9fafb; 
      --panel:#ffffff; 
      --glass-border:#e5e7eb; 
      --muted:#1f2937;
      --text-color: var(--muted);
      --input-bg: var(--panel);
      --input-border: var(--glass-border);
    }

    body[data-theme="terminal"]{
      --bg:#000000; 
      --panel:#1f2937;
      --glass-border:#374151;
      --muted:#00ff41; 
      --accent: var(--muted);
      --text-color: var(--muted);
      --input-bg: var(--bg);
      --input-border: var(--muted);
    }

    /* ------------------------------------------------------------------- */
    /* 2. Global Styles and Layout */
    /* ------------------------------------------------------------------- */
    *{box-sizing:border-box}
    html,body{padding:0; margin:0; height:100%;}
    body{
      font-family:var(--font); 
      background-color:var(--bg); 
      color:var(--text-color); 
      display:flex; 
      flex-direction:column;
      overflow-y:scroll;
      transition: background-color 0.3s, color 0.3s;
    }

    /* main structure */
    #header{
      display:flex; justify-content:space-between; align-items:center;
      padding:var(--gap); border-bottom:1px solid var(--glass-border);
      gap:var(--gap); position:sticky; top:0; z-index:10; background-color:var(--bg);
    }
    #controls{display:flex; gap:var(--gap); align-items:center;}
    #app-container{
      display:grid; grid-template-rows:auto 1fr auto; 
      padding:var(--gap); gap:var(--gap); flex-grow:1;
    }
    #grand-total{
      font-size:2rem; font-weight:700; text-align:center; padding:var(--gap) 0;
    }
    #quick-filters{display:flex; justify-content:center; gap:var(--gap); padding:5px 0;}
    #records-header{
      display:flex; padding:var(--gap); font-weight:700;
      border-bottom:1px solid var(--glass-border);
    }
    #records-list{flex-grow:1;}
    #footer{
      padding:var(--gap); border-top:1px solid var(--glass-border); 
      text-align:center; font-size:0.8rem; color:var(--glass-border);
      margin-top:auto;
    }

    /* ------------------------------------------------------------------- */
    /* 3. Utility Components (Buttons, Inputs, etc.) */
    /* ------------------------------------------------------------------- */
    .btn{
      padding:8px 15px; border:1px solid var(--input-border); 
      background-color:var(--panel); color:var(--text-color); 
      cursor:pointer; font-size:1rem; border-radius:4px;
      transition:all 0.2s;
    }
    .btn:hover{
      background-color:var(--glass-border); 
      border-color:var(--text-color);
    }
    .btn.accent{background-color:var(--accent); color:var(--bg); border-color:var(--accent);}
    .btn.accent:hover{background-color:#4b8afc; border-color:#4b8afc;}
    .btn.danger{background-color:var(--danger); color:var(--bg); border-color:var(--danger);}
    .btn.danger:hover{background-color:#c83b3b; border-color:#c83b3b;}
    .btn.filter{
      padding:5px 10px; font-size:0.9rem; background-color:var(--bg);
      border-color:var(--glass-border);
    }
    .btn.filter.active{
      background-color:var(--active-filter-bg); color:var(--bg); border-color:var(--active-filter-bg);
    }

    input, select{
      padding:8px 10px; border:1px solid var(--input-border); 
      background-color:var(--input-bg); color:var(--text-color); 
      border-radius:4px; font-size:1rem;
    }
    input:focus, select:focus{
      outline:1px solid var(--focus-outline-color); 
      border-color:var(--focus-outline-color);
    }
    
    /* ------------------------------------------------------------------- */
    /* 4. Records List Specifics */
    /* ------------------------------------------------------------------- */
    .record, #records-header{
      display:grid;
      /* Main grid layout for all records */
      grid-template-columns: 120px 100px 1fr 100px 80px;
      gap:5px;
      align-items:center;
    }
    .record{
      padding:var(--gap); border-bottom:1px solid var(--glass-border);
      font-size:0.9rem;
    }
    .record:last-child{border-bottom:none;}
    .record:hover{background-color:var(--panel);}

    .record-col{overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .record-col:nth-child(4){text-align:right; font-weight:700;}
    .record-col:nth-child(5){text-align:center;}

    /* Styling for Expense/Income */
    .record-col.sign[data-sign="-"]{color:var(--danger);}
    .record-col.sign[data-sign="+"]{color:var(--success);}
    
    /* Sort Indicator */
    #records-header > div{cursor:pointer; user-select:none; position:relative;}
    #records-header > div:hover{color:var(--accent);}
    #records-header > div[data-sort-order]::after{
        content:'\25b2'; /* Up arrow */
        margin-left:5px; font-size:0.7em;
        position:absolute; right:0; top:5px;
    }
    #records-header > div[data-sort-order="desc"]::after{
        content:'\25bc'; /* Down arrow */
    }

    /* ------------------------------------------------------------------- */
    /* 5. Modal and Overlay */
    /* ------------------------------------------------------------------- */
    #overlay{
      position:fixed; top:0; left:0; right:0; bottom:0; 
      background-color:rgba(0,0,0,0.8); z-index:100;
      display:none; justify-content:center; align-items:center;
    }
    #modal{
      background-color:var(--panel); padding:20px; 
      border-radius:8px; width:90%; max-width:400px;
      display:flex; flex-direction:column; gap:var(--gap);
      border:1px solid var(--glass-border);
    }
    #modal h3{margin-top:0; color:var(--accent);}
    #modal label{font-size:0.9rem; margin-bottom:5px; display:block;}
    #modal input, #modal select{width:100%; margin-top:5px;}
    #modal-actions{display:flex; justify-content:flex-end; gap:var(--gap); margin-top:var(--gap);}
    .form-group{margin-bottom:var(--gap);}

    /* ------------------------------------------------------------------- */
    /* 6. Mobile Responsiveness */
    /* ------------------------------------------------------------------- */
    @media (max-width: 420px) {
      /* Hide unnecessary columns on very small screens (iPhone 6/7/8/X size) */
      .record, #records-header {
        /* Grid: Date | Account | Description | Amount | Action */
        /* Hiding 2nd (Account), 3rd (Description), 5th (Action) */
        /* New Grid: Date | Amount | Action */
        grid-template-columns: 1fr 100px 50px; 
        padding: 10px 8px;
        font-size: 0.85rem;
      }
      .record-col:nth-child(2), /* Account */
      .record-col:nth-child(3), /* Description */
      .record-col:nth-child(5) /* Action (hiding button column for simplicity, showing only edit/delete within record) */
      {
        display: none;
      }
      .record-col:nth-child(1) { width: auto; } /* Date */
      .record-col:nth-child(4) { /* Amount */
        grid-column: 2 / 3;
        text-align: right;
      }
      .record-col:nth-child(5) {
        grid-column: 3 / 4;
      }
      
      #header {
        flex-direction: column;
        align-items: stretch;
      }
      #controls {
        justify-content: space-between;
        width: 100%;
      }
      #modal {
        max-width: 95%;
        margin: 10px;
      }
      #records-header > div:nth-child(2), /* Account Header */
      #records-header > div:nth-child(3), /* Description Header */
      #records-header > div:nth-child(5) /* Action Header */
      {
          display: none;
      }
      /* Re-styling the mobile visible headers */
      #records-header > div:nth-child(1) { grid-column: 1 / 2; }
      #records-header > div:nth-child(4) { grid-column: 2 / 3; text-align: right; }
    }
    
    /* Logs Modal */
    #logs-modal {
        max-height: 80vh; 
        overflow-y: auto; 
        width: 90%; 
        max-width: 600px;
        font-family: monospace;
        font-size: 0.8rem;
    }
    .log-entry {
        border-bottom: 1px dotted var(--glass-border);
        padding: 5px 0;
    }
    .log-entry:last-child {
        border-bottom: none;
    }

  </style>
</head>
<body>

  <div id="header">
    <div id="app-title">
      <span style="font-size:1.5rem; font-weight:700;">HomeLedger</span> 
      <span style="font-size:0.8rem; color:var(--glass-border);">v1.4.9 (G-Sheets)</span>
    </div>
    <div id="controls">
      <button class="btn" id="add-record-btn">Add Record</button>
      <button class="btn" id="logs-btn">Logs</button>
      <button class="btn" id="theme-toggle">Theme</button>
    </div>
  </div>

  <div id="app-container">
    <div id="grand-total"></div>
    
    <div id="quick-filters">
      <button class="btn filter" data-filter="all">All</button>
      <button class="btn filter" data-filter="today">Today</button>
      <button class="btn filter" data-filter="week">7 Days</button>
      <button class="btn filter" data-filter="month">30 Days</button>
    </div>

    <div id="records-table">
      <div id="records-header">
        <div data-sort-key="date">Date</div>
        <div data-sort-key="account">Account</div>
        <div data-sort-key="desc">Description</div>
        <div data-sort-key="amount">Amount</div>
        <div>Action</div>
      </div>
      <div id="records-list">
        </div>
    </div>
  </div>

  <div id="footer">
    Data is stored in Google Sheets via Google Apps Script. 
    <span id="gs-status" style="color:var(--warning);">Loading...</span>
  </div>

  <div id="overlay">
    <div id="modal">
      <h3 id="modal-title">Add New Record</h3>
      <form id="record-form">
        <div class="form-group">
          <label for="date-input">Date:</label>
          <input type="date" id="date-input" required />
        </div>
        <div class="form-group">
          <label for="account-select">Account:</label>
          <select id="account-select" required>
            </select>
        </div>
        <div class="form-group">
          <label for="desc-input">Description:</label>
          <input type="text" id="desc-input" placeholder="e.g. Salary, Rent, Groceries" required />
        </div>
        <div class="form-group">
          <label for="amt-input">Amount:</label>
          <input type="number" id="amt-input" min="0.01" step="0.01" required />
        </div>
        <div id="modal-actions">
          <button type="button" class="btn" id="cancel-btn">Cancel</button>
          <button type="submit" class="btn accent" id="save-btn">Save Record</button>
        </div>
      </form>
    </div>
  </div>

  <div id="logs-overlay" style="display:none;">
    <div id="logs-modal" class="modal">
      <h3 id="logs-modal-title">Application Logs</h3>
      <div id="logs-content" style="border:1px solid var(--glass-border); padding:10px; border-radius:4px;">
        </div>
      <div id="modal-actions">
        <button type="button" class="btn" id="close-logs-btn">Close</button>
      </div>
    </div>
  </div>

  <script>
    // -------------------------------------------------------------------
    // 0. Environment Setup and Globals
    // -------------------------------------------------------------------
    
    // âœ… Apps Script URL
    const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbyqT9-ZKHkdbQHcP0Uro5PqgffKlgeGhapRRgn7MgA3i0QgZTipoVxBYqY9NiIHc_LS/exec';
    
    const STORAGE_KEY = 'homeledger_google_store_data_v1'; 
    const THEME_KEY = 'homeledger_theme';
    const VERSION_TAG = 'v1.4.9 (G-Sheets)';

    // Default State and Store
    const defaultAccounts = {
        'Wallet (Cash)': { type: 'asset', sign: '-' },
        'Bank (HBL)': { type: 'asset', sign: '-' },
        'Salary (Income)': { type: 'income', sign: '+' }
    };

    const defaultSort = { key: 'date', order: 'desc' };

    let store = {
        records: [], // Ab records Google Sheets se load honge
        accounts: defaultAccounts,
        currentSort: defaultSort,
        quickFilter: 'today',
        logs: [],
        grandTotal: 0
    };
    
    // Global utility function for logging timestamp
    const nowTsForLog = () => new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
    const seedSampleData = () => []; 

    // -------------------------------------------------------------------
    // 1. DOM References
    // -------------------------------------------------------------------
    const overlay = document.querySelector('#overlay');
    const logsOverlay = document.querySelector('#logs-overlay');
    const modal = document.querySelector('#modal');
    const recordsList = document.querySelector('#records-list');
    const recordsHead = document.querySelector('#records-header');
    const quickFilters = document.querySelector('#quick-filters');
    const grandTotalEl = document.querySelector('#grand-total');
    const accountSelect = document.querySelector('#account-select');
    const dateInput = document.querySelector('#date-input');
    const descInput = document.querySelector('#desc-input');
    const amtInput = document.querySelector('#amt-input');
    const form = document.querySelector('#record-form');
    const gsStatusEl = document.querySelector('#gs-status');
    
    let currentMode = 'add'; // 'add' or 'edit'

    // -------------------------------------------------------------------
    // 2. Data Storage and Retrieval (MODIFIED FOR GOOGLE SHEETS)
    // -------------------------------------------------------------------

    function saveToStorage() {
        // Ab ye function Local Storage main sirf settings aur logs save karega, records nahi.
        const dataToSave = {
            logs: store.logs,
            accounts: store.accounts,
            currentSort: store.currentSort,
            quickFilter: store.quickFilter
        };

        localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
        renderLogs();
    }

    function loadFromStorage() {
        // Ab ye function sirf settings aur logs load karega.
        const serializedStore = localStorage.getItem(STORAGE_KEY);
        if (serializedStore) {
            try {
                const loadedData = JSON.parse(serializedStore);
                store.logs = loadedData.logs || [];
                store.accounts = loadedData.accounts || defaultAccounts;
                store.currentSort = loadedData.currentSort || defaultSort;
                store.quickFilter = loadedData.quickFilter || 'today';
                
            } catch (e) {
                console.error("Error loading settings from LocalStorage:", e);
                store.logs.unshift(`[${nowTsForLog()}] ERROR: Corrupted LocalStorage settings.`);
            }
        }
    }

    // -------------------------------------------------------------------
    // 3. Data Loading from Google Sheets (NEW CORE FUNCTION)
    // -------------------------------------------------------------------

    async function loadDataFromSheets() {
        gsStatusEl.textContent = 'Loading...';
        gsStatusEl.style.color = 'var(--warning)';
        recordsList.innerHTML = `<div style="text-align:center; padding: 20px;">Loading data from Google Sheets...</div>`;
        
        try {
            // GET request bhej kar data mangwaen
            const response = await fetch(SHEET_API_URL, { method: 'GET' });
            if (!response.ok) {
                 // Throw an error if the network request fails (e.g., offline)
                 throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
            }
            const data = await response.json();
            
            if (data.records) {
                // Sheets se milay records ko store main daal den
                store.records = data.records;
                
                // Grand Total aur display update karein
                recalcGrandTotal(); 
                applyFilter();

                gsStatusEl.textContent = 'Synced';
                gsStatusEl.style.color = 'var(--success)';
                store.logs.unshift(`[${nowTsForLog()}] Data loaded from Sheets successfully (${store.records.length} records).`);
                saveToStorage(); 
            } else {
                // Agar records nahi mile to sirf logs update karein
                gsStatusEl.textContent = 'Loaded (No Records)';
                gsStatusEl.style.color = 'var(--warning)';
                store.records = [];
                recalcGrandTotal(); 
                applyFilter();
                store.logs.unshift(`[${nowTsForLog()}] Data loaded, but records array is empty or missing.`);
                saveToStorage(); 
            }

        } catch (error) {
            gsStatusEl.textContent = 'ERROR!';
            gsStatusEl.style.color = 'var(--danger)';
            recordsList.innerHTML = `<div style="text-align:center; padding: 20px; color: var(--danger);">
                ðŸš¨ Error loading data from Google Sheets. Check your Apps Script URL or Network.
                <br>Details: ${error.message}
            </div>`;
            store.logs.unshift(`[${nowTsForLog()}] ERROR: Failed to load data from Sheets: ${error.message}`);
            saveToStorage();
        }
    }


    // -------------------------------------------------------------------
    // 4. Record Handlers (UPDATED saveHandler)
    // -------------------------------------------------------------------

    function openModal(mode, record = null) {
        // ... (Existing openModal code remains the same) ...
        currentMode = mode;
        
        // Populate Account Options
        accountSelect.innerHTML = Object.keys(store.accounts).map(name => 
            `<option value="${name}">${name} (${store.accounts[name].sign})</option>`
        ).join('');

        if (mode === 'add') {
            document.querySelector('#modal-title').textContent = 'Add New Record';
            form.reset();
            dateInput.value = new Date().toISOString().substring(0, 10);
            overlay.dataset.editId = '';
        } else {
            document.querySelector('#modal-title').textContent = 'Edit Record (Sheets v. Simple)';
            // NOTE: Editing records in a Sheet requires the 'ID' and is more complex. 
            // For simplicity in this version, we will only show the data.
            overlay.dataset.editId = record.id;
            dateInput.value = record.date;
            accountSelect.value = record.account;
            descInput.value = record.desc;
            amtInput.value = record.amount;
            document.querySelector('#save-btn').textContent = 'Update Record'; // Button text update
            
            // NOTE: The actual editing logic in saveHandler will be simplified
        }
        
        overlay.style.display = 'flex';
    }

    function closeModal() {
        overlay.style.display = 'none';
        document.querySelector('#save-btn').textContent = 'Save Record';
    }

    async function saveHandler(e) {
        e.preventDefault();

        // No need to check URL here, as it is already defined

        const mode = currentMode;
        
        // Validation checks
        if (!dateInput.value || !accountSelect.value || !descInput.value.trim() || !amtInput.value) {
            alert('Please fill in all fields.');
            return;
        }

        // Record data tayyar karna
        const recordData = {
            date: dateInput.value,
            account: accountSelect.value,
            desc: descInput.value.trim(),
            amount: Number(amtInput.value),
            sign: getSignForAccount(accountSelect.value),
            id: mode === 'add' ? 'r' + Date.now() : overlay.dataset.editId 
        };

        // WARNING for Edit Mode simplicity
        if (mode === 'edit') {
            // For the sake of simplicity, we are treating edits as a NEW record submission.
            // A full implementation requires a more complex Apps Script (updateRowById).
            alert('ðŸš¨ Warning: Edit mode is currently simplified. This action will submit a NEW record instead of updating the existing one in the Sheet.');
            recordData.id = 'r' + Date.now(); // Ensure new ID for new row
        }
        
        gsStatusEl.textContent = 'Saving...';
        gsStatusEl.style.color = 'var(--warning)';

        // POST request bhej kar data Google Sheets main save karein
        try {
            const response = await fetch(SHEET_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(recordData)
            });
            
            const data = await response.json();

            if (data.result === 'success') {
                store.logs.unshift(`[${nowTsForLog()}] Record saved to Google Sheets (ID: ${recordData.id}).`);
                saveToStorage(); // Log save karein
                closeModal();
                
                // Data save hone ke baad, dobara Sheets se data load karein taake list update ho jaye
                await loadDataFromSheets(); 
                
            } else {
                alert('ðŸš¨ Error saving data to Google Sheets: ' + data.message);
                store.logs.unshift(`[${nowTsForLog()}] ERROR: Failed to save record to Sheets: ${data.message}`);
                saveToStorage();
            }

        } catch (error) {
            gsStatusEl.textContent = 'ERROR!';
            gsStatusEl.style.color = 'var(--danger)';
            alert('âš ï¸ Network Error: Could not connect to Google Sheets. Check API URL or Internet connection.');
            store.logs.unshift(`[${nowTsForLog()}] ERROR: Network failure during save: ${error.message}`);
            saveToStorage();
        }
    }
    
    // Existing deleteHandler remains the same (but will not work as it needs Sheets API)
    function deleteHandler(recordId) {
        alert(`ðŸš¨ Deletion is not yet supported in this Google Sheets version. You must delete the row manually in the Google Sheet with ID: ${recordId}`);
        store.logs.unshift(`[${nowTsForLog()}] DELETION NOT ALLOWED: User attempted to delete record ID: ${recordId}`);
        saveToStorage();
    }
    
    function getSignForAccount(accountName) {
        const account = store.accounts[accountName];
        if (account && account.type === 'asset') return '-';
        if (account && account.type === 'income') return '+';
        return '-';
    }


    // -------------------------------------------------------------------
    // 5. Utility Functions (Rendering, Sorting, Filtering, etc.)
    // -------------------------------------------------------------------
    
    function recalcGrandTotal() {
        const total = store.records.reduce((sum, record) => {
            const amount = Number(record.amount) || 0;
            return record.sign === '+' ? sum + amount : sum - amount;
        }, 0);
        store.grandTotal = total;
        
        const totalText = new Intl.NumberFormat('en-US', { 
            style: 'currency', 
            currency: 'PKR', 
            minimumFractionDigits: 0 
        }).format(total);
        
        grandTotalEl.textContent = totalText;
        grandTotalEl.style.color = total >= 0 ? 'var(--success)' : 'var(--danger)';
    }
    
    function renderRecords(recordsToRender) {
        if (recordsToRender.length === 0) {
            recordsList.innerHTML = `<div style="text-align:center; padding: 20px;">No records found for this filter.</div>`;
            return;
        }

        recordsList.innerHTML = recordsToRender.map(record => `
            <div class="record" data-id="${record.id}">
                <div class="record-col">${record.date}</div>
                <div class="record-col">${record.account}</div>
                <div class="record-col">${record.desc}</div>
                <div class="record-col sign" data-sign="${record.sign}">${record.sign}${Number(record.amount).toLocaleString('en-US', { minimumFractionDigits: 0 })}</div>
                <div class="record-col action">
                    <button class="btn accent btn-small" onclick="openModal('edit', getRecordById('${record.id}'))" style="padding: 2px 5px; font-size: 0.75rem;">Edit</button>
                    <button class="btn danger btn-small" onclick="deleteHandler('${record.id}')" style="padding: 2px 5px; font-size: 0.75rem;">Del</button>
                </div>
            </div>
        `).join('');
    }

    function applyFilter() {
        // ... (Existing sorting and filtering logic remains the same) ...
        const filterKey = store.quickFilter;
        const today = new Date();
        let startDate;

        switch(filterKey) {
            case 'today':
                startDate = new Date(today);
                startDate.setHours(0, 0, 0, 0);
                break;
            case 'week':
                startDate = new Date(today);
                startDate.setDate(today.getDate() - 7);
                startDate.setHours(0, 0, 0, 0);
                break;
            case 'month':
                startDate = new Date(today);
                startDate.setDate(today.getDate() - 30);
                startDate.setHours(0, 0, 0, 0);
                break;
            case 'all':
            default:
                startDate = null; // show all
        }

        // Apply filtering
        let filteredRecords = store.records.filter(record => {
            if (startDate === null) return true;
            const recordDate = new Date(record.date);
            return recordDate >= startDate;
        });

        // Apply sorting
        filteredRecords.sort((a, b) => {
            const key = store.currentSort.key;
            const order = store.currentSort.order;
            let valA, valB;

            if (key === 'amount') {
                valA = Number(a.amount);
                valB = Number(b.amount);
            } else {
                valA = a[key];
                valB = b[key];
            }

            if (valA < valB) return order === 'asc' ? -1 : 1;
            if (valA > valB) return order === 'asc' ? 1 : -1;
            return 0;
        });

        // Update active filter button
        document.querySelectorAll('.btn.filter').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.querySelector(`.btn.filter[data-filter="${filterKey}"]`);
        if (activeBtn) activeBtn.classList.add('active');

        renderRecords(filteredRecords);
    }

    function setQuickFilter(filterKey) {
        store.quickFilter = filterKey;
        saveToStorage();
        applyFilter();
    }
    
    function sortHandler(e) {
        const sortKey = e.target.dataset.sortKey;
        if (!sortKey) return;

        let order = 'asc';
        if (store.currentSort.key === sortKey) {
            order = store.currentSort.order === 'asc' ? 'desc' : 'asc';
        }

        // Clear existing sort indicators
        recordsHead.querySelectorAll('div[data-sort-order]').forEach(div => div.removeAttribute('data-sort-order'));
        
        // Set new indicator
        e.target.setAttribute('data-sort-order', order);

        store.currentSort = { key: sortKey, order: order };
        saveToStorage();
        applyFilter();
    }
    
    function getRecordById(id) {
        return store.records.find(r => r.id === id);
    }
    
    // Logs functions (unchanged)
    function renderLogs() {
        const logsContent = document.querySelector('#logs-content');
        if (logsContent) {
            logsContent.innerHTML = store.logs.map(log => `<div class="log-entry">${log}</div>`).join('');
        }
    }

    function openLogsModal() {
        renderLogs();
        logsOverlay.style.display = 'flex';
    }

    function closeLogsModal() {
        logsOverlay.style.display = 'none';
    }

    // Theme toggle (unchanged)
    function applyTheme(theme) {
        document.body.setAttribute('data-theme', theme);
        localStorage.setItem(THEME_KEY, theme);
    }

    // -------------------------------------------------------------------
    // 6. Event Listeners
    // -------------------------------------------------------------------
    document.querySelector('#add-record-btn').addEventListener('click', () => openModal('add'));
    document.querySelector('#cancel-btn').addEventListener('click', closeModal);
    document.querySelector('#logs-btn').addEventListener('click', openLogsModal);
    document.querySelector('#close-logs-btn').addEventListener('click', closeLogsModal);
    document.querySelector('#theme-toggle').addEventListener('click', () => {
        const currentTheme = document.body.getAttribute('data-theme') || 'dark';
        const newTheme = currentTheme === 'dark' ? 'light' : (currentTheme === 'light' ? 'terminal' : 'dark');
        applyTheme(newTheme);
        store.logs.unshift(`[${nowTsForLog()}] Theme set to ${newTheme}.`);
        saveToStorage();
    });
    
    form.addEventListener('submit', saveHandler);
    recordsHead.addEventListener('click', sortHandler);
    quickFilters.addEventListener('click', (e) => {
        if (e.target.classList.contains('filter')) {
            setQuickFilter(e.target.dataset.filter);
        }
    });


    // -------------------------------------------------------------------
    // 7. Initial Load (UPDATED TO LOAD FROM SHEETS)
    // -------------------------------------------------------------------
    loadFromStorage(); // Pehle settings aur logs load kar len
    loadDataFromSheets(); // Ab Records Google Sheets se load honge

    if (store.logs.length === 0){
        store.logs.unshift(`[${nowTsForLog()}] App loaded (${VERSION_TAG})`);
    }

    const savedTheme = localStorage.getItem(THEME_KEY) || 'dark';
    applyTheme(savedTheme);
    
    const initialHeader = recordsHead.querySelector(`div[data-sort-key="${store.currentSort.key}"]`);
    if (initialHeader) {
        initialHeader.setAttribute('data-sort-order', store.currentSort.order);
    }
    
    // setQuickFilter(store.quickFilter); // loadDataFromSheets ke andar applyFilter() call ho raha hai

    renderLogs();
    recalcGrandTotal(); 

    window._homeledger = {
        store: store,
        saveToStorage: saveToStorage,
        recalcGrandTotal: recalcGrandTotal,
        loadDataFromSheets: loadDataFromSheets
    };
  </script>
</body>
</html>
