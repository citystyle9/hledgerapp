<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HomeLedger v1.5.3</title>

  <link rel="manifest" href="/hledgerapp/manifest.json" />
  <link rel="icon" type="image/png" sizes="32x32" href="/hledgerapp/icons/icon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/hledgerapp/icons/icon-16x16.png">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0a0d14;
      color: #f3f4f6;
      margin: 0;
      padding: 20px;
    }
    button { cursor: pointer; }
    #records-section { margin-top: 20px; }
    .record-row { border-bottom: 1px solid #333; padding: 6px 0; display: flex; justify-content: space-between; }
    .overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; }
    .overlay.show { display:flex; }
  </style>
</head>
<body data-theme="dark">

  <h1 style="color:#60a5fa;">HomeLedger</h1>

  <div class="top-controls">
    <button id="btn-add-income">+ Add Income</button>
    <button id="btn-add-expense">+ Add Expense</button>
    <button id="btn-backup">Backup</button>
    <button id="btn-restore-sheet">üåê Restore from Sheet</button>
  </div>

  <section id="records-section"></section>

  <div id="log-overlay" class="overlay">
    <div style="background:#1f2937;padding:20px;border-radius:10px;color:#fff;">
      <h2>Activity Log</h2>
      <div id="activity-log-modal" style="max-height:300px;overflow:auto;"></div>
      <button id="log-close">Close</button>
    </div>
  </div>

  <script>
  (function() {

    const GOOGLE_SHEETS_WEBHOOK = "https://script.google.com/macros/s/AKfycbzFsmbBc9RPcDUDL97TAhGXl5bSpkZO47_EMIUIznZ1PSRf4vvb0En9sRGP3pSz381X/exec";

    const STORAGE_KEY = 'homeledger_v1_data_v1';
    let store = { records: [], logs: [] };

    const recordsSection = document.getElementById('records-section');
    const logOverlay = document.getElementById('log-overlay');
    const logClose = document.getElementById('log-close');
    const btnRestoreSheet = document.getElementById('btn-restore-sheet');
    const btnBackup = document.getElementById('btn-backup');

    function nowTs() {
      const d = new Date();
      return d.toISOString().replace('T', ' ').split('.')[0];
    }

    function addLog(msg) {
      store.logs.unshift(`[${nowTs()}] ${msg}`);
      console.log(msg);
      renderLogs();
      saveToStorage();
    }

    function saveToStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
    }

    function loadFromStorage() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) store = JSON.parse(raw);
    }

    function renderRecords() {
      recordsSection.innerHTML = '';
      if (store.records.length === 0) {
        recordsSection.innerHTML = "<p style='color:#777;'>No records found.</p>";
        return;
      }
      store.records.forEach(r => {
        const div = document.createElement('div');
        div.className = 'record-row';
        div.innerHTML = `<span>${r.date}</span><span>${r.account}</span><span>${r.desc}</span><span>${r.amount}</span>`;
        recordsSection.appendChild(div);
      });
    }

    function renderLogs() {
      const logDiv = document.getElementById('activity-log-modal');
      logDiv.innerHTML = store.logs.map(l => `<div>${l}</div>`).join('');
    }

    logClose.addEventListener('click', () => logOverlay.classList.remove('show'));
    document.getElementById('btn-add-income').addEventListener('click', () => alert('Add Income form here...'));
    document.getElementById('btn-add-expense').addEventListener('click', () => alert('Add Expense form here...'));
    btnBackup.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(store, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'homeledger_backup.json';
      a.click();
      addLog('Local backup created.');
    });

    // =============== JSONP Restore (CORS-safe) =================
    function restoreDataFromSheets() {
      if (!confirm("Restore ALL active records from Google Sheet?")) return;

      addLog("Starting restore (JSONP) ...");
      const callbackName = "homeledger_cb_" + Date.now();
      const url = GOOGLE_SHEETS_WEBHOOK + "?action=getall&callback=" + callbackName;

      window[callbackName] = function(response) {
        try {
          if (response && Array.isArray(response.records)) {
            store.records = response.records;
            addLog(`Restored ${response.records.length} records from Google Sheet.`);
            renderRecords();
            alert("Restore successful!");
          } else {
            alert("Invalid response from Sheet.");
            addLog("Restore failed: invalid data format.");
          }
        } catch(err) {
          alert("Error processing data: " + err.message);
          addLog("Restore error: " + err.message);
        } finally {
          delete window[callbackName];
          document.head.removeChild(script);
        }
      };

      const script = document.createElement('script');
      script.src = url;
      script.onerror = () => {
        alert("Failed to load data from Google Sheet (network/CORS).");
        addLog("JSONP script load failed.");
      };
      document.head.appendChild(script);
    }

    btnRestoreSheet.addEventListener('click', restoreDataFromSheets);

    // ============================================================

    // Initialize
    loadFromStorage();
    renderRecords();
    renderLogs();
    addLog("App Loaded.");

  })();
  </script>
</body>
</html>
