<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HomeLedger v1.5.3</title>
  
  <link rel="manifest" href="/hledgerapp/manifest.json" />
  
  <link rel="icon" type="image/png" sizes="32x32" href="/hledgerapp/icons/icon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/hledgerapp/icons/icon-16x16.png">
  
  <style>
    /* ------------------------------------------------------------------- */
    /* 1. CSS Variables and Theme Setup */
    /* ------------------------------------------------------------------- */
    :root{
      /* CORE COLORS */
      --bg:#0a0d14; 
      --panel:#1f2937;
      --glass-border:#4b5563;
      --muted:#f3f4f6; 
      
      /* UTILITY COLORS */
      --accent:#60a5fa; --success:#34d399; --warning:#fbbf24; --danger:#ef4444;
      
      /* SEMANTIC VARIABLES */
      --text-color: var(--muted);
      --input-bg: var(--bg); 
      --input-border: var(--glass-border);
      --focus-outline-color: var(--accent);
      --active-filter-bg: var(--accent);

      --font:Inter,ui-sans-serif,system-ui; --gap:12px;
    }
    
    body[data-theme="light"]{
      --bg:#f9fafb; 
      --panel:#ffffff; 
      --glass-border:#e5e7eb; 
      --muted:#111827; 
      
      --accent:#2563eb; --success:#059669; --warning:#b45309; --danger:#b91c1c;
      
      --text-color: var(--muted);
      --input-bg: var(--ffffff); 
      --input-border: var(--glass-border);
      --focus-outline-color: var(--accent); 
      --active-filter-bg: var(--accent);
      
      color:var(--text-color);
    }
    
    /* ------------------------------------------------------------------- */
    /* 2. General Styles and Layout */
    /* ------------------------------------------------------------------- */
    body{background:var(--bg);color:var(--text-color);font-family:var(--font);margin:0;padding:0;display:flex;justify-content:center;padding:14px;transition:background .2s,color .2s}
    .wrap{width:100%;max-width:920px;padding:12px;display:flex;flex-direction:column;gap:var(--gap)}
    
    .topbar, .balance-card, .filter-card, .records, .modal{
        background:var(--panel);
        border:1px solid var(--glass-border);
        border-radius:6px;
        box-shadow: none;
    }

    .topbar{display:flex;justify-content:space-between;align-items:center;padding:8px 10px}
    .brand{font-weight:700}
    .controls{display:flex;gap:8px;align-items:center}
    details.menu{position:relative}
    details summary{cursor:pointer;padding:2px 6px}
    details .dropdown{position:absolute;right:0;top:28px;background:var(--panel);color:inherit;border-radius:6px;padding:6px;border:1px solid var(--glass-border)}
    details .dropdown button{display:block;width:100%;text-align:left;padding:6px;border:none;background:transparent;color:inherit;cursor:pointer}
    details .dropdown button#btn-reset {
        color: var(--danger);
        font-weight: 700;
        border-top: 1px solid var(--glass-border);
        margin-top: 4px;
        padding-top: 8px;
    }

    .balance-card{padding:12px;display:flex;justify-content:space-between;gap:12px;align-items:center}
    .balance-left .big{font-size:18px;font-weight:800;color:var(--accent)}
    .summary-item{font-size:13px}
    .actions{display:flex;flex-direction:column;gap:8px}

    /* Button Styles */
    .big-btn{width:100%;padding:10px;border-radius:6px;border:none;font-weight:700;cursor:pointer;font-size:14px}
    .big-btn.income{background:var(--success);color:#fff}
    .big-btn.loan{background:var(--warning);color:#111}
    .big-btn.expense{background:var(--danger);color:#fff}

    .filter-card{padding:10px}
    .filter-row{display:flex;flex-direction:column;gap:6px}
    
    /* Input/Select Styles & FOCUS FIX */
    input,select{
        width:100%;padding:8px;border-radius:6px;
        border:1px solid var(--input-border);
        background:var(--input-bg); 
        color:var(--text-color); 
        box-sizing: border-box; 
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus, select:focus, button:focus{
        outline: none;
        border-color: var(--focus-outline-color);
        box-shadow: 0 0 0 2px var(--focus-outline-color);
    }
    /* Disabled state style */
    select:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    /* Date Picker Fixes (Calendar Icon & Text) */
    input[type="date"]::-webkit-datetime-edit-text,
    input[type="date"]::-webkit-datetime-edit-month-field,
    input[type="date"]::-webkit-datetime-edit-day-field,
    input[type="date"]::-webkit-datetime-edit-year-field,
    input[type="date"]::-webkit-datetime-edit-literal { 
        color: var(--text-color);
    }
    input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(1) brightness(0.9);
        cursor: pointer;
    }
    body[data-theme="light"] input[type="date"]::-webkit-calendar-picker-indicator {
        filter: none;
    }
    
    /* ------------------------------------------------------------------- */
    /* 3. Quick Filter Styles (UX FIX) */
    /* ------------------------------------------------------------------- */
    .quick-filters{
      display:flex;
      flex-wrap: wrap; 
      gap:6px;
      margin-top: 2px; 
      margin-bottom: 2px; 
    }
    .quick-filters button{
      flex: 1 1 auto; 
      padding: 6px 8px;
      border: 1px solid var(--input-border);
      background: var(--input-bg); 
      color: var(--text-color);
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      box-sizing: border-box;
      transition: background 0.2s;
    }
    .quick-filters button:hover{
      background: var(--glass-border);
    }
    .quick-filters button.active {
        background: var(--active-filter-bg);
        color: var(--bg);
        border-color: var(--active-filter-bg);
        font-weight: 700;
    }

    /* ------------------------------------------------------------------- */
    /* 4. Records & Sorting Styles (FEATURE FIX) */
    /* ------------------------------------------------------------------- */
    .records{overflow:hidden}
    .records-head{display:grid;grid-template-columns:120px 110px 1fr 110px 60px;padding:8px 10px;font-weight:700;background:rgba(255,255,255,0.08);border-bottom:1px solid var(--glass-border)}
    
    .records-head > div {
        cursor: pointer;
        padding-right: 15px;
        position: relative;
    }
    .records-head > div:hover {
        opacity: 0.8;
    }
    .records-head > div[data-sort-order]::after {
        content: ' ';
        position: absolute;
        right: 0px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 10px;
    }
    .records-head > div[data-sort-order="asc"]::after {
        content: '‚ñ≤';
    }
    .records-head > div[data-sort-order="desc"]::after {
        content: '‚ñº';
    }

    .record-row{display:grid;grid-template-columns:120px 110px 1fr 110px 60px;padding:8px 10px;border-bottom:1px solid var(--glass-border);align-items:center}
    .record-actions button{background:none;border:none;color:var(--text-color);cursor:pointer;transition:color 0.1s}
    
    .empty-state {
        text-align: center;
        padding: 40px 10px;
        color: var(--glass-border);
        font-size: 14px;
    }

    footer{text-align:center;font-size:12px;opacity:0.7;margin-top:10px}
    
    /* ------------------------------------------------------------------- */
    /* 5. Modals and Delete Confirmation (UX FIX) */
    /* ------------------------------------------------------------------- */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:none;display:none;align-items:center;justify-content:center;padding:16px;z-index:60}
    .overlay.show{display:flex}
    .modal{
        width:100%;max-width:560px;
        background:var(--panel);
        border:1px solid var(--glass-border);
        border-radius:8px;
        padding:16px;
        box-shadow:0 6px 15px rgba(0,0,0,0.4);
    }
    
    .delete-modal-content {
        padding: 10px 0;
    }
    .delete-modal-content p {
        margin: 0 0 12px 0;
        font-size: 14px;
    }
    .delete-modal-content .record-details {
        background: var(--input-bg);
        border: 1px solid var(--input-border);
        padding: 8px;
        border-radius: 4px;
        margin-bottom: 15px;
        font-size: 13px;
        word-break: break-word;
    }
    
    /* Modal Button Styles */
    .modal h2{margin:0 0 8px 0;font-size:16px}
    .modal label{font-size:13px;margin-bottom:6px;display:block;color:var(--muted)}
    
    /* FIX: Input Zoom on iOS - Set font-size to 16px to prevent viewport zoom */
    .modal input[type="text"],.modal input[type="date"],.modal input[type="number"],.modal select{
        width:100%;padding:10px;border-radius:6px;
        border:1px solid var(--input-border);
        background:var(--input-bg);
        color:var(--text-color); 
        box-sizing: border-box; 
        font-size: 16px; /* <-- THE FIX */
    }
    .modal .row-2{display:block;} 
    .modal .actions-row{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
    .btn-cancel{background:transparent;border:1px solid var(--glass-border);color:var(--muted);padding:8px 12px;border-radius:6px;cursor:pointer}
    .btn-save{padding:8px 12px;border-radius:6px;border:none;font-weight:700;cursor:pointer}
    .btn-save.income{background:var(--success);color:#fff}
    .btn-save.loan{background:var(--warning);color:#111}
    .btn-save.expense{background:var(--danger);color:#fff}
    .btn-delete-confirm { background: var(--danger); color: #fff; }
    
    .log-list{max-height:400px;overflow:auto;display:flex;flex-direction:column;gap:8px;padding-top:8px}
    .log-item{font-size:13px;background:rgba(255,255,255,0.08);padding:8px;border-radius:6px}
    
    /* ------------------------------------------------------------------- */
    /* 6. Media Queries & Scrollbar Fixes (MOBILE FIX APPLIED HERE) */
    /* ------------------------------------------------------------------- */
    @media (max-width:860px){.main-grid{grid-template-columns:1fr}}
    @media (max-width:420px){
      .balance-card { flex-direction: column; align-items: stretch; }
      .balance-right { display: flex; flex-direction: column; align-items: flex-start; gap: 6px; }
      .quick-filters button { flex: 1 1 48%; }
      
      /* FIX: Records Table on Mobile - Show Date, Description, Amount, Action */
      .records-head, .record-row {
          /* Grid columns mapping to: Date(1st), Description(3rd), Amount(4th), Action(5th) */
          /* Date: 80px, Description: 1fr, Amount: 90px (Increased for clarity), Action: 50px */
          grid-template-columns: 80px 1fr 90px 50px;
      }
      
      /* 1. Hide Account (2nd item) */
      .records-head div:nth-child(2), .record-row div:nth-child(2) {
          display: none; 
      }
      
      /* 2. Ensure Description (3rd item) is fully visible and takes 1fr */
      .records-head div:nth-child(3), .record-row div:nth-child(3) {
          align-items: center; 
          word-break: break-word; 
          white-space: normal;
      }
      
      /* 3. Ensure Amount (4rd item) is visible and aligned */
      .records-head div:nth-child(4), .record-row div:nth-child(4) {
          align-items: center;
          justify-content: flex-end; /* Align amount to the right */
      }

      /* 4. Ensure Action (5th item) is visible and centered */
      .records-head div:nth-child(5), .record-row div:nth-child(5) {
          align-items: center;
          justify-content: center;
      }
      
      /* 5. Ensure Date (1st item) is visible and aligned */
      .records-head div:nth-child(1), .record-row div:nth-child(1) {
          align-items: center;
          justify-content: flex-start;
      }
    }
    
    /* THEME ICON HIGHLIGHT CSS START */
    .theme-toggle{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: 40px; 
      height: 20px;
      padding: 0;
      border-radius: 12px;
      border:1px solid var(--glass-border);
      cursor:pointer;
      background:transparent;
      position: relative;
      font-size: 14px;
      overflow: hidden; 
    }
    /* Set icon based on current theme */
    .theme-toggle::before {
      content: 'üåô'; /* Default is Dark Mode, so show Moon (switch to Sun) */
      color: var(--text-color);
      position: absolute;
      transition: transform 0.2s ease-in-out;
    }
    body[data-theme="light"] .theme-toggle::before {
      content: '‚òÄÔ∏è'; /* Light Mode, so show Sun (switch to Moon) */
      transform: translateX(0);
    }
    /* THEME ICON HIGHLIGHT CSS END */
    
    .hidden-file{display:none}
    
    .log-list::-webkit-scrollbar, body::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    .log-list::-webkit-scrollbar-track, body::-webkit-scrollbar-track {
        background: var(--bg);
    }
    .log-list::-webkit-scrollbar-thumb, body::-webkit-scrollbar-thumb {
        background: var(--glass-border);
        border-radius: 4px;
    }
    .log-list::-webkit-scrollbar-thumb:hover, body::-webkit-scrollbar-thumb:hover {
        background: var(--muted);
    }
    /* ------------------------------------------------------------------- */
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <div class="topbar">
      <div class="brand">HomeLedger</div>
      <div class="controls">
        <div class="theme-toggle" id="theme-toggle" role="button" title="Toggle theme"></div>
        <details class="menu">
          <summary>‚ãÆ</summary>
          <div class="dropdown">
            <button id="btn-log">üìú View Activity Log</button>
            <button id="btn-reset">‚ö†Ô∏è Delete All Data</button>
            <button id="btn-backup">Backup</button>
            <button id="btn-restore">Restore from Local File</button>
            <button id="btn-restore-sheet" style="font-weight:700; color:var(--accent);">‚òÅÔ∏è Restore from Sheet</button>
            <button id="btn-export">Export CSV</button>
          </div>
        </details>
      </div>
    </div>

    <div class="main-grid">
      <div class="left-col">

        <div class="balance-card" id="balance-card">
          <div class="balance-left">
            <div style="font-size:13px;color:var(--muted)">Current Balance (Total)</div>
            <div class="big" id="current-balance">Rs 0</div>
            <div class="summary-item" style="color:var(--accent)">Filtered: <span id="summary-filtered-balance">Rs 0</span></div>
          </div>
          <div class="balance-right" style="display:flex;gap:12px;align-items:center">
            <div class="summary-item"><strong>Income:</strong> <span id="sum-income" style="color:var(--success);font-weight:700">Rs 0</span></div>
            <div class="summary-item"><strong>Loan:</strong> <span id="sum-loan" style="color:var(--warning);font-weight:700">Rs 0</span></div>
            <div class="summary-item"><strong>Expense:</strong> <span id="sum-expense" style="color:var(--danger);font-weight:700">Rs 0</span></div>
          </div>
        </div>

        <div class="actions" style="margin-top:10px">
          <button class="big-btn income" data-action="income">+ Add Income</button>
          <button class="big-btn loan" data-action="loan">+ Add Loan</button>
          <button class="big-btn expense" data-action="expense">+ Add Expense</button>
        </div>

        <div class="filter-card" style="margin-top:10px">
          <strong>Filter Records</strong>
          
          <div class="filter-row">
            <input id="filter-search" type="text" placeholder="Search by description or amount">
            
            <select id="filter-account">
              <option>All Accounts</option>
              <option>Income</option>
              <option>Loan</option>
              <option>Expense</option>
            </select>

            <div class="quick-filters">
              <button id="quick-today">Today</button>
              <button id="quick-yesterday">Yesterday</button>
              <button id="quick-month">Current Month</button>
              <button id="quick-fiscal">Fiscal Year</button>
            </div>

            <div style="display:flex;gap:8px">
              <input id="filter-from" type="date">
              <input id="filter-to" type="date">
            </div>
          </div>
        </div>

        <section class="records" id="records-section" style="margin-top:10px">
          <div class="records-head">
            <div data-sort-key="date" data-sort-order="desc">Date</div>
            <div data-sort-key="account">Account</div>
            <div>Description</div>
            <div data-sort-key="amount">Amount</div>
            <div>Action</div>
          </div>
          </section>

      </div>
    </div>

    <footer>HomeLedger v1.5.3</footer> 
  </div>

  <div class="overlay" id="log-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <h2>üìú Activity Log</h2>
      <div id="activity-log-modal" class="log-list"></div>
      <div class="actions-row" style="margin-top:8px">
        <button class="btn-cancel" id="log-close">Close</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="modal-overlay" role="dialog" aria-hidden="true">
    <div class="modal" role="document" aria-modal="true">
      <h2 id="modal-title">Add New Entry</h2>
      <div>
        <label for="entry-date">Date</label>
        <input id="entry-date" type="date" required/>
      </div>
      <div style="margin-top:8px">
        <label for="entry-account">Account</label>
        <select id="entry-account">
          <option>Income</option>
          <option>Loan</option>
          <option>Expense</option>
        </select>
      </div>
      <div style="margin-top:8px">
        <label for="entry-desc">Description</label>
        <input id="entry-desc" type="text" placeholder="e.g. Salary, Fuel, Phone bill" required/>
      </div>
      <div class="row-2" style="margin-top:8px">
        <div>
          <label for="entry-amount">Amount</label>
          <input id="entry-amount" type="number" min="0.01" step="any" placeholder="0" required/>
        </div>
      </div>
      <div class="actions-row">
        <button class="btn-cancel" id="modal-cancel">Cancel</button>
        <button class="btn-save" id="modal-save">Save</button>
      </div>
    </div>
  </div>
  
  <div class="overlay" id="delete-overlay" role="dialog" aria-hidden="true">
    <div class="modal" role="document" aria-modal="true">
      <h2 style="color:var(--danger)">üóëÔ∏è Confirm Deletion</h2>
      <div class="delete-modal-content">
        <p>Are you sure you want to permanently delete the following record?</p>
        <div class="record-details" id="delete-record-details"></div>
      </div>
      <div class="actions-row">
        <button class="btn-cancel" id="delete-cancel">Cancel</button>
        <button class="btn-save btn-delete-confirm" id="delete-confirm-btn" data-id="">Delete</button>
      </div>
      </div>
  </div>

  <div class="overlay" id="reset-overlay" role="dialog" aria-hidden="true">
    <div class="modal" role="document" aria-modal="true">
      <h2 style="color:var(--danger)">‚ö†Ô∏è Confirm Full Reset</h2>
      <div class="delete-modal-content">
        <p><strong>This action cannot be undone.</strong> All your financial records, activity logs, and settings will be permanently deleted and the app will restart empty.</p>
        <p>We recommend you create a **Backup (JSON)** before proceeding.</p>
      </div>
      <div class="actions-row">
        <button class="btn-cancel" id="reset-cancel">Cancel</button>
        <button class="btn-save btn-delete-confirm" id="reset-confirm-btn">Yes, Delete All Data</button>
      </div>
    </div>
  </div>


  <input id="restore-file" class="hidden-file" type="file" accept="application/json" />

  <script>
    (function(){
      // -------------------------------------------------------------------
      // 1. DOM References and Constants
      // -------------------------------------------------------------------
      const overlay = document.getElementById('modal-overlay');
      const deleteOverlay = document.getElementById('delete-overlay');
      const deleteCancelBtn = document.getElementById('delete-cancel');
      const deleteConfirmBtn = document.getElementById('delete-confirm-btn');
      const deleteDetailsDiv = document.getElementById('delete-record-details');
      const resetOverlay = document.getElementById('reset-overlay'); 
      const resetCancelBtn = document.getElementById('reset-cancel'); 
      const resetConfirmBtn = document.getElementById('reset-confirm-btn'); 
      const title = document.getElementById('modal-title');
      const accountSelect = document.getElementById('entry-account');
      const saveBtn = document.getElementById('modal-save');
      const cancelBtn = document.getElementById('modal-cancel');
      const dateInput = document.getElementById('entry-date');
      const descInput = document.getElementById('entry-desc');
      const amtInput = document.getElementById('entry-amount');
      const recordsSection = document.getElementById('records-section');
      const recordsHead = recordsSection.querySelector('.records-head');
      const logOverlay = document.getElementById('log-overlay');
      const logClose = document.getElementById('log-close');
      const btnLog = document.getElementById('btn-log');
      const btnReset = document.getElementById('btn-reset');
      const filterSearch = document.getElementById('filter-search');
      const filterAccount = document.getElementById('filter-account');
      const filterFrom = document.getElementById('filter-from');
      const filterTo = document.getElementById('filter-to');
      const btnBackup = document.getElementById('btn-backup');
      const btnRestore = document.getElementById('btn-restore');
      const btnRestoreSheet = document.getElementById('btn-restore-sheet'); 
      const btnExport = document.getElementById('btn-export');
      const themeToggle = document.getElementById('theme-toggle'); 
      const restoreFileInput = document.getElementById('restore-file');
      
      const quickFilterButtons = {
          today: document.getElementById('quick-today'),
          yesterday: document.getElementById('quick-yesterday'),
          month: document.getElementById('quick-month'),
          fiscal: document.getElementById('quick-fiscal')
      };

      const STORAGE_KEY = 'homeledger_v1_data_v1';
      const PENDING_SYNC_KEY = 'homeledger_pending_sync_v1'; 
      const THEME_KEY = 'homeledger_theme_v1';
      const SORT_KEY = 'homeledger_sort_v1';
      const VERSION_TAG = 'HomeLedger v1.5.3'; 
      let store = { records: [], logs: [] };
      let pendingSyncQueue = []; 
      let currentSort = { key: 'date', order: 'desc' };


      // -------------------------------------------------------------------
      // 2. GOOGLE SHEETS SYNC LOGIC
      // -------------------------------------------------------------------
      // MAKE SURE TO UPDATE THIS URL AFTER DEPLOYING YOUR APPS SCRIPT
      const GOOGLE_SHEETS_WEBHOOK = 'https://script.google.com/macros/s/AKfycbzFsmbBc9RPcDUDL97TAhGXl5bSpkZO47_EMIUIznZ1PSRf4vvb0En9sRGP3pSz381X/exec'; 

      // NEW HELPER FUNCTION: Add to Queue
      function addToPendingQueue(record, recordStatus) {
          const existingIndex = pendingSyncQueue.findIndex(item => item.id === record.guid);
          
          const sheetData = {
              id: record.guid,
              date: record.date,
              description: record.desc,
              amount: record.sign === 'expense' ? -Number(record.amount) : Number(record.amount), 
              account: record.account || 'N/A',
              status: recordStatus
          };

          if (existingIndex > -1) {
              pendingSyncQueue[existingIndex] = sheetData;
          } else {
              pendingSyncQueue.push(sheetData);
          }
          saveToStorage();
          addLog(`[${nowTsForLog()}] üíæ Pending Sync: ${recordStatus} request for ${record.desc}. Added to queue.`);
      }

      // MODIFIED sendRecordToSheets
      async function sendRecordToSheets(record, recordStatus = 'Active') { 
          if (!record || record.amount === 0) return;
          
          const sheetData = {
              id: record.guid,
              date: record.date,
              description: record.desc,
              amount: record.account === 'Expense' ? -Number(record.amount) : Number(record.amount), 
              account: record.account || 'N/A',
              status: recordStatus
          };
          
          async function attemptFetch(data) {
              try {
                  await fetch(GOOGLE_SHEETS_WEBHOOK, {
                      method: 'POST',
                      mode: 'no-cors', 
                      headers: {
                          'Content-Type': 'text/plain', 
                      },
                      body: JSON.stringify(data)
                  });
                  return true; 
              } catch (error) {
                  console.error('Sheet Sync Failed (Network Error - Check Internet/URL):', error);
                  return false;
              }
          }

          const success = await attemptFetch(sheetData);

          if (success) {
              console.log('Sheets Sync: Request sent successfully.');
              const index = pendingSyncQueue.findIndex(item => item.id === record.guid);
              if(index > -1) {
                   pendingSyncQueue.splice(index, 1);
                   saveToStorage();
                   addLog(`[${nowTsForLog()}] ‚úÖ Sync Success: ${recordStatus} request for ${record.desc} completed and removed from queue.`);
              }
          } else {
              // Add to Queue if sync fails
              addToPendingQueue(record, recordStatus);
          }
      }
      // -------------------------------------------------------------------


      // -------------------------------------------------------------------
      // 3. Helper Functions 
      // -------------------------------------------------------------------
      function pad(n){ return String(n).padStart(2,'0'); }
      function nowTsForLog(){
        const d = new Date();
        return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      }
      function formatAmount(n,sign){
        return (sign==='positive'?'Rs ':'Rs ') + Number(n).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
      }
      function isoFormat(d){
          const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), dd = String(d.getDate()).padStart(2,'0');
          return `${y}-${m}-${dd}`;
      }
      function isoToday(){
        const d = new Date();
        return isoFormat(d);
      }
      function capitalize(s){ return s.charAt(0).toUpperCase() + s.slice(1); }
      
      function getFiscalYearDates(){
          const d = new Date();
          const year = d.getFullYear();
          const month = d.getMonth(); 
          let startYear, endYear;
          // Assuming Fiscal Year starts in July (month index 6)
          if (month >= 6) { startYear = year; endYear = year + 1; } 
          else { startYear = year - 1; endYear = year; }
          const fromDate = new Date(startYear, 6, 1); 
          const toDate = new Date(endYear, 5, 30);   
          return { from: isoFormat(fromDate), to: isoFormat(toDate) };
      }
      
      function seedSampleData() {
          return []; 
      }
      // -------------------------------------------------------------------
      
      // -------------------------------------------------------------------
      // 4. Persistence & Theme
      // -------------------------------------------------------------------
      function saveToStorage(){
        try{ 
            if (store.records.length > 0 || store.logs.length > 0) {
                 localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
            } else {
                 localStorage.removeItem(STORAGE_KEY);
            }
            
            if (pendingSyncQueue.length > 0) {
                localStorage.setItem(PENDING_SYNC_KEY, JSON.stringify(pendingSyncQueue));
            } else {
                localStorage.removeItem(PENDING_SYNC_KEY);
            }
            
            localStorage.setItem(SORT_KEY, JSON.stringify(currentSort));
        }catch(e){}
      }
      function loadFromStorage(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          if(raw){ 
              const parsed = JSON.parse(raw); 
              if(parsed.records) store.records = parsed.records; 
              if(parsed.logs) store.logs = parsed.logs; 
          }
          
          const rawPending = localStorage.getItem(PENDING_SYNC_KEY);
          if(rawPending) {
              pendingSyncQueue = JSON.parse(rawPending);
          }
          
          const rawSort = localStorage.getItem(SORT_KEY);
          if(rawSort) currentSort = JSON.parse(rawSort);

        }catch(e){}
      }
      
      function applyTheme(theme){
        if(theme === 'light') {
            document.body.setAttribute('data-theme','light');
            themeToggle.title = 'Switch to Dark Mode';
            themeToggle.textContent = ''; 
        }
        else {
            document.body.removeAttribute('data-theme');
            themeToggle.title = 'Switch to Light Mode';
            themeToggle.textContent = ''; 
        }
        try{ localStorage.setItem(THEME_KEY, theme); }catch(e){}
      }
      
      function toggleTheme(){
        const cur = localStorage.getItem(THEME_KEY) || 'dark';
        const next = (cur === 'dark') ? 'light' : 'dark';
        applyTheme(next);
        addLog(`[${nowTsForLog()}] Theme changed to ${next}`);
      }

      // -------------------------------------------------------------------
      // 5. Rendering, Logging, and Summary 
      // -------------------------------------------------------------------
      
      function calculateGlobalTotals(){
          let income = 0, loan = 0, expense = 0;
          store.records.forEach(r=>{
              const amount = Number(r.amount || 0);
              if(r.account === 'Income') income += amount;
              else if(r.account === 'Loan') loan += amount;
              else if(r.account === 'Expense') expense += amount;
          });
          
          const globalBalance = (income + loan) - expense;

          // --- 1. Only Update Current Balance (Total) ---
          document.getElementById('current-balance').textContent = 'Rs ' + globalBalance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
          
          applyFilters(); // Trigger filtering and rendering of all other summaries/list
          saveToStorage();
      }
      
      function recalcSummaryAndRender(dateFilteredList, fullFilteredList) {
          
          // 1. Calculate Income/Loan/Expense Summary Totals based on DATE FILTERED LIST
          let income = 0, loan = 0, expense = 0;
          dateFilteredList.forEach(r=>{
              const amount = Number(r.amount || 0);
              if(r.account === 'Income') income += amount;
              else if(r.account === 'Loan') loan += amount;
              else if(r.account === 'Expense') expense += amount;
          });
          
          // --- Update Income/Loan/Expense with DATE FILTERED amounts ---
          document.getElementById('sum-income').textContent = 'Rs ' + income.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
          document.getElementById('sum-loan').textContent = 'Rs ' + loan.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
          document.getElementById('sum-expense').textContent = 'Rs ' + expense.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

          // 2. Calculate Filtered Balance based on FULL FILTERED LIST
          let filteredIncome = 0, filteredLoan = 0, filteredExpense = 0;
          fullFilteredList.forEach(r => {
              const amount = Number(r.amount || 0);
              if (r.account === 'Income') filteredIncome += amount;
              else if (r.account === 'Loan') filteredLoan += amount;
              else if (r.account === 'Expense') filteredExpense += amount;
          });

          const filteredBalance = (filteredIncome + filteredLoan) - filteredExpense;
          // --- Update Filtered Balance ---
          document.getElementById('summary-filtered-balance').textContent = 'Rs ' + filteredBalance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

          // 3. Render the Records List
          renderRecords(fullFilteredList);
      }

      function renderRecords(list) {
          const container = recordsSection;
          // Remove old records (keep the header)
          const oldRows = container.querySelectorAll('.record-row, .empty-state');
          oldRows.forEach(row => row.remove());

          if (list.length === 0) {
              container.insertAdjacentHTML('beforeend', `<div class="empty-state">No records found matching the current filters.</div>`);
              return;
          }

          // Sort the list based on currentSort
          list.sort((a, b) => {
              const key = currentSort.key;
              const order = currentSort.order;
              let valA = a[key];
              let valB = b[key];

              if (key === 'date') {
                  // Date comparison
                  valA = new Date(a.date).getTime();
                  valB = new Date(b.date).getTime();
              } else if (key === 'amount') {
                  // Numeric comparison
                  valA = Number(a.amount);
                  valB = Number(b.amount);
              } else {
                  // String comparison
                  valA = String(valA).toLowerCase();
                  valB = String(valB).toLowerCase();
              }

              if (valA < valB) return order === 'asc' ? -1 : 1;
              if (valA > valB) return order === 'asc' ? 1 : -1;
              return 0;
          });

          // Update header sort indicators
          recordsHead.querySelectorAll('div[data-sort-key]').forEach(div => {
              const key = div.getAttribute('data-sort-key');
              div.removeAttribute('data-sort-order');
              if (key === currentSort.key) {
                  div.setAttribute('data-sort-order', currentSort.order);
              }
          });


          const rowsHtml = list.map(record => {
              const sign = record.account === 'Expense' ? 'danger' : (record.account === 'Income' ? 'success' : 'warning');
              const amountText = formatAmount(record.amount, record.account === 'Expense' ? 'negative' : 'positive');

              return `
                  <div class="record-row" data-id="${record.guid}">
                      <div>${record.date}</div>
                      <div style="color:var(--${sign})">${record.account}</div>
                      <div>${record.desc}</div>
                      <div style="color:var(--${sign}); text-align:right; font-weight:700;">${amountText}</div>
                      <div class="record-actions">
                          <button data-action="edit" title="Edit">‚úèÔ∏è</button>
                          <button data-action="delete" title="Delete">üóëÔ∏è</button>
                      </div>
                  </div>
              `;
          }).join('');

          container.insertAdjacentHTML('beforeend', rowsHtml);
      }

      function addLog(msg) {
          store.logs.push(msg);
          // Keep only the last 50 logs
          if (store.logs.length > 50) {
              store.logs = store.logs.slice(-50);
          }
          saveToStorage();
      }

      function renderLog() {
          const logContainer = document.getElementById('activity-log-modal');
          const logsHtml = store.logs.map(log => `<div class="log-item">${log}</div>`).reverse().join('');
          logContainer.innerHTML = logsHtml || '<div class="empty-state">No activity log yet.</div>';
          logOverlay.classList.add('show');
      }

      // -------------------------------------------------------------------
      // 6. Data Actions & Handlers
      // -------------------------------------------------------------------

      function saveRecord(id) {
          const date = dateInput.value;
          const account = accountSelect.value;
          const desc = descInput.value.trim();
          const amount = Number(amtInput.value);

          if (!date || !desc || amount <= 0) {
              alert('Please fill in Date, Description, and a positive Amount.');
              return;
          }

          const isUpdate = !!id;
          let record;
          let logMessage;

          if (isUpdate) {
              // Update existing record
              const index = store.records.findIndex(r => r.guid === id);
              if (index > -1) {
                  record = store.records[index];
                  record.date = date;
                  record.account = account;
                  record.desc = desc;
                  record.amount = amount.toFixed(2);
                  record.status = 'Edit'; // Mark as Edited in local store
                  logMessage = `Updated record: ${desc} (${account})`;
              }
          } else {
              // Add new record
              record = {
                  date,
                  account,
                  desc,
                  amount: amount.toFixed(2),
                  guid: crypto.randomUUID(),
                  status: 'Active'
              };
              store.records.push(record);
              logMessage = `Added new record: ${desc} (${account})`;
          }

          addLog(`[${nowTsForLog()}] ${logMessage}`);
          calculateGlobalTotals();
          closeModal(overlay);

          // Sync the record to Google Sheets
          sendRecordToSheets(record, isUpdate ? 'Edit' : 'Active');
      }

      function deleteRecord(id) {
          const index = store.records.findIndex(r => r.guid === id);
          if (index > -1) {
              const record = store.records[index];
              store.records.splice(index, 1);
              addLog(`[${nowTsForLog()}] Deleted record: ${record.desc} (${record.account})`);
              calculateGlobalTotals();
              closeModal(deleteOverlay);

              // Sync the deletion to Google Sheets
              sendRecordToSheets(record, 'Deleted');
          }
      }

      function hardReset() {
          localStorage.removeItem(STORAGE_KEY);
          localStorage.removeItem(PENDING_SYNC_KEY);
          localStorage.removeItem(THEME_KEY);
          localStorage.removeItem(SORT_KEY);
          alert('All local data deleted. The app will now reload.');
          location.reload();
      }

      function exportCSV() {
          if (store.records.length === 0) {
              alert('No data to export.');
              return;
          }
          const headers = ['Date', 'Account', 'Description', 'Amount', 'GUID', 'Status'];
          const csvRows = [];
          csvRows.push(headers.join(','));

          store.records.forEach(r => {
              const amountValue = r.account === 'Expense' ? -Number(r.amount) : Number(r.amount);
              csvRows.push([
                  r.date,
                  r.account,
                  `"${r.desc.replace(/"/g, '""')}"`, // Handle quotes in description
                  amountValue.toFixed(2),
                  r.guid,
                  r.status || 'Active'
              ].join(','));
          });

          const csvContent = csvRows.join('\n');
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.setAttribute('href', url);
          link.setAttribute('download', `HomeLedger_Export_${isoToday()}.csv`);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          addLog(`[${nowTsForLog()}] Exported ${store.records.length} records to CSV.`);
      }

      function exportJSON() {
          if (store.records.length === 0) {
              alert('No data to backup.');
              return;
          }
          const data = {
              version: VERSION_TAG,
              timestamp: nowTsForLog(),
              records: store.records,
              logs: store.logs,
              pendingSyncQueue: pendingSyncQueue
          };
          const jsonString = JSON.stringify(data, null, 2);
          const blob = new Blob([jsonString], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.setAttribute('href', url);
          link.setAttribute('download', `HomeLedger_Backup_${isoToday()}.json`);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          addLog(`[${nowTsForLog()}] Created JSON Backup.`);
      }

      function restoreFromJSON(file) {
          const reader = new FileReader();
          reader.onload = (event) => {
              try {
                  const importedData = JSON.parse(event.target.result);
                  if (!importedData.records || !Array.isArray(importedData.records)) {
                      throw new Error('Invalid backup file format.');
                  }
                  // Preserve current logs, overwrite records and pending queue
                  store.records = importedData.records;
                  if(importedData.logs) store.logs = importedData.logs;
                  if(importedData.pendingSyncQueue) pendingSyncQueue = importedData.pendingSyncQueue;

                  calculateGlobalTotals();
                  addLog(`[${nowTsForLog()}] Data restored from local JSON file. (${importedData.records.length} records)`);
                  alert(`Successfully restored ${importedData.records.length} records.`);

              } catch (e) {
                  console.error(e);
                  alert('Error processing file. Please ensure it is a valid HomeLedger JSON backup.');
              }
          };
          reader.readAsText(file);
      }

      // FINAL MODIFIED: This function now handles 'Edit' status correctly and has improved error checking.
      async function restoreFromSheet() {
          if (!confirm('Are you sure you want to replace ALL local data with data fetched from Google Sheets? (This will NOT delete local data/queue unless Sheets fetch is successful)')) {
              return;
          }

          try {
              // 1. Fetch all records from the Sheet
              const restoreURL = GOOGLE_SHEETS_WEBHOOK + '?mode=restore';
              
              const response = await fetch(restoreURL, { method: 'GET' });
              
              // CHECK 1: Ensure the response is OK (HTTP 200-299)
              if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}. Check Apps Script Deployment.`);
              }
              
              // CHECK 2: Try to read JSON. If the response is HTML/Error page, this will fail.
              const sheetRecords = await response.json(); 

              if (!sheetRecords || !Array.isArray(sheetRecords)) {
                  throw new Error("Could not fetch a valid array of records from Google Sheet.");
              }
              
              if (sheetRecords.length === 0) {
                    alert("Restore complete, but 0 records were found in the sheet data. Check your sheet data.");
                    return;
              }


              // Filter out 'Deleted' records for initial restore base
              let restoredRecords = sheetRecords.filter(r => String(r.status_normalized).toUpperCase() !== 'DELETED');
              
              // 2. Normalize and Process Records - Use Map to ensure only the LATEST version (Edit overwrites Active) is kept for each GUID
              const finalRecordsMap = new Map();
              
              restoredRecords.forEach(sheetRec => {
                  // Normalize the sheet record structure
                  const localRec = {
                      date: sheetRec.date,
                      account: sheetRec.account,
                      desc: sheetRec.description,
                      // Get the absolute value for amount, as the sign (positive/negative in Sheet) is only used for account type check.
                      amount: Math.abs(Number(sheetRec.amount)).toFixed(2), 
                      guid: sheetRec.id,
                      status: String(sheetRec.status_normalized).toUpperCase() === 'EDIT' ? 'Edit' : 'Active'
                  };

                  // Re-determine the account type based on amount sign from Sheet
                  if (localRec.account === 'N/A' || !localRec.account) {
                      localRec.account = (Number(sheetRec.amount) >= 0) ? 'Income' : 'Expense';
                  } else if (Number(sheetRec.amount) < 0 && localRec.account !== 'Expense') {
                      localRec.account = 'Expense'; // Force Expense if amount is negative
                  }
                  
                  // The latest record for a GUID will overwrite any previous entry
                  finalRecordsMap.set(localRec.guid, localRec);

              });
              
              // Convert Map values back to an array
              const mergedRecords = Array.from(finalRecordsMap.values());
              
              // 3. Final Replace and Update
              store.records = mergedRecords;
              store.logs = []; // Clear local logs on sheet restore for a clean start
              pendingSyncQueue = []; // Clear pending queue

              calculateGlobalTotals();
              addLog(`[${nowTsForLog()}] ‚òÅÔ∏è Data restored from Google Sheet. (${mergedRecords.length} records)`);
              alert(`Successfully restored ${mergedRecords.length} active records from Google Sheet.`);

          } catch (e) {
              console.error('Full Sheet Restore Failed:', e);
              // Show a detailed error in the alert
              alert(`Restore failed due to an error: ${e.message}. Please check your Google Apps Script Deployment URL and permissions (Must be 'Anyone').`);
          }
      }


      // -------------------------------------------------------------------
      // 7. Event Listeners & Initialization
      // -------------------------------------------------------------------

      function showModal(type, recordId = null) {
          overlay.classList.add('show');
          dateInput.value = isoToday();
          descInput.value = '';
          amtInput.value = '';
          saveBtn.removeAttribute('data-id');
          saveBtn.className = 'btn-save';

          // Set default action for new entry
          let accountType = type;
          let buttonText = 'Save';

          if (recordId) {
              // Edit Mode
              const record = store.records.find(r => r.guid === recordId);
              if (record) {
                  title.textContent = 'Edit Entry';
                  dateInput.value = record.date;
                  accountSelect.value = record.account;
                  descInput.value = record.desc;
                  amtInput.value = Number(record.amount).toFixed(2); // Ensure two decimals
                  saveBtn.setAttribute('data-id', recordId);
                  accountType = record.account;
                  buttonText = 'Update';
              }
          } else {
              // Add Mode
              title.textContent = `Add New ${capitalize(type)}`;
              accountSelect.value = capitalize(type);
          }

          // Apply button style and text based on account type
          const signClass = accountType.toLowerCase();
          saveBtn.classList.add(signClass);
          saveBtn.textContent = buttonText;
      }

      function showDeleteModal(recordId) {
          const record = store.records.find(r => r.guid === recordId);
          if (!record) return;

          deleteDetailsDiv.innerHTML = `
              <strong>Date:</strong> ${record.date}<br>
              <strong>Account:</strong> ${record.account}<br>
              <strong>Amount:</strong> ${formatAmount(record.amount)}<br>
              <strong>Description:</strong> ${record.desc}
          `;
          deleteConfirmBtn.setAttribute('data-id', recordId);
          deleteOverlay.classList.add('show');
      }

      function closeModal(modalElement) {
          modalElement.classList.remove('show');
      }

      function applyFilters() {
          let filteredList = store.records;

          // 1. Filter by Date Range (From/To)
          const dateFrom = filterFrom.value;
          const dateTo = filterTo.value;

          const dateFilteredList = filteredList.filter(r => {
              if (dateFrom && r.date < dateFrom) return false;
              if (dateTo && r.date > dateTo) return false;
              return true;
          });

          // 2. Filter by Account Type
          const accountFilter = filterAccount.value;
          if (accountFilter !== 'All Accounts') {
              filteredList = dateFilteredList.filter(r => r.account === accountFilter);
          } else {
              filteredList = dateFilteredList; // Start with date-filtered list
          }

          // 3. Filter by Search Text (Description/Amount)
          const searchText = filterSearch.value.toLowerCase();
          if (searchText) {
              filteredList = filteredList.filter(r =>
                  r.desc.toLowerCase().includes(searchText) ||
                  r.amount.includes(searchText)
              );
          }

          // Render the results and summary
          recalcSummaryAndRender(dateFilteredList, filteredList);
      }

      function handleQuickFilter(type) {
          // Reset date inputs first
          filterFrom.value = '';
          filterTo.value = '';

          // Deactivate all quick filter buttons
          Object.values(quickFilterButtons).forEach(btn => btn.classList.remove('active'));

          if (type) {
              const now = new Date();
              let fromDate, toDate;

              switch (type) {
                  case 'today':
                      fromDate = isoToday();
                      toDate = isoToday();
                      break;
                  case 'yesterday':
                      const y = new Date(now);
                      y.setDate(now.getDate() - 1);
                      fromDate = isoFormat(y);
                      toDate = isoFormat(y);
                      break;
                  case 'month':
                      fromDate = isoFormat(new Date(now.getFullYear(), now.getMonth(), 1));
                      toDate = isoFormat(new Date(now.getFullYear(), now.getMonth() + 1, 0));
                      break;
                  case 'fiscal':
                      const dates = getFiscalYearDates();
                      fromDate = dates.from;
                      toDate = dates.to;
                      break;
              }

              filterFrom.value = fromDate;
              filterTo.value = toDate;
              quickFilterButtons[type].classList.add('active');
          }

          applyFilters();
      }

      // --- Initialization ---

      loadFromStorage();
      
      // Initialize theme
      const storedTheme = localStorage.getItem(THEME_KEY) || 'dark';
      applyTheme(storedTheme);
      
      // Set default date to today for Add Modal
      dateInput.value = isoToday();

      // If no records, seed sample data (currently disabled, store.records is empty array)
      if (store.records.length === 0) {
          store.records = seedSampleData();
          addLog(`[${nowTsForLog()}] ${VERSION_TAG} started.`);
      } else {
          addLog(`[${nowTsForLog()}] App loaded with ${store.records.length} records.`);
      }

      // Try to sync any pending records on startup
      if(pendingSyncQueue.length > 0) {
          addLog(`[${nowTsForLog()}] Found ${pendingSyncQueue.length} pending records. Attempting to sync...`);
          const syncPromises = pendingSyncQueue.map(item => {
              const dummyRecord = {
                  guid: item.id,
                  date: item.date,
                  desc: item.description,
                  amount: Math.abs(item.amount),
                  account: item.account,
                  // Sign determination logic for pending sync is simple
                  sign: (item.amount < 0 || item.account === 'Expense') ? 'expense' : 'income' 
              };
              return sendRecordToSheets(dummyRecord, item.status);
          });
          Promise.all(syncPromises).then(() => {
             // Sync attempts finished
          }).catch(e => console.error("Error during initial pending sync:", e));
      }

      calculateGlobalTotals();


      // --- Event Handlers Setup ---

      // Open Add/Edit Modal
      document.querySelectorAll('.big-btn').forEach(button => {
          button.addEventListener('click', (e) => showModal(e.currentTarget.dataset.action));
      });

      // Save/Update Handler
      saveBtn.addEventListener('click', () => {
          const id = saveBtn.getAttribute('data-id');
          saveRecord(id);
      });

      // Cancel Modal
      cancelBtn.addEventListener('click', () => closeModal(overlay));

      // Close Log Modal
      logClose.addEventListener('click', () => closeModal(logOverlay));

      // Open Log Modal
      btnLog.addEventListener('click', renderLog);

      // Open Reset Modal
      btnReset.addEventListener('click', (e) => {
          e.preventDefault();
          resetOverlay.classList.add('show');
      });

      // Reset Modal Handlers
      resetCancelBtn.addEventListener('click', () => closeModal(resetOverlay));
      resetConfirmBtn.addEventListener('click', hardReset);

      // Delete Modal Handlers
      deleteCancelBtn.addEventListener('click', () => closeModal(deleteOverlay));
      deleteConfirmBtn.addEventListener('click', (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          deleteRecord(id);
      });


      // Record List Handlers (Edit/Delete)
      recordsSection.addEventListener('click', (e) => {
          const target = e.target;
          const row = target.closest('.record-row');
          if (!row) return;

          const recordId = row.dataset.id;
          const action = target.dataset.action;

          if (action === 'edit') {
              showModal('edit', recordId);
          } else if (action === 'delete') {
              showDeleteModal(recordId);
          }
      });

      // Filter Handlers
      filterSearch.addEventListener('input', applyFilters);
      filterAccount.addEventListener('change', applyFilters);
      filterFrom.addEventListener('change', applyFilters);
      filterTo.addEventListener('change', applyFilters);

      // Quick Filter Handlers
      Object.entries(quickFilterButtons).forEach(([key, button]) => {
          button.addEventListener('click', () => {
              // If already active, deactivate (clear filter)
              if (button.classList.contains('active')) {
                  handleQuickFilter(null);
              } else {
                  handleQuickFilter(key);
              }
          });
      });

      // Backup/Restore Handlers
      btnBackup.addEventListener('click', exportJSON);
      btnExport.addEventListener('click', exportCSV);
      btnRestore.addEventListener('click', () => restoreFileInput.click());
      restoreFileInput.addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
              restoreFromJSON(e.target.files[0]);
          }
      });
      btnRestoreSheet.addEventListener('click', restoreFromSheet); // Sheet Restore Handler

      // Theme Toggle
      themeToggle.addEventListener('click', toggleTheme);
      
      // Sorting Handler
      recordsHead.addEventListener('click', (e) => {
          const sortDiv = e.target.closest('div[data-sort-key]');
          if (!sortDiv) return;

          const key = sortDiv.getAttribute('data-sort-key');
          const currentOrder = currentSort.key === key ? currentSort.order : 'desc'; // Default to desc if new key

          // Toggle order
          const newOrder = currentOrder === 'desc' ? 'asc' : 'desc';

          currentSort = { key, order: newOrder };
          applyFilters(); // Re-render with new sort order
      });


      // Global keydown handler for ESC key to close modals
      document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
              if (overlay.classList.contains('show')) closeModal(overlay);
              else if (deleteOverlay.classList.contains('show')) closeModal(deleteOverlay);
              else if (logOverlay.classList.contains('show')) closeModal(logOverlay);
              else if (resetOverlay.classList.contains('show')) closeModal(resetOverlay);
          }
      });

    })();
  </script>
</body>
</html>
