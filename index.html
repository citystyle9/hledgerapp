<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title>HomeLedger v1.5.2</title>Â 
Â Â 
Â  <link rel="manifest" href="/hledgerapp/manifest.json" />Â 
Â Â 
Â  <link rel="icon" type="image/png" sizes="32x32" href="/hledgerapp/icons/icon-32x32.png">
Â  <link rel="icon" type="image/png" sizes="16x16" href="/hledgerapp/icons/icon-16x16.png">
Â Â 
Â  <style>
Â  Â  /* ------------------------------------------------------------------- */
Â  Â  /* 1. CSS Variables and Theme Setup */
Â  Â  /* ------------------------------------------------------------------- */
Â  Â  :root{
Â  Â  Â  /* CORE COLORS */
Â  Â  Â  --bg:#0a0d14;Â 
Â  Â  Â  --panel:#1f2937;
Â  Â  Â  --glass-border:#4b5563;
Â  Â  Â  --muted:#f3f4f6;Â 
Â  Â  Â Â 
Â  Â  Â  /* UTILITY COLORS */
Â  Â  Â  --accent:#60a5fa; --success:#34d399; --warning:#fbbf24; --danger:#ef4444;
Â  Â  Â Â 
Â  Â  Â  /* SEMANTIC VARIABLES */
Â  Â  Â  --text-color: var(--muted);
Â  Â  Â  --input-bg: var(--bg);Â 
Â  Â  Â  --input-border: var(--glass-border);
Â  Â  Â  --focus-outline-color: var(--accent);
Â  Â  Â  --active-filter-bg: var(--accent);

Â  Â  Â  --font:Inter,ui-sans-serif,system-ui; --gap:12px;
Â  Â  }
Â  Â Â 
Â  Â  body[data-theme="light"]{
Â  Â  Â  --bg:#f9fafb;Â 
Â  Â  Â  --panel:#ffffff;Â 
Â  Â  Â  --glass-border:#e5e7eb;Â 
Â  Â  Â  --muted:#111827;Â 
Â  Â  Â Â 
Â  Â  Â  --accent:#2563eb; --success:#059669; --warning:#b45309; --danger:#b91c1c;
Â  Â  Â Â 
Â  Â  Â  --text-color: var(--muted);
Â  Â  Â  --input-bg: var(--ffffff);Â 
Â  Â  Â  --input-border: var(--glass-border);
Â  Â  Â  --focus-outline-color: var(--accent);Â 
Â  Â  Â  --active-filter-bg: var(--accent);
Â  Â  Â Â 
Â  Â  Â  color:var(--text-color);
Â  Â  }
Â  Â Â 
Â  Â  /* ------------------------------------------------------------------- */
Â  Â  /* 2. General Styles and Layout */
Â  Â  /* ------------------------------------------------------------------- */
Â  Â  body{background:var(--bg);color:var(--text-color);font-family:var(--font);margin:0;padding:0;display:flex;justify-content:center;padding:14px;transition:background .2s,color .2s}
Â  Â  .wrap{width:100%;max-width:920px;padding:12px;display:flex;flex-direction:column;gap:var(--gap)}
Â  Â Â 
Â  Â  .topbar, .balance-card, .filter-card, .records, .modal{
Â  Â  Â  Â  background:var(--panel);
Â  Â  Â  Â  border:1px solid var(--glass-border);
Â  Â  Â  Â  border-radius:6px;
Â  Â  Â  Â  box-shadow: none;
Â  Â  }

Â  Â  .topbar{display:flex;justify-content:space-between;align-items:center;padding:8px 10px}
Â  Â  .brand{font-weight:700}
Â  Â  .controls{display:flex;gap:8px;align-items:center}
Â  Â  details.menu{position:relative}
Â  Â  details summary{cursor:pointer;padding:2px 6px}
Â  Â  details .dropdown{position:absolute;right:0;top:28px;background:var(--panel);color:inherit;border-radius:6px;padding:6px;border:1px solid var(--glass-border)}
Â  Â  details .dropdown button{display:block;width:100%;text-align:left;padding:6px;border:none;background:transparent;color:inherit;cursor:pointer}
Â  Â  details .dropdown button#btn-reset {
Â  Â  Â  Â  color: var(--danger);
Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  border-top: 1px solid var(--glass-border);
Â  Â  Â  Â  margin-top: 4px;
Â  Â  Â  Â  padding-top: 8px;
Â  Â  }

Â  Â  .balance-card{padding:12px;display:flex;justify-content:space-between;gap:12px;align-items:center}
Â  Â  .balance-left .big{font-size:18px;font-weight:800;color:var(--accent)}
Â  Â  .summary-item{font-size:13px}
Â  Â  .actions{display:flex;flex-direction:column;gap:8px}

Â  Â  /* Button Styles */
Â  Â  .big-btn{width:100%;padding:10px;border-radius:6px;border:none;font-weight:700;cursor:pointer;font-size:14px}
Â  Â  .big-btn.income{background:var(--success);color:#fff}
Â  Â  .big-btn.loan{background:var(--warning);color:#111}
Â  Â  .big-btn.expense{background:var(--danger);color:#fff}

Â  Â  .filter-card{padding:10px}
Â  Â  .filter-row{display:flex;flex-direction:column;gap:6px}
Â  Â Â 
Â  Â  /* Input/Select Styles & FOCUS FIX */
Â  Â  input,select{
Â  Â  Â  Â  width:100%;padding:8px;border-radius:6px;
Â  Â  Â  Â  border:1px solid var(--input-border);
Â  Â  Â  Â  background:var(--input-bg);Â 
Â  Â  Â  Â  color:var(--text-color);Â 
Â  Â  Â  Â  box-sizing: border-box;Â 
Â  Â  Â  Â  transition: border-color 0.2s, box-shadow 0.2s;
Â  Â  }
Â  Â  input:focus, select:focus, button:focus{
Â  Â  Â  Â  outline: none;
Â  Â  Â  Â  border-color: var(--focus-outline-color);
Â  Â  Â  Â  box-shadow: 0 0 0 2px var(--focus-outline-color);
Â  Â  }
Â  Â  /* Disabled state style */
Â  Â  select:disabled {
Â  Â  Â  Â  opacity: 0.7;
Â  Â  Â  Â  cursor: not-allowed;
Â  Â  }

Â  Â  /* Date Picker Fixes (Calendar Icon & Text) */
Â  Â  input[type="date"]::-webkit-datetime-edit-text,
Â  Â  input[type="date"]::-webkit-datetime-edit-month-field,
Â  Â  input[type="date"]::-webkit-datetime-edit-day-field,
Â  Â  input[type="date"]::-webkit-datetime-edit-year-field,
Â  Â  input[type="date"]::-webkit-datetime-edit-literal {Â 
Â  Â  Â  Â  color: var(--text-color);
Â  Â  }
Â  Â  input[type="date"]::-webkit-calendar-picker-indicator {
Â  Â  Â  Â  filter: invert(1) brightness(0.9);
Â  Â  Â  Â  cursor: pointer;
Â  Â  }
Â  Â  body[data-theme="light"] input[type="date"]::-webkit-calendar-picker-indicator {
Â  Â  Â  Â  filter: none;
Â  Â  }
Â  Â Â 
Â  Â  /* ------------------------------------------------------------------- */
Â  Â  /* 3. Quick Filter Styles (UX FIX) */
Â  Â  /* ------------------------------------------------------------------- */
Â  Â  .quick-filters{
Â  Â  Â  display:flex;
Â  Â  Â  flex-wrap: wrap;Â 
Â  Â  Â  gap:6px;
Â  Â  Â  margin-top: 2px;Â 
Â  Â  Â  margin-bottom: 2px;Â 
Â  Â  }
Â  Â  .quick-filters button{
Â  Â  Â  flex: 1 1 auto;Â 
Â  Â  Â  padding: 6px 8px;
Â  Â  Â  border: 1px solid var(--input-border);
Â  Â  Â  background: var(--input-bg);Â 
Â  Â  Â  color: var(--text-color);
Â  Â  Â  border-radius: 4px;
Â  Â  Â  font-size: 12px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  box-sizing: border-box;
Â  Â  Â  transition: background 0.2s;
Â  Â  }
Â  Â  .quick-filters button:hover{
Â  Â  Â  background: var(--glass-border);
Â  Â  }
Â  Â  .quick-filters button.active {
Â  Â  Â  Â  background: var(--active-filter-bg);
Â  Â  Â  Â  color: var(--bg);
Â  Â  Â  Â  border-color: var(--active-filter-bg);
Â  Â  Â  Â  font-weight: 700;
Â  Â  }

Â  Â  /* ------------------------------------------------------------------- */
Â  Â  /* 4. Records & Sorting Styles (FEATURE FIX) */
Â  Â  /* ------------------------------------------------------------------- */
Â  Â  .records{overflow:hidden}
Â  Â  .records-head{display:grid;grid-template-columns:120px 110px 1fr 110px 60px;padding:8px 10px;font-weight:700;background:rgba(255,255,255,0.08);border-bottom:1px solid var(--glass-border)}
Â  Â Â 
Â  Â  .records-head > div {
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  padding-right: 15px;
Â  Â  Â  Â  position: relative;
Â  Â  }
Â  Â  .records-head > div:hover {
Â  Â  Â  Â  opacity: 0.8;
Â  Â  }
Â  Â  .records-head > div[data-sort-order]::after {
Â  Â  Â  Â  content: ' ';
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  right: 0px;
Â  Â  Â  Â  top: 50%;
Â  Â  Â  Â  transform: translateY(-50%);
Â  Â  Â  Â  font-size: 10px;
Â  Â  }
Â  Â  .records-head > div[data-sort-order="asc"]::after {
Â  Â  Â  Â  content: 'â–²';
Â  Â  }
Â  Â  .records-head > div[data-sort-order="desc"]::after {
Â  Â  Â  Â  content: 'â–¼';
Â  Â  }

Â  Â  .record-row{display:grid;grid-template-columns:120px 110px 1fr 110px 60px;padding:8px 10px;border-bottom:1px solid var(--glass-border);align-items:center}
Â  Â  .record-actions button{background:none;border:none;color:var(--text-color);cursor:pointer;transition:color 0.1s}
Â  Â Â 
Â  Â  .empty-state {
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  padding: 40px 10px;
Â  Â  Â  Â  color: var(--glass-border);
Â  Â  Â  Â  font-size: 14px;
Â  Â  }

Â  Â  footer{text-align:center;font-size:12px;opacity:0.7;margin-top:10px}
Â  Â Â 
Â  Â  /* ------------------------------------------------------------------- */
Â  Â  /* 5. Modals and Delete Confirmation (UX FIX) */
Â  Â  /* ------------------------------------------------------------------- */
Â  Â  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:none;display:none;align-items:center;justify-content:center;padding:16px;z-index:60}
Â  Â  .overlay.show{display:flex}
Â  Â  .modal{
Â  Â  Â  Â  width:100%;max-width:560px;
Â  Â  Â  Â  background:var(--panel);
Â  Â  Â  Â  border:1px solid var(--glass-border);
Â  Â  Â  Â  border-radius:8px;
Â  Â  Â  Â  padding:16px;
Â  Â  Â  Â  box-shadow:0 6px 15px rgba(0,0,0,0.4);
Â  Â  }
Â  Â Â 
Â  Â  .delete-modal-content {
Â  Â  Â  Â  padding: 10px 0;
Â  Â  }
Â  Â  .delete-modal-content p {
Â  Â  Â  Â  margin: 0 0 12px 0;
Â  Â  Â  Â  font-size: 14px;
Â  Â  }
Â  Â  .delete-modal-content .record-details {
Â  Â  Â  Â  background: var(--input-bg);
Â  Â  Â  Â  border: 1px solid var(--input-border);
Â  Â  Â  Â  padding: 8px;
Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  font-size: 13px;
Â  Â  Â  Â  word-break: break-word;
Â  Â  }
Â  Â Â 
Â  Â  /* Modal Button Styles */
Â  Â  .modal h2{margin:0 0 8px 0;font-size:16px}
Â  Â  .modal label{font-size:13px;margin-bottom:6px;display:block;color:var(--muted)}
Â  Â Â 
Â  Â  /* FIX: Input Zoom on iOS - Set font-size to 16px to prevent viewport zoom */
Â  Â  .modal input[type="text"],.modal input[type="date"],.modal input[type="number"],.modal select{
Â  Â  Â  Â  width:100%;padding:10px;border-radius:6px;
Â  Â  Â  Â  border:1px solid var(--input-border);
Â  Â  Â  Â  background:var(--input-bg);
Â  Â  Â  Â  color:var(--text-color);Â 
Â  Â  Â  Â  box-sizing: border-box;Â 
Â  Â  Â  Â  font-size: 16px; /* <-- THE FIX */
Â  Â  }
Â  Â  .modal .row-2{display:block;}Â 
Â  Â  .modal .actions-row{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
Â  Â  .btn-cancel{background:transparent;border:1px solid var(--glass-border);color:var(--muted);padding:8px 12px;border-radius:6px;cursor:pointer}
Â  Â  .btn-save{padding:8px 12px;border-radius:6px;border:none;font-weight:700;cursor:pointer}
Â  Â  .btn-save.income{background:var(--success);color:#fff}
Â  Â  .btn-save.loan{background:var(--warning);color:#111}
Â  Â  .btn-save.expense{background:var(--danger);color:#fff}
Â  Â  .btn-delete-confirm { background: var(--danger); color: #fff; }
Â  Â Â 
Â  Â  .log-list{max-height:400px;overflow:auto;display:flex;flex-direction:column;gap:8px;padding-top:8px}
Â  Â  .log-item{font-size:13px;background:rgba(255,255,255,0.08);padding:8px;border-radius:6px}
Â  Â Â 
Â  Â  /* ------------------------------------------------------------------- */
Â  Â  /* 6. Media Queries & Scrollbar Fixes (MOBILE FIX APPLIED HERE) */
Â  Â  /* ------------------------------------------------------------------- */
Â  Â  @media (max-width:860px){.main-grid{grid-template-columns:1fr}}
Â  Â  @media (max-width:420px){
Â  Â  Â  .balance-card { flex-direction: column; align-items: stretch; }
Â  Â  Â  .balance-right { display: flex; flex-direction: column; align-items: flex-start; gap: 6px; }
Â  Â  Â  .quick-filters button { flex: 1 1 48%; }
Â  Â  Â Â 
Â  Â  Â  /* FIX: Records Table on Mobile - Show Date, Description, Amount, Action */
Â  Â  Â  .records-head, .record-row {
Â  Â  Â  Â  Â  /* Grid columns mapping to: Date(1st), Description(3rd), Amount(4th), Action(5th) */
Â  Â  Â  Â  Â  /* Date: 80px, Description: 1fr, Amount: 90px (Increased for clarity), Action: 50px */
Â  Â  Â  Â  Â  grid-template-columns: 80px 1fr 90px 50px;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  /* 1. Hide Account (2nd item) */
Â  Â  Â  .records-head div:nth-child(2), .record-row div:nth-child(2) {
Â  Â  Â  Â  Â  display: none !important; /* Force hide account column */
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  /* 2. Ensure Description (3rd item) is fully visible and takes 1fr */
Â  Â  Â  /* Since 2nd is hidden, 3rd will take the second column spot (1fr) */
Â  Â  Â  .records-head div:nth-child(3), .record-row div:nth-child(3) {
Â  Â  Â  Â  Â  /* Added !important to ensure display:block from parent style is overridden */
Â  Â  Â  Â  Â  display: flex !important;Â 
Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  word-break: break-word;Â 
Â  Â  Â  Â  Â  white-space: normal; /* Allow text to wrap */
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  /* 3. Ensure Amount (4th item) is visible and aligned */
Â  Â  Â  .records-head div:nth-child(4), .record-row div:nth-child(4) {
Â  Â  Â  Â  Â  display: flex !important;
Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  justify-content: flex-end; /* Align amount to the right */
Â  Â  Â  }

Â  Â  Â  /* 4. Ensure Action (5th item) is visible and centered */
Â  Â  Â  .records-head div:nth-child(5), .record-row div:nth-child(5) {
Â  Â  Â  Â  Â  display: flex !important;Â 
Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  /* 5. Ensure Date (1st item) is visible and aligned */
Â  Â  Â  .records-head div:nth-child(1), .record-row div:nth-child(1) {
Â  Â  Â  Â  Â  display: flex !important;Â 
Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  justify-content: flex-start;
Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  /* THEME ICON HIGHLIGHT CSS START */
Â  Â  .theme-toggle{
Â  Â  Â  display:inline-flex;
Â  Â  Â  align-items:center;
Â  Â  Â  justify-content:center;
Â  Â  Â  width: 40px;Â 
Â  Â  Â  height: 20px;
Â  Â  Â  padding: 0;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  border:1px solid var(--glass-border);
Â  Â  Â  cursor:pointer;
Â  Â  Â  background:transparent;
Â  Â  Â  position: relative;
Â  Â  Â  font-size: 14px;
Â  Â  Â  overflow: hidden;Â 
Â  Â  }
Â  Â  /* Set icon based on current theme */
Â  Â  .theme-toggle::before {
Â  Â  Â  Â  content: 'ğŸŒ™'; /* Default is Dark Mode, so show Moon (switch to Sun) */
Â  Â  Â  Â  color: var(--text-color);
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  transition: transform 0.2s ease-in-out;
Â  Â  }
Â  Â  body[data-theme="light"] .theme-toggle::before {
Â  Â  Â  Â  content: 'â˜€ï¸'; /* Light Mode, so show Sun (switch to Moon) */
Â  Â  Â  Â  transform: translateX(0);
Â  Â  }
Â  Â  /* THEME ICON HIGHLIGHT CSS END */
Â  Â Â 
Â  Â  .hidden-file{display:none}
Â  Â Â 
Â  Â  .log-list::-webkit-scrollbar, body::-webkit-scrollbar {
Â  Â  Â  Â  width: 8px;
Â  Â  Â  Â  height: 8px;
Â  Â  }
Â  Â  .log-list::-webkit-scrollbar-track, body::-webkit-scrollbar-track {
Â  Â  Â  Â  background: var(--bg);
Â  Â  }
Â  Â  .log-list::-webkit-scrollbar-thumb, body::-webkit-scrollbar-thumb {
Â  Â  Â  Â  background: var(--glass-border);
Â  Â  Â  Â  border-radius: 4px;
Â  Â  }
Â  Â  .log-list::-webkit-scrollbar-thumb:hover, body::-webkit-scrollbar-thumb:hover {
Â  Â  Â  Â  background: var(--muted);
Â  Â  }
Â  Â  /* ------------------------------------------------------------------- */
Â  </style>
</head>
<body>
Â  <div class="wrap" id="app">
Â  Â  <div class="topbar">
Â  Â  Â  <div class="brand">HomeLedger</div>
Â  Â  Â  <div class="controls">
Â  Â  Â  Â  <div class="theme-toggle" id="theme-toggle" role="button" title="Toggle theme"></div>
Â  Â  Â  Â  <details class="menu">
Â  Â  Â  Â  Â  <summary>â‹®</summary>
Â  Â  Â  Â  Â  <div class="dropdown">
Â  Â  Â  Â  Â  Â  <button id="btn-log">ğŸ“œ View Activity Log</button>
Â  Â  Â  Â  Â  Â  <button id="btn-reset">âš ï¸ Delete All Data</button>
Â  Â  Â  Â  Â  Â  <button id="btn-backup">Backup</button>
Â  Â  Â  Â  Â  Â  <button id="btn-restore">Restore</button>
Â  Â  Â  Â  Â  Â  <button id="btn-export">Export CSV</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </details>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="main-grid">
Â  Â  Â  <div class="left-col">

Â  Â  Â  Â  <div class="balance-card" id="balance-card">
Â  Â  Â  Â  Â  <div class="balance-left">
Â  Â  Â  Â  Â  Â  <div style="font-size:13px;color:var(--muted)">Current Balance (Total)</div>
Â  Â  Â  Â  Â  Â  <div class="big" id="current-balance">Rs 0</div>
Â  Â  Â  Â  Â  Â  <div class="summary-item" style="color:var(--accent)">Filtered: <span id="summary-filtered-balance">Rs 0</span></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="balance-right" style="display:flex;gap:12px;align-items:center">
Â  Â  Â  Â  Â  Â  <div class="summary-item"><strong>Income:</strong> <span id="sum-income" style="color:var(--success);font-weight:700">Rs 0</span></div>
Â  Â  Â  Â  Â  Â  <div class="summary-item"><strong>Loan:</strong> <span id="sum-loan" style="color:var(--warning);font-weight:700">Rs 0</span></div>
Â  Â  Â  Â  Â  Â  <div class="summary-item"><strong>Expense:</strong> <span id="sum-expense" style="color:var(--danger);font-weight:700">Rs 0</span></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="actions" style="margin-top:10px">
Â  Â  Â  Â  Â  <button class="big-btn income" data-action="income">+ Add Income</button>
Â  Â  Â  Â  Â  <button class="big-btn loan" data-action="loan">+ Add Loan</button>
Â  Â  Â  Â  Â  <button class="big-btn expense" data-action="expense">+ Add Expense</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="filter-card" style="margin-top:10px">
Â  Â  Â  Â  Â  <strong>Filter Records</strong>
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  <div class="filter-row">
Â  Â  Â  Â  Â  Â  <input id="filter-search" type="text" placeholder="Search by description or amount">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <select id="filter-account">
Â  Â  Â  Â  Â  Â  Â  <option>All Accounts</option>
Â  Â  Â  Â  Â  Â  Â  <option>Income</option>
Â  Â  Â  Â  Â  Â  Â  <option>Loan</option>
Â  Â  Â  Â  Â  Â  Â  <option>Expense</option>
Â  Â  Â  Â  Â  Â  </select>

Â  Â  Â  Â  Â  Â  <div class="quick-filters">
Â  Â  Â  Â  Â  Â  Â  <button id="quick-today">Today</button>
Â  Â  Â  Â  Â  Â  Â  <button id="quick-yesterday">Yesterday</button>
Â  Â  Â  Â  Â  Â  Â  <button id="quick-month">Current Month</button>
Â  Â  Â  Â  Â  Â  Â  <button id="quick-fiscal">Fiscal Year</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div style="display:flex;gap:8px">
Â  Â  Â  Â  Â  Â  Â  <input id="filter-from" type="date">
Â  Â  Â  Â  Â  Â  Â  <input id="filter-to" type="date">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <section class="records" id="records-section" style="margin-top:10px">
Â  Â  Â  Â  Â  <div class="records-head">
Â  Â  Â  Â  Â  Â  <div data-sort-key="date" data-sort-order="desc">Date</div>
Â  Â  Â  Â  Â  Â  <div data-sort-key="account">Account</div>
Â  Â  Â  Â  Â  Â  <div>Description</div>
Â  Â  Â  Â  Â  Â  <div data-sort-key="amount">Amount</div>
Â  Â  Â  Â  Â  Â  <div>Action</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </section>

Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <footer>HomeLedger v1.5.2</footer>Â 
Â  </div>

Â  <div class="overlay" id="log-overlay" aria-hidden="true">
Â  Â  <div class="modal" role="dialog" aria-modal="true">
Â  Â  Â  <h2>ğŸ“œ Activity Log</h2>
Â  Â  Â  <div id="activity-log-modal" class="log-list"></div>
Â  Â  Â  <div class="actions-row" style="margin-top:8px">
Â  Â  Â  Â  <button class="btn-cancel" id="log-close">Close</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div class="overlay" id="modal-overlay" role="dialog" aria-hidden="true">
Â  Â  <div class="modal" role="document" aria-modal="true">
Â  Â  Â  <h2 id="modal-title">Add New Entry</h2>
Â  Â  Â  <div>
Â  Â  Â  Â  <label for="entry-date">Date</label>
Â  Â  Â  Â  <input id="entry-date" type="date" required/>
Â  Â  Â  </div>
Â  Â  Â  <div style="margin-top:8px">
Â  Â  Â  Â  <label for="entry-account">Account</label>
Â  Â  Â  Â  <select id="entry-account">
Â  Â  Â  Â  Â  <option>Income</option>
Â  Â  Â  Â  Â  <option>Loan</option>
Â  Â  Â  Â  Â  <option>Expense</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>
Â  Â  Â  <div style="margin-top:8px">
Â  Â  Â  Â  <label for="entry-desc">Description</label>
Â  Â  Â  Â  <input id="entry-desc" type="text" placeholder="e.g. Salary, Fuel, Phone bill" required/>
Â  Â  Â  </div>
Â  Â  Â  <div class="row-2" style="margin-top:8px">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <label for="entry-amount">Amount</label>
Â  Â  Â  Â  Â  <input id="entry-amount" type="number" min="0.01" step="any" placeholder="0" required/>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="actions-row">
Â  Â  Â  Â  <button class="btn-cancel" id="modal-cancel">Cancel</button>
Â  Â  Â  Â  <button class="btn-save" id="modal-save">Save</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
Â Â 
Â  <div class="overlay" id="delete-overlay" role="dialog" aria-hidden="true">
Â  Â  <div class="modal" role="document" aria-modal="true">
Â  Â  Â  <h2 style="color:var(--danger)">ğŸ—‘ï¸ Confirm Deletion</h2>
Â  Â  Â  <div class="delete-modal-content">
Â  Â  Â  Â  <p>Are you sure you want to permanently delete the following record?</p>
Â  Â  Â  Â  <div class="record-details" id="delete-record-details"></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="actions-row">
Â  Â  Â  Â  <button class="btn-cancel" id="delete-cancel">Cancel</button>
Â  Â  Â  Â  <button class="btn-save btn-delete-confirm" id="delete-confirm-btn" data-id="">Delete</button>
Â  Â  Â  </div>
Â  Â  Â  </div>
Â  </div>

Â  <div class="overlay" id="reset-overlay" role="dialog" aria-hidden="true">
Â  Â  <div class="modal" role="document" aria-modal="true">
Â  Â  Â  <h2 style="color:var(--danger)">âš ï¸ Confirm Full Reset</h2>
Â  Â  Â  <div class="delete-modal-content">
Â  Â  Â  Â  <p><strong>This action cannot be undone.</strong> All your financial records, activity logs, and settings will be permanently deleted and the app will restart empty.</p>
Â  Â  Â  Â  <p>We recommend you create a **Backup (JSON)** before proceeding.</p>
Â  Â  Â  </div>
Â  Â  Â  <div class="actions-row">
Â  Â  Â  Â  <button class="btn-cancel" id="reset-cancel">Cancel</button>
Â  Â  Â  Â  <button class="btn-save btn-delete-confirm" id="reset-confirm-btn">Yes, Delete All Data</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>


Â  <input id="restore-file" class="hidden-file" type="file" accept="application/json" />

Â  <script>
Â  Â  (function(){
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  // 1. DOM References and Constants
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  const overlay = document.getElementById('modal-overlay');
Â  Â  Â  const deleteOverlay = document.getElementById('delete-overlay');
Â  Â  Â  const deleteCancelBtn = document.getElementById('delete-cancel');
Â  Â  Â  const deleteConfirmBtn = document.getElementById('delete-confirm-btn');
Â  Â  Â  const deleteDetailsDiv = document.getElementById('delete-record-details');
Â  Â  Â  const resetOverlay = document.getElementById('reset-overlay');Â 
Â  Â  Â  const resetCancelBtn = document.getElementById('reset-cancel');Â 
Â  Â  Â  const resetConfirmBtn = document.getElementById('reset-confirm-btn');Â 
Â  Â  Â  const title = document.getElementById('modal-title');
Â  Â  Â  const accountSelect = document.getElementById('entry-account');
Â  Â  Â  const saveBtn = document.getElementById('modal-save');
Â  Â  Â  const cancelBtn = document.getElementById('modal-cancel');
Â  Â  Â  const dateInput = document.getElementById('entry-date');
Â  Â  Â  const descInput = document.getElementById('entry-desc');
Â  Â  Â  const amtInput = document.getElementById('entry-amount');
Â  Â  Â  const recordsSection = document.getElementById('records-section');
Â  Â  Â  const recordsHead = recordsSection.querySelector('.records-head');
Â  Â  Â  const logOverlay = document.getElementById('log-overlay');
Â  Â  Â  const logClose = document.getElementById('log-close');
Â  Â  Â  const btnLog = document.getElementById('btn-log');
Â  Â  Â  const btnReset = document.getElementById('btn-reset');
Â  Â  Â  const filterSearch = document.getElementById('filter-search');
Â  Â  Â  const filterAccount = document.getElementById('filter-account');
Â  Â  Â  const filterFrom = document.getElementById('filter-from');
Â  Â  Â  const filterTo = document.getElementById('filter-to');
Â  Â  Â  const btnBackup = document.getElementById('btn-backup');
Â  Â  Â  const btnRestore = document.getElementById('btn-restore');
Â  Â  Â  const btnExport = document.getElementById('btn-export');
Â  Â  Â  const themeToggle = document.getElementById('theme-toggle');Â 
Â  Â  Â  const restoreFileInput = document.getElementById('restore-file');
Â  Â  Â Â 
Â  Â  Â  const quickFilterButtons = {
Â  Â  Â  Â  Â  today: document.getElementById('quick-today'),
Â  Â  Â  Â  Â  yesterday: document.getElementById('quick-yesterday'),
Â  Â  Â  Â  Â  month: document.getElementById('quick-month'),
Â  Â  Â  Â  Â  fiscal: document.getElementById('quick-fiscal')
Â  Â  Â  };

Â  Â  Â  const STORAGE_KEY = 'homeledger_v1_data_v1';
Â  Â  Â  const THEME_KEY = 'homeledger_theme_v1';
Â  Â  Â  const SORT_KEY = 'homeledger_sort_v1';
Â  Â  Â  const VERSION_TAG = 'HomeLedger v1.5.2';Â 
Â  Â  Â  let store = { records: [], logs: [] };
Â  Â  Â  let currentSort = { key: 'date', order: 'desc' };


      // -------------------------------------------------------------------
      // 2. GOOGLE SHEETS SYNC LOGIC (New Section)
      // -------------------------------------------------------------------
      // 1. Webhook URL: (Your successfully deployed Apps Script URL)
      const GOOGLE_SHEETS_WEBHOOK = 'https://script.google.com/macros/s/AKfycbzFsmbBc9RPcDUDL97TAhGXl5bSpkZO47_EMIUIznZ1PSRf4vvb0En9sRGP3pSz381X/exec'; 

      // 2. Central Sync Function: Sends data to Google Sheets
      async function sendRecordToSheets(record, recordStatus = 'Active') { 
          if (!record || record.amount === 0) return;

          // Prepare the data to be sent (7 fields)
          const sheetData = {
              id: record.guid,
              date: record.date,
              description: record.desc, // Use 'desc' property from your existing record structure
              amount: record.sign === 'expense' ? -Number(record.amount) : Number(record.amount), // Ensure amount has +/- sign for sheets
              account: record.account || 'N/A',
              status: recordStatus // 'Active' or 'Deleted'
          };
          
          // FIX: Your original code structure uses .desc and .amount,
          // so we ensure correct conversion for 'amount' sign based on 'sign' property.

          try {
              const response = await fetch(GOOGLE_SHEETS_WEBHOOK, {
                  method: 'POST',
                  mode: 'cors', 
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(sheetData)
              });

              const result = await response.json();
              console.log('Sheets Sync Status:', result.message); 

          } catch (error) {
              console.error('Sheet Sync Failed (Check Internet/URL):', error);
          }
      }
      // -------------------------------------------------------------------


Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  // 3. Helper Functions (Renumbered)
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  function pad(n){ return String(n).padStart(2,'0'); }
Â  Â  Â  function nowTsForLog(){
Â  Â  Â  Â  const d = new Date();
Â  Â  Â  Â  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
Â  Â  Â  }
Â  Â  Â  function formatAmount(n,sign){
Â  Â  Â  Â  return (sign==='positive'?'+ ':'- ') + 'Rs ' + Number(n).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
Â  Â  Â  }
Â  Â  Â  function isoFormat(d){
Â  Â  Â  Â  Â  const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), dd = String(d.getDate()).padStart(2,'0');
Â  Â  Â  Â  Â  return `${y}-${m}-${dd}`;
Â  Â  Â  }
Â  Â  Â  function isoToday(){
Â  Â  Â  Â  const d = new Date();
Â  Â  Â  Â  return isoFormat(d);
Â  Â  Â  }
Â  Â  Â  function capitalize(s){ return s.charAt(0).toUpperCase() + s.slice(1); }
Â  Â  Â Â 
Â  Â  Â  function getFiscalYearDates(){
Â  Â  Â  Â  Â  const d = new Date();
Â  Â  Â  Â  Â  const year = d.getFullYear();
Â  Â  Â  Â  Â  const month = d.getMonth();Â 
Â  Â  Â  Â  Â  let startYear, endYear;
Â  Â  Â  Â  Â  if (month >= 6) { startYear = year; endYear = year + 1; }Â 
Â  Â  Â  Â  Â  else { startYear = year - 1; endYear = year; }
Â  Â  Â  Â  Â  const fromDate = new Date(startYear, 6, 1);Â 
Â  Â  Â  Â  Â  const toDate = new Date(endYear, 5, 30);Â  Â 
Â  Â  Â  Â  Â  return { from: isoFormat(fromDate), to: isoFormat(toDate) };
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  // FIX: seedSampleData function now returns an empty arrayÂ 
Â  Â  Â  function seedSampleData() {
Â  Â  Â  Â  Â  return []; // Returns an empty array to ensure no data is ever seeded automatically
Â  Â  Â  }
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  // 4. Persistence & Theme (Renumbered)
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  function saveToStorage(){
Â  Â  Â  Â  try{Â 
Â  Â  Â  Â  Â  Â  // Only save the main storage key if there are records or logs.
Â  Â  Â  Â  Â  Â  if (store.records.length > 0 || store.logs.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â // FIX: Ensure the STORAGE_KEY is explicitly removed if records are empty
Â  Â  Â  Â  Â  Â  Â  Â  Â localStorage.removeItem(STORAGE_KEY);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Save settings keys regardless
Â  Â  Â  Â  Â  Â  localStorage.setItem(SORT_KEY, JSON.stringify(currentSort));
Â  Â  Â  Â  }catch(e){}
Â  Â  Â  }
Â  Â  Â  function loadFromStorage(){
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  const raw = localStorage.getItem(STORAGE_KEY);
Â  Â  Â  Â  Â  if(raw){Â 
Â  Â  Â  Â  Â  Â  Â  const parsed = JSON.parse(raw);Â 
Â  Â  Â  Â  Â  Â  Â  if(parsed.records) store.records = parsed.records;Â 
Â  Â  Â  Â  Â  Â  Â  if(parsed.logs) store.logs = parsed.logs;Â 
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  const rawSort = localStorage.getItem(SORT_KEY);
Â  Â  Â  Â  Â  if(rawSort) currentSort = JSON.parse(rawSort);

Â  Â  Â  Â  }catch(e){}
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  function applyTheme(theme){
Â  Â  Â  Â  if(theme === 'light') {
Â  Â  Â  Â  Â  Â  document.body.setAttribute('data-theme','light');
Â  Â  Â  Â  Â  Â  themeToggle.title = 'Switch to Dark Mode';
Â  Â  Â  Â  Â  Â  themeToggle.textContent = '';Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  document.body.removeAttribute('data-theme');
Â  Â  Â  Â  Â  Â  themeToggle.title = 'Switch to Light Mode';
Â  Â  Â  Â  Â  Â  themeToggle.textContent = '';Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  try{ localStorage.setItem(THEME_KEY, theme); }catch(e){}
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  function toggleTheme(){
Â  Â  Â  Â  const cur = localStorage.getItem(THEME_KEY) || 'dark';
Â  Â  Â  Â  const next = (cur === 'dark') ? 'light' : 'dark';
Â  Â  Â  Â  applyTheme(next);
Â  Â  Â  Â  addLog(`[${nowTsForLog()}] Theme changed to ${next}`);
Â  Â  Â  }

Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  // 5. Rendering, Logging, and Summary (Renumbered)
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  function renderRecords(list){
Â  Â  Â  Â  Array.from(recordsSection.querySelectorAll('.record-row, .empty-state')).forEach(n=>n.remove());
Â  Â  Â  Â  const rows = (list && Array.isArray(list)) ? list : [];
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (rows.length === 0) {
Â  Â  Â  Â  Â  Â  const emptyDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  emptyDiv.className = 'empty-state';
Â  Â  Â  Â  Â  Â  // Custom message if filters are active, otherwise the standard startup message
Â  Â  Â  Â  Â  Â  emptyDiv.textContent = filterSearch.value || filterAccount.value !== 'All Accounts' || filterFrom.value !== isoToday() || filterTo.value !== isoToday()Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? "No records found matching your current filters."
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : "You have no records yet. Click '+ Add Income/Loan/Expense' to get started!";
Â  Â  Â  Â  Â  Â  recordsSection.appendChild(emptyDiv);
Â  Â  Â  Â  Â  Â  recalcFilteredSummary(rows);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  rows.forEach(rec=>{
Â  Â  Â  Â  Â  const row = document.createElement('div'); row.className='record-row'; row.dataset.id=rec.guid; // Use rec.guid
Â  Â  Â  Â  Â  row.innerHTML = `
Â  Â  Â  Â  Â  Â  <div>${rec.date}</div>
Â  Â  Â  Â  Â  Â  <div>${rec.account}</div>
Â  Â  Â  Â  Â  Â  <div>${rec.desc}</div>
Â  Â  Â  Â  Â  Â  <div>${formatAmount(rec.amount,rec.sign)}</div>
Â  Â  Â  Â  Â  Â  <div class="record-actions"><button title="Edit">âœï¸</button> <button title="Delete">ğŸ—‘ï¸</button></div>
Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  row.querySelector('[title="Edit"]').addEventListener('click', ()=> openEdit(rec.guid)); // Use rec.guid
Â  Â  Â  Â  Â  row.querySelector('[title="Delete"]').addEventListener('click', ()=> openDeleteConfirm(rec.guid)); // Use rec.guid
Â  Â  Â  Â  Â  recordsSection.appendChild(row);
Â  Â  Â  Â  });
Â  Â  Â  Â  recalcFilteredSummary(rows);
Â  Â  Â  }

Â  Â  Â  function renderLogs(){
Â  Â  Â  Â  const logModalList = document.getElementById('activity-log-modal');
Â  Â  Â  Â  logModalList.innerHTML = '';
Â  Â  Â  Â  store.logs.forEach(entry=>{
Â  Â  Â  Â  Â  const div = document.createElement('div'); div.className='log-item'; div.textContent = entry;
Â  Â  Â  Â  Â  logModalList.appendChild(div);
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  function addLog(entry){
Â  Â  Â  Â  store.logs.unshift(entry);
Â  Â  Â  Â  if(store.logs.length>500) store.logs.length = 500;
Â  Â  Â  Â  renderLogs();
Â  Â  Â  Â  saveToStorage();
Â  Â  Â  }

Â  Â  Â  function recalcGrandTotal(){
Â  Â  Â  Â  Â  let income = 0, loan = 0, expense = 0;
Â  Â  Â  Â  Â  store.records.forEach(r=>{
Â  Â  Â  Â  Â  Â  Â  // Ensure r.amount is treated as a number
Â  Â  Â  Â  Â  Â  Â  const amount = Number(r.amount || 0);
Â  Â  Â  Â  Â  Â  Â  if(r.account === 'Income') income += amount;
Â  Â  Â  Â  Â  Â  Â  else if(r.account === 'Loan') loan += amount;
Â  Â  Â  Â  Â  Â  Â  else if(r.account === 'Expense') expense += amount;
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  const grandBalance = (income + loan) - expense;
Â  Â  Â  Â  Â  document.getElementById('current-balance').textContent = 'Rs ' + grandBalance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
Â  Â  Â  }

Â  Â  Â  function recalcFilteredSummary(filteredRecords){
Â  Â  Â  Â  let income = 0, loan = 0, expense = 0;
Â  Â  Â  Â  const list = filteredRecords || [];Â 
Â  Â  Â  Â  list.forEach(r=>{
Â  Â  Â  Â  Â  Â  // Ensure r.amount is treated as a number
Â  Â  Â  Â  Â  Â  const amount = Number(r.amount || 0);
Â  Â  Â  Â  Â  Â  if(r.account === 'Income') income += amount;
Â  Â  Â  Â  Â  Â  else if(r.account === 'Loan') loan += amount;
Â  Â  Â  Â  Â  Â  else if(r.account === 'Expense') expense += amount;
Â  Â  Â  Â  });
Â  Â  Â  Â  document.getElementById('sum-income').textContent = 'Rs ' + income.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
Â  Â  Â  Â  document.getElementById('sum-loan').textContent = 'Rs ' + loan.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
Â  Â  Â  Â  document.getElementById('sum-expense').textContent = 'Rs ' + expense.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
Â  Â  Â  Â  
Â  Â  Â  Â  // Display filtered balance: (income + loan) - expense
Â  Â  Â  Â  const filteredBalance = (income + loan) - expense;
Â  Â  Â  Â  document.getElementById('summary-filtered-balance').textContent = 'Rs ' + filteredBalance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  // 6. Filtering and Sorting Logic (Renumbered)
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  function getFilteredRecords(){
Â  Â  Â  Â  const q = (filterSearch.value || '').trim().toLowerCase();
Â  Â  Â  Â  const acc = filterAccount.value || 'All Accounts';
Â  Â  Â  Â  const from = filterFrom.value || '';
Â  Â  Â  Â  const to = filterTo.value || '';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 1. Filter
Â  Â  Â  Â  const filtered = store.records.filter(r=>{
Â  Â  Â  Â  Â  const dateOk = (!from || r.date >= from) && (!to || r.date <= to);
Â  Â  Â  Â  Â  const accOk = (acc === 'All Accounts') || (r.account === acc);
Â  Â  Â  Â  Â  const text = (String(r.desc) + ' ' + String(r.amount)).toLowerCase();
Â  Â  Â  Â  Â  const textOk = !q || text.includes(q);
Â  Â  Â  Â  Â  return dateOk && accOk && textOk;
Â  Â  Â  Â  });

Â  Â  Â  Â  // 2. Sort the filtered list
Â  Â  Â  Â  return sortRecords(filtered);
Â  Â  Â  }

Â  Â  Â  function applyFilter(){
Â  Â  Â  Â  const filtered = getFilteredRecords();
Â  Â  Â  Â  renderRecords(filtered);
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  function sortRecords(list) {
Â  Â  Â  Â  Â  list.sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  const key = currentSort.key;
Â  Â  Â  Â  Â  Â  Â  const order = currentSort.order === 'asc' ? 1 : -1;
Â  Â  Â  Â  Â  Â  Â  let valA, valB;

Â  Â  Â  Â  Â  Â  Â  if (key === 'amount') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  // Sort numbers (treat loan as positive, expense as negative)
Â  Â  Â  Â  Â  Â  Â  Â  Â  valA = a.sign === 'expense' ? -Number(a.amount) : Number(a.amount);
Â  Â  Â  Â  Â  Â  Â  Â  Â  valB = b.sign === 'expense' ? -Number(b.amount) : Number(b.amount);
Â  Â  Â  Â  Â  Â  Â  } else if (key === 'date') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  // Sort dates (strings)
Â  Â  Â  Â  Â  Â  Â  Â  Â  valA = a.date;
Â  Â  Â  Â  Â  Â  Â  Â  Â  valB = b.date;
Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  // Sort strings (account)
Â  Â  Â  Â  Â  Â  Â  Â  Â  valA = String(a[key]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  valB = String(b[key]);
Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  if (valA < valB) return -1 * order;
Â  Â  Â  Â  Â  Â  Â  if (valA > valB) return 1 * order;
Â  Â  Â  Â  Â  Â  Â  return 0;
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  return list;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  function updateSortUI(){
Â  Â  Â  Â  Array.from(recordsHead.children).forEach(h => {
Â  Â  Â  Â  Â  const key = h.dataset.sortKey;
Â  Â  Â  Â  Â  if (key === currentSort.key) {
Â  Â  Â  Â  Â  Â  Â  h.setAttribute('data-sort-order', currentSort.order);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  h.removeAttribute('data-sort-order');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  // 7. Modal & Action Handlers (Renumbered)
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â Â 
Â  Â  Â  // The main modal open handler
Â  Â  Â  function openModal(accountType, recordId = null) {
Â  Â  Â  Â  // ... (Ø¢Ù¾ Ú©Ø§ Ù…ÙˆØ¬ÙˆØ¯Û openModal Logic ÛŒÛØ§Úº ÛÙˆÚ¯Ø§) ...
Â  Â  Â  }

Â  Â  Â  function openEdit(guid) {
Â  Â  Â  Â  // ... (Ø¢Ù¾ Ú©Ø§ Ù…ÙˆØ¬ÙˆØ¯Û openEdit Logic ÛŒÛØ§Úº ÛÙˆÚ¯Ø§) ...
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  // The new/edited record SAVE handler (Updated for Sync)
Â  Â  Â  function addRecord(event) {
Â  Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // 1. Validation and Data Extraction
Â  Â  Â  Â  Â  if (!dateInput.value || !descInput.value.trim() || !amtInput.value) {
Â  Â  Â  Â  Â  Â  Â  alert('Please fill in all fields (Date, Description, Amount).');
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  const isEdit = saveBtn.dataset.editId;
Â  Â  Â  Â  Â  const newAmount = Number(amtInput.value);
Â  Â  Â  Â  Â  const accountType = accountSelect.value;
Â  Â  Â  Â  Â  const sign = (accountType === 'Expense') ? 'negative' : 'positive';
Â  Â  Â  Â  Â  const amountForStorage = (accountType === 'Expense') ? newAmount * -1 : newAmount;

Â  Â  Â  Â  Â  // 2. Create/Update Record
Â  Â  Â  Â  Â  let newRecord = {
Â  Â  Â  Â  Â  Â  Â  guid: isEdit || crypto.randomUUID(),
Â  Â  Â  Â  Â  Â  Â  date: dateInput.value,
Â  Â  Â  Â  Â  Â  Â  desc: descInput.value.trim(),
Â  Â  Â  Â  Â  Â  Â  amount: newAmount,
Â  Â  Â  Â  Â  Â  Â  rawAmount: amountForStorage, // This is the signed amount for total calculation
Â  Â  Â  Â  Â  Â  Â  sign: sign,
Â  Â  Â  Â  Â  Â  Â  account: accountType,
Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  if (isEdit) {
Â  Â  Â  Â  Â  Â  Â  const index = store.records.findIndex(r => r.guid === isEdit);
Â  Â  Â  Â  Â  Â  Â  if (index > -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  store.records[index] = newRecord;
Â  Â  Â  Â  Â  Â  Â  Â  Â  addLog(`[${nowTsForLog()}] EDITED: ${capitalize(accountType)} of Rs ${newAmount} (ID: ${isEdit.substring(0, 8)})`);
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  store.records.unshift(newRecord);
Â  Â  Â  Â  Â  Â  Â  addLog(`[${nowTsForLog()}] ADDED: ${capitalize(accountType)} of Rs ${newAmount} (ID: ${newRecord.guid.substring(0, 8)})`);
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // 3. Local Storage Update
Â  Â  Â  Â  Â  store.records.sort(sortFunction);
Â  Â  Â  Â  Â  saveToStorage(); 

Â  Â  Â  Â  Â  // 4. *** GOOGLE SHEETS SYNC ***
Â  Â  Â  Â  Â  // Ø§Ú¯Ø± Edit ÛÙˆ ØªÙˆ Ø¨Ú¾ÛŒ Ø§ÛŒÚ© Ù†ÛŒØ§ Ø±ÛŒÚ©Ø§Ø±Úˆ 'Active' Ø³Ù¹ÛŒÙ¹Ø³ Ú©Û’ Ø³Ø§ØªÚ¾ Ø¨Ú¾ÛŒØ¬ÛŒÚº ØªØ§Ú©Û Sheets Ù…ÛŒÚº ØªØ§Ø²Û ØªØ±ÛŒÙ† Ø§Ù†Ù¹Ø±ÛŒ ÛÙˆ
Â  Â  Â  Â  Â  // (Sheets Ù…ÛŒÚº Ø§ÛŒÚ© Ø³Û’ Ø²ÛŒØ§Ø¯Û Ø³Ø·Ø±ÛŒÚº ÛÙˆÚº Ú¯ÛŒØŒ Ø¢Ø®Ø±ÛŒ Ø³Ø·Ø± Ø¯Ø±Ø³Øª ÚˆÛŒÙ¹Ø§ Ø¨ØªØ§Ø¦Û’ Ú¯ÛŒ)
Â  Â  Â  Â  Â  sendRecordToSheets(newRecord, 'Active'); 
Â  Â  Â  Â  Â  // **************************

Â  Â  Â  Â  Â  // 5. UI Cleanup
Â  Â  Â  Â  Â  closeModal();
Â  Â  Â  Â  Â  applyFilter();
Â  Â  Â  Â  Â  recalcGrandTotal();
Â  Â  Â  Â  Â  resetModal();
Â  Â  Â  }

Â  Â  Â  // The delete confirmation handler (Updated for Sync)
Â  Â  Â  function deleteRecord(guid) {
Â  Â  Â  Â  Â  const recordToDelete = store.records.find(r => r.guid === guid);
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // 1. Local Storage à¤¸à¥‡ à¤¹à¤Ÿà¤¾à¤à¤
Â  Â  Â  Â  Â  store.records = store.records.filter(r => r.guid !== guid);
Â  Â  Â  Â  Â  saveToStorage(); 

Â  Â  Â  Â  Â  // 2. Activity Log
Â  Â  Â  Â  Â  if (recordToDelete) {
Â  Â  Â  Â  Â  Â  Â  addLog(`[${nowTsForLog()}] DELETED: ${capitalize(recordToDelete.account)} of Rs ${recordToDelete.amount} (ID: ${recordToDelete.guid.substring(0, 8)})`);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // 3. *** GOOGLE SHEETS SYNC: Send Delete Status ***
Â  Â  Â  Â  Â  Â  // Sheets Ù…ÛŒÚº Ø±ÛŒÚ©Ø§Ø±Úˆ Ú©Ùˆ 'Deleted' Ú©Û’ Ø·ÙˆØ± Ù¾Ø± Ù…Ø§Ø±Ú© Ú©Ø±Ù†Û’ Ú©Û’ Ù„ÛŒÛ’ Ø¨Ú¾ÛŒØ¬ÛŒÚº
Â  Â  Â  Â  Â  Â  sendRecordToSheets(recordToDelete, 'Deleted'); 
Â  Â  Â  Â  Â  Â  // ************************************************
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  Â  // 4. UI Update
Â  Â  Â  Â  Â  applyFilter(); // Calls renderRecords
Â  Â  Â  Â  Â  recalcGrandTotal();
Â  Â  Â  Â  Â  closeDeleteConfirm();
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  function openDeleteConfirm(guid) {
Â  Â  Â  Â  // ... (Ø¢Ù¾ Ú©Ø§ Ù…ÙˆØ¬ÙˆØ¯Û openDeleteConfirm Logic ÛŒÛØ§Úº ÛÙˆÚ¯Ø§) ...
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  function closeDeleteConfirm() {
Â  Â  Â  Â  // ... (Ø¢Ù¾ Ú©Ø§ Ù…ÙˆØ¬ÙˆØ¯Û closeDeleteConfirm Logic ÛŒÛØ§Úº ÛÙˆÚ¯Ø§) ...
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  function closeModal() {
Â  Â  Â  Â  // ... (Ø¢Ù¾ Ú©Ø§ Ù…ÙˆØ¬ÙˆØ¯Û closeModal Logic ÛŒÛØ§Úº ÛÙˆÚ¯Ø§) ...
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  function resetModal() {
Â  Â  Â  Â  // ... (Ø¢Ù¾ Ú©Ø§ Ù…ÙˆØ¬ÙˆØ¯Û resetModal Logic ÛŒÛØ§Úº ÛÙˆÚ¯Ø§) ...
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  // ... (Ø¨Ø§Ù‚ÛŒ ØªÙ…Ø§Ù… ÙÙ†Ú©Ø´Ù†Ø² ÛŒÛØ§Úº ÛÙˆÚº Ú¯Û’: saveBackup, restoreBackup, exportCSV, setupEventListeners, init) ...
Â  Â  Â Â 
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  // 8. Initialization and Event Listeners (Renumbered)
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  function setupEventListeners() {
Â  Â  Â  Â  // ... (Ø¢Ù¾ Ú©Ø§ Ù…ÙˆØ¬ÙˆØ¯Û setupEventListeners Logic ÛŒÛØ§Úº ÛÙˆÚ¯Ø§) ...
Â  Â  Â  }

Â  Â  Â  function init() {
Â  Â  Â  Â  // ... (Ø¢Ù¾ Ú©Ø§ Ù…ÙˆØ¬ÙˆØ¯Û init Logic ÛŒÛØ§Úº ÛÙˆÚ¯Ø§) ...
Â  Â  Â  }

Â  Â  Â  init();
Â  Â  })();
Â  </script>
</body>
</html>
