<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title>HomeLedger v1.5.3</title>
Â Â 
Â  <link rel="manifest" href="/hledgerapp/manifest.json" />
Â Â 
Â  <link rel="icon" type="image/png" sizes="32x32" href="/hledgerapp/icons/icon-32x32.png">
Â  <link rel="icon" type="image/png" sizes="16x16" href="/hledgerapp/icons/icon-16x16.png">
Â Â 
Â  <style>
Â  Â  /* ------------------------------------------------------------------- */
Â  Â  /* 1. CSS Variables and Theme Setup */
Â  Â  /* ------------------------------------------------------------------- */
Â  Â  :root{
Â  Â  Â  /* CORE COLORS */
Â  Â  Â  --bg:#0a0d14;Â 
Â  Â  Â  --panel:#1f2937;
Â  Â  Â  --glass-border:#4b5563;
Â  Â  Â  --muted:#f3f4f6;Â 
Â  Â  Â Â 
Â  Â  Â  /* UTILITY COLORS */
Â  Â  Â  --accent:#60a5fa; --success:#34d399; --warning:#fbbf24; --danger:#ef4444;
Â  Â  Â Â 
Â  Â  Â  /* SEMANTIC VARIABLES */
Â  Â  Â  --text-color: var(--muted);
Â  Â  Â  --input-bg: var(--bg);Â 
Â  Â  Â  --input-border: var(--glass-border);
Â  Â  Â  --focus-outline-color: var(--accent);
Â  Â  Â  --active-filter-bg: var(--accent);

Â  Â  Â  --font:Inter,ui-sans-serif,system-ui; --gap:12px;
Â  Â  }
Â  Â Â 
Â  Â  body[data-theme="light"]{
Â  Â  Â  --bg:#f9fafb;Â 
Â  Â  Â  --panel:#ffffff;Â 
Â  Â  Â  --glass-border:#e5e7eb;Â 
Â  Â  Â  --muted:#111827;Â 
Â  Â  Â Â 
Â  Â  Â  --accent:#2563eb; --success:#059669; --warning:#b45309; --danger:#b91c1c;
Â  Â  Â Â 
Â  Â  Â  --text-color: var(--muted);
Â  Â  Â  --input-bg: var(--ffffff);Â 
Â  Â  Â  --input-border: var(--glass-border);
Â  Â  Â  --focus-outline-color: var(--accent);Â 
Â  Â  Â  --active-filter-bg: var(--accent);
Â  Â  Â Â 
Â  Â  Â  color:var(--text-color);
Â  Â  }
Â  Â Â 
Â  Â  /* ------------------------------------------------------------------- */
Â  Â  /* 2. General Styles and Layout */
Â  Â  /* ------------------------------------------------------------------- */
Â  Â  body{background:var(--bg);color:var(--text-color);font-family:var(--font);margin:0;padding:0;display:flex;justify-content:center;padding:14px;transition:background .2s,color .2s}
Â  Â  .wrap{width:100%;max-width:920px;padding:12px;display:flex;flex-direction:column;gap:var(--gap)}
Â  Â Â 
Â  Â  .topbar, .balance-card, .filter-card, .records, .modal{
Â  Â  Â  Â  background:var(--panel);
Â  Â  Â  Â  border:1px solid var(--glass-border);
Â  Â  Â  Â  border-radius:6px;
Â  Â  Â  Â  box-shadow: none;
Â  Â  }

Â  Â  .topbar{display:flex;justify-content:space-between;align-items:center;padding:8px 10px}
Â  Â  .brand{font-weight:700}
Â  Â  .controls{display:flex;gap:8px;align-items:center}
Â  Â  details.menu{position:relative}
Â  Â  details summary{cursor:pointer;padding:2px 6px}
Â  Â  details .dropdown{position:absolute;right:0;top:28px;background:var(--panel);color:inherit;border-radius:6px;padding:6px;border:1px solid var(--glass-border)}
Â  Â  details .dropdown button{display:block;width:100%;text-align:left;padding:6px;border:none;background:transparent;color:inherit;cursor:pointer}
Â  Â  details .dropdown button#btn-reset {
Â  Â  Â  Â  color: var(--danger);
Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  border-top: 1px solid var(--glass-border);
Â  Â  Â  Â  margin-top: 4px;
Â  Â  Â  Â  padding-top: 8px;
Â  Â  }

Â  Â  .balance-card{padding:12px;display:flex;justify-content:space-between;gap:12px;align-items:center}
Â  Â  .balance-left .big{font-size:18px;font-weight:800;color:var(--accent)}
Â  Â  .summary-item{font-size:13px}
Â  Â  .actions{display:flex;flex-direction:column;gap:8px}

Â  Â  /* Button Styles */
Â  Â  .big-btn{width:100%;padding:10px;border-radius:6px;border:none;font-weight:700;cursor:pointer;font-size:14px}
Â  Â  .big-btn.income{background:var(--success);color:#fff}
Â  Â  .big-btn.loan{background:var(--warning);color:#111}
Â  Â  .big-btn.expense{background:var(--danger);color:#fff}

Â  Â  .filter-card{padding:10px}
Â  Â  .filter-row{display:flex;flex-direction:column;gap:6px}
Â  Â Â 
Â  Â  /* Input/Select Styles & FOCUS FIX */
Â  Â  input,select{
Â  Â  Â  Â  width:100%;padding:8px;border-radius:6px;
Â  Â  Â  Â  border:1px solid var(--input-border);
Â  Â  Â  Â  background:var(--input-bg);Â 
Â  Â  Â  Â  color:var(--text-color);Â 
Â  Â  Â  Â  box-sizing: border-box;Â 
Â  Â  Â  Â  transition: border-color 0.2s, box-shadow 0.2s;
Â  Â  }
Â  Â  input:focus, select:focus, button:focus{
Â  Â  Â  Â  outline: none;
Â  Â  Â  Â  border-color: var(--focus-outline-color);
Â  Â  Â  Â  box-shadow: 0 0 0 2px var(--focus-outline-color);
Â  Â  }
Â  Â  /* Disabled state style */
Â  Â  select:disabled {
Â  Â  Â  Â  opacity: 0.7;
Â  Â  Â  Â  cursor: not-allowed;
Â  Â  }

Â  Â  /* Date Picker Fixes (Calendar Icon & Text) */
Â  Â  input[type="date"]::-webkit-datetime-edit-text,
Â  Â  input[type="date"]::-webkit-datetime-edit-month-field,
Â  Â  input[type="date"]::-webkit-datetime-edit-day-field,
Â  Â  input[type="date"]::-webkit-datetime-edit-year-field,
Â  Â  input[type="date"]::-webkit-datetime-edit-literal {Â 
Â  Â  Â  Â  color: var(--text-color);
Â  Â  }
Â  Â  input[type="date"]::-webkit-calendar-picker-indicator {
Â  Â  Â  Â  filter: invert(1) brightness(0.9);
Â  Â  Â  Â  cursor: pointer;
Â  Â  }
Â  Â  body[data-theme="light"] input[type="date"]::-webkit-calendar-picker-indicator {
Â  Â  Â  Â  filter: none;
Â  Â  }
Â  Â Â 
Â  Â  /* ------------------------------------------------------------------- */
Â  Â  /* 3. Quick Filter Styles (UX FIX) */
Â  Â  /* ------------------------------------------------------------------- */
Â  Â  .quick-filters{
Â  Â  Â  display:flex;
Â  Â  Â  flex-wrap: wrap;Â 
Â  Â  Â  gap:6px;
Â  Â  Â  margin-top: 2px;Â 
Â  Â  Â  margin-bottom: 2px;Â 
Â  Â  }
Â  Â  .quick-filters button{
Â  Â  Â  flex: 1 1 auto;Â 
Â  Â  Â  padding: 6px 8px;
Â  Â  Â  border: 1px solid var(--input-border);
Â  Â  Â  background: var(--input-bg);Â 
Â  Â  Â  color: var(--text-color);
Â  Â  Â  border-radius: 4px;
Â  Â  Â  font-size: 12px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  box-sizing: border-box;
Â  Â  Â  transition: background 0.2s;
Â  Â  }
Â  Â  .quick-filters button:hover{
Â  Â  Â  background: var(--glass-border);
Â  Â  }
Â  Â  .quick-filters button.active {
Â  Â  Â  Â  background: var(--active-filter-bg);
Â  Â  Â  Â  color: var(--bg);
Â  Â  Â  Â  border-color: var(--active-filter-bg);
Â  Â  Â  Â  font-weight: 700;
Â  Â  }

Â  Â  /* ------------------------------------------------------------------- */
Â  Â  /* 4. Records & Sorting Styles (FEATURE FIX) */
Â  Â  /* ------------------------------------------------------------------- */
Â  Â  .records{overflow:hidden}
Â  Â  .records-head{display:grid;grid-template-columns:120px 110px 1fr 110px 60px;padding:8px 10px;font-weight:700;background:rgba(255,255,255,0.08);border-bottom:1px solid var(--glass-border)}
Â  Â Â 
Â  Â  .records-head > div {
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  padding-right: 15px;
Â  Â  Â  Â  position: relative;
Â  Â  }
Â  Â  .records-head > div:hover {
Â  Â  Â  Â  opacity: 0.8;
Â  Â  }
Â  Â  .records-head > div[data-sort-order]::after {
Â  Â  Â  Â  content: ' ';
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  right: 0px;
Â  Â  Â  Â  top: 50%;
Â  Â  Â  Â  transform: translateY(-50%);
Â  Â  Â  Â  font-size: 10px;
Â  Â  }
Â  Â  .records-head > div[data-sort-order="asc"]::after {
Â  Â  Â  Â  content: 'â–²';
Â  Â  }
Â  Â  .records-head > div[data-sort-order="desc"]::after {
Â  Â  Â  Â  content: 'â–¼';
Â  Â  }

Â  Â  .record-row{display:grid;grid-template-columns:120px 110px 1fr 110px 60px;padding:8px 10px;border-bottom:1px solid var(--glass-border);align-items:center}
Â  Â  .record-actions button{background:none;border:none;color:var(--text-color);cursor:pointer;transition:color 0.1s}
Â  Â Â 
Â  Â  .empty-state {
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  padding: 40px 10px;
Â  Â  Â  Â  color: var(--glass-border);
Â  Â  Â  Â  font-size: 14px;
Â  Â  }

Â  Â  footer{text-align:center;font-size:12px;opacity:0.7;margin-top:10px}
Â  Â Â 
Â  Â  /* ------------------------------------------------------------------- */
Â  Â  /* 5. Modals and Delete Confirmation (UX FIX) */
Â  Â  /* ------------------------------------------------------------------- */
Â  Â  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:none;display:none;align-items:center;justify-content:center;padding:16px;z-index:60}
Â  Â  .overlay.show{display:flex}
Â  Â  .modal{
Â  Â  Â  Â  width:100%;max-width:560px;
Â  Â  Â  Â  background:var(--panel);
Â  Â  Â  Â  border:1px solid var(--glass-border);
Â  Â  Â  Â  border-radius:8px;
Â  Â  Â  Â  padding:16px;
Â  Â  Â  Â  box-shadow:0 6px 15px rgba(0,0,0,0.4);
Â  Â  }
Â  Â Â 
Â  Â  .delete-modal-content {
Â  Â  Â  Â  padding: 10px 0;
Â  Â  }
Â  Â  .delete-modal-content p {
Â  Â  Â  Â  margin: 0 0 12px 0;
Â  Â  Â  Â  font-size: 14px;
Â  Â  }
Â  Â  .delete-modal-content .record-details {
Â  Â  Â  Â  background: var(--input-bg);
Â  Â  Â  Â  border: 1px solid var(--input-border);
Â  Â  Â  Â  padding: 8px;
Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  font-size: 13px;
Â  Â  Â  Â  word-break: break-word;
Â  Â  }
Â  Â Â 
Â  Â  /* Modal Button Styles */
Â  Â  .modal h2{margin:0 0 8px 0;font-size:16px}
Â  Â  .modal label{font-size:13px;margin-bottom:6px;display:block;color:var(--muted)}
Â  Â Â 
Â  Â  /* FIX: Input Zoom on iOS - Set font-size to 16px to prevent viewport zoom */
Â  Â  .modal input[type="text"],.modal input[type="date"],.modal input[type="number"],.modal select{
Â  Â  Â  Â  width:100%;padding:10px;border-radius:6px;
Â  Â  Â  Â  border:1px solid var(--input-border);
Â  Â  Â  Â  background:var(--input-bg);
Â  Â  Â  Â  color:var(--text-color);Â 
Â  Â  Â  Â  box-sizing: border-box;Â 
Â  Â  Â  Â  font-size: 16px; /* <-- THE FIX */
Â  Â  }
Â  Â  .modal .row-2{display:block;}Â 
Â  Â  .modal .actions-row{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
Â  Â  .btn-cancel{background:transparent;border:1px solid var(--glass-border);color:var(--muted);padding:8px 12px;border-radius:6px;cursor:pointer}
Â  Â  .btn-save{padding:8px 12px;border-radius:6px;border:none;font-weight:700;cursor:pointer}
Â  Â  .btn-save.income{background:var(--success);color:#fff}
Â  Â  .btn-save.loan{background:var(--warning);color:#111}
Â  Â  .btn-save.expense{background:var(--danger);color:#fff}
Â  Â  .btn-delete-confirm { background: var(--danger); color: #fff; }
Â  Â Â 
Â  Â  .log-list{max-height:400px;overflow:auto;display:flex;flex-direction:column;gap:8px;padding-top:8px}
Â  Â  .log-item{font-size:13px;background:rgba(255,255,255,0.08);padding:8px;border-radius:6px}
Â  Â Â 
Â  Â  /* ------------------------------------------------------------------- */
Â  Â  /* 6. Media Queries & Scrollbar Fixes (MOBILE FIX APPLIED HERE) */
Â  Â  /* ------------------------------------------------------------------- */
Â  Â  @media (max-width:860px){.main-grid{grid-template-columns:1fr}}
Â  Â  @media (max-width:420px){
Â  Â  Â  .balance-card { flex-direction: column; align-items: stretch; }
Â  Â  Â  .balance-right { display: flex; flex-direction: column; align-items: flex-start; gap: 6px; }
Â  Â  Â  .quick-filters button { flex: 1 1 48%; }
Â  Â  Â Â 
Â  Â  Â  /* FIX: Records Table on Mobile - Show Date, Description, Amount, Action */
Â  Â  Â  .records-head, .record-row {
Â  Â  Â  Â  Â  /* Grid columns mapping to: Date(1st), Description(3rd), Amount(4th), Action(5th) */
Â  Â  Â  Â  Â  /* Date: 80px, Description: 1fr, Amount: 90px (Increased for clarity), Action: 50px */
Â  Â  Â  Â  Â  grid-template-columns: 80px 1fr 90px 50px;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  /* 1. Hide Account (2nd item) */
Â  Â  Â  .records-head div:nth-child(2), .record-row div:nth-child(2) {
Â  Â  Â  Â  Â  display: none;Â 
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  /* 2. Ensure Description (3rd item) is fully visible and takes 1fr */
Â  Â  Â  .records-head div:nth-child(3), .record-row div:nth-child(3) {
Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  word-break: break-word;Â 
Â  Â  Â  Â  Â  white-space: normal;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  /* 3. Ensure Amount (4rd item) is visible and aligned */
Â  Â  Â  .records-head div:nth-child(4), .record-row div:nth-child(4) {
Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  justify-content: flex-end; /* Align amount to the right */
Â  Â  Â  }

Â  Â  Â  /* 4. Ensure Action (5th item) is visible and centered */
Â  Â  Â  .records-head div:nth-child(5), .record-row div:nth-child(5) {
Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  /* 5. Ensure Date (1st item) is visible and aligned */
Â  Â  Â  .records-head div:nth-child(1), .record-row div:nth-child(1) {
Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  justify-content: flex-start;
Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  /* THEME ICON HIGHLIGHT CSS START */
Â  Â  .theme-toggle{
Â  Â  Â  display:inline-flex;
Â  Â  Â  align-items:center;
Â  Â  Â  justify-content:center;
Â  Â  Â  width: 40px;Â 
Â  Â  Â  height: 20px;
Â  Â  Â  padding: 0;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  border:1px solid var(--glass-border);
Â  Â  Â  cursor:pointer;
Â  Â  Â  background:transparent;
Â  Â  Â  position: relative;
Â  Â  Â  font-size: 14px;
Â  Â  Â  overflow: hidden;Â 
Â  Â  }
Â  Â  /* Set icon based on current theme */
Â  Â  .theme-toggle::before {
Â  Â  Â  Â  content: 'ğŸŒ™'; /* Default is Dark Mode, so show Moon (switch to Sun) */
Â  Â  Â  Â  color: var(--text-color);
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  transition: transform 0.2s ease-in-out;
Â  Â  }
Â  Â  body[data-theme="light"] .theme-toggle::before {
Â  Â  Â  Â  content: 'â˜€ï¸'; /* Light Mode, so show Sun (switch to Moon) */
Â  Â  Â  Â  transform: translateX(0);
Â  Â  }
Â  Â  /* THEME ICON HIGHLIGHT CSS END */
Â  Â Â 
Â  Â  .hidden-file{display:none}
Â  Â Â 
Â  Â  .log-list::-webkit-scrollbar, body::-webkit-scrollbar {
Â  Â  Â  Â  width: 8px;
Â  Â  Â  Â  height: 8px;
Â  Â  }
Â  Â  .log-list::-webkit-scrollbar-track, body::-webkit-scrollbar-track {
Â  Â  Â  Â  background: var(--bg);
Â  Â  }
Â  Â  .log-list::-webkit-scrollbar-thumb, body::-webkit-scrollbar-thumb {
Â  Â  Â  Â  background: var(--glass-border);
Â  Â  Â  Â  border-radius: 4px;
Â  Â  }
Â  Â  .log-list::-webkit-scrollbar-thumb:hover, body::-webkit-scrollbar-thumb:hover {
Â  Â  Â  Â  background: var(--muted);
Â  Â  }
Â  Â  /* ------------------------------------------------------------------- */
Â  </style>
</head>
<body>
Â  <div class="wrap" id="app">
Â  Â  <div class="topbar">
Â  Â  Â  <div class="brand">HomeLedger</div>
Â  Â  Â  <div class="controls">
Â  Â  Â  Â  <div class="theme-toggle" id="theme-toggle" role="button" title="Toggle theme"></div>
Â  Â  Â  Â  <details class="menu">
Â  Â  Â  Â  Â  <summary>â‹®</summary>
Â  Â  Â  Â  Â  <div class="dropdown">
Â  Â  Â  Â  Â  Â  <button id="btn-log">ğŸ“œ View Activity Log</button>
Â  Â  Â  Â  Â  Â  <button id="btn-reset">âš ï¸ Delete All Data</button>
Â  Â  Â  Â  Â  Â  <button id="btn-backup">Backup</button>
Â  Â  Â  Â  Â  Â  <button id="btn-restore">Restore from Local File</button>
Â  Â  Â  Â  Â  Â  <button id="btn-restore-sheet" style="font-weight:700; color:var(--accent);">â˜ï¸ Restore from Sheet</button>
Â  Â  Â  Â  Â  Â  <button id="btn-export">Export CSV</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </details>
Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  <div class="main-grid">
Â  Â  Â  <div class="left-col">

Â  Â  Â  Â  <div class="balance-card" id="balance-card">
Â  Â  Â  Â  Â  <div class="balance-left">
Â  Â  Â  Â  Â  Â  <div style="font-size:13px;color:var(--muted)">Current Balance (Total)</div>
Â  Â  Â  Â  Â  Â  <div class="big" id="current-balance">Rs 0</div>
Â  Â  Â  Â  Â  Â  <div class="summary-item" style="color:var(--accent)">Filtered: <span id="summary-filtered-balance">Rs 0</span></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="balance-right" style="display:flex;gap:12px;align-items:center">
Â  Â  Â  Â  Â  Â  <div class="summary-item"><strong>Income:</strong> <span id="sum-income" style="color:var(--success);font-weight:700">Rs 0</span></div>
Â  Â  Â  Â  Â  Â  <div class="summary-item"><strong>Loan:</strong> <span id="sum-loan" style="color:var(--warning);font-weight:700">Rs 0</span></div>
Â  Â  Â  Â  Â  Â  <div class="summary-item"><strong>Expense:</strong> <span id="sum-expense" style="color:var(--danger);font-weight:700">Rs 0</span></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="actions" style="margin-top:10px">
Â  Â  Â  Â  Â  <button class="big-btn income" data-action="income">+ Add Income</button>
Â  Â  Â  Â  Â  <button class="big-btn loan" data-action="loan">+ Add Loan</button>
Â  Â  Â  Â  Â  <button class="big-btn expense" data-action="expense">+ Add Expense</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="filter-card" style="margin-top:10px">
Â  Â  Â  Â  Â  <strong>Filter Records</strong>
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  <div class="filter-row">
Â  Â  Â  Â  Â  Â  <input id="filter-search" type="text" placeholder="Search by description or amount">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <select id="filter-account">
Â  Â  Â  Â  Â  Â  Â  <option>All Accounts</option>
Â  Â  Â  Â  Â  Â  Â  <option>Income</option>
Â  Â  Â  Â  Â  Â  Â  <option>Loan</option>
Â  Â  Â  Â  Â  Â  Â  <option>Expense</option>
Â  Â  Â  Â  Â  Â  </select>

Â  Â  Â  Â  Â  Â  <div class="quick-filters">
Â  Â  Â  Â  Â  Â  Â  <button id="quick-today">Today</button>
Â  Â  Â  Â  Â  Â  Â  <button id="quick-yesterday">Yesterday</button>
Â  Â  Â  Â  Â  Â  Â  <button id="quick-month">Current Month</button>
Â  Â  Â  Â  Â  Â  Â  <button id="quick-fiscal">Fiscal Year</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div style="display:flex;gap:8px">
Â  Â  Â  Â  Â  Â  Â  <input id="filter-from" type="date">
Â  Â  Â  Â  Â  Â  Â  <input id="filter-to" type="date">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <section class="records" id="records-section" style="margin-top:10px">
Â  Â  Â  Â  Â  <div class="records-head">
Â  Â  Â  Â  Â  Â  <div data-sort-key="date" data-sort-order="desc">Date</div>
Â  Â  Â  Â  Â  Â  <div data-sort-key="account">Account</div>
Â  Â  Â  Â  Â  Â  <div>Description</div>
Â  Â  Â  Â  Â  Â  <div data-sort-key="amount">Amount</div>
Â  Â  Â  Â  Â  Â  <div>Action</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </section>

Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <footer>HomeLedger v1.5.3</footer>Â 
Â  </div>

Â  <div class="overlay" id="log-overlay" aria-hidden="true">
Â  Â  <div class="modal" role="dialog" aria-modal="true">
Â  Â  Â  <h2>ğŸ“œ Activity Log</h2>
Â  Â  Â  <div id="activity-log-modal" class="log-list"></div>
Â  Â  Â  <div class="actions-row" style="margin-top:8px">
Â  Â  Â  Â  <button class="btn-cancel" id="log-close">Close</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div class="overlay" id="modal-overlay" role="dialog" aria-hidden="true">
Â  Â  <div class="modal" role="document" aria-modal="true">
Â  Â  Â  <h2 id="modal-title">Add New Entry</h2>
Â  Â  Â  <div>
Â  Â  Â  Â  <label for="entry-date">Date</label>
Â  Â  Â  Â  <input id="entry-date" type="date" required/>
Â  Â  Â  </div>
Â  Â  Â  <div style="margin-top:8px">
Â  Â  Â  Â  <label for="entry-account">Account</label>
Â  Â  Â  Â  <select id="entry-account">
Â  Â  Â  Â  Â  <option>Income</option>
Â  Â  Â  Â  Â  <option>Loan</option>
Â  Â  Â  Â  Â  <option>Expense</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>
Â  Â  Â  <div style="margin-top:8px">
Â  Â  Â  Â  <label for="entry-desc">Description</label>
Â  Â  Â  Â  <input id="entry-desc" type="text" placeholder="e.g. Salary, Fuel, Phone bill" required/>
Â  Â  Â  </div>
Â  Â  Â  <div class="row-2" style="margin-top:8px">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <label for="entry-amount">Amount</label>
Â  Â  Â  Â  Â  <input id="entry-amount" type="number" min="0.01" step="any" placeholder="0" required/>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="actions-row">
Â  Â  Â  Â  <button class="btn-cancel" id="modal-cancel">Cancel</button>
Â  Â  Â  Â  <button class="btn-save" id="modal-save">Save</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
Â Â 
Â  <div class="overlay" id="delete-overlay" role="dialog" aria-hidden="true">
Â  Â  <div class="modal" role="document" aria-modal="true">
Â  Â  Â  <h2 style="color:var(--danger)">ğŸ—‘ï¸ Confirm Deletion</h2>
Â  Â  Â  <div class="delete-modal-content">
Â  Â  Â  Â  <p>Are you sure you want to permanently delete the following record?</p>
Â  Â  Â  Â  <div class="record-details" id="delete-record-details"></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="actions-row">
Â  Â  Â  Â  <button class="btn-cancel" id="delete-cancel">Cancel</button>
Â  Â  Â  Â  <button class="btn-save btn-delete-confirm" id="delete-confirm-btn" data-id="">Delete</button>
Â  Â  Â  </div>
Â  Â  Â  </div>
Â  </div>

Â  <div class="overlay" id="reset-overlay" role="dialog" aria-hidden="true">
Â  Â  <div class="modal" role="document" aria-modal="true">
Â  Â  Â  <h2 style="color:var(--danger)">âš ï¸ Confirm Full Reset</h2>
Â  Â  Â  <div class="delete-modal-content">
Â  Â  Â  Â  <p><strong>This action cannot be undone.</strong> All your financial records, activity logs, and settings will be permanently deleted and the app will restart empty.</p>
Â  Â  Â  Â  <p>We recommend you create a **Backup (JSON)** before proceeding.</p>
Â  Â  Â  </div>
Â  Â  Â  <div class="actions-row">
Â  Â  Â  Â  <button class="btn-cancel" id="reset-cancel">Cancel</button>
Â  Â  Â  Â  <button class="btn-save btn-delete-confirm" id="reset-confirm-btn">Yes, Delete All Data</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>


Â  <input id="restore-file" class="hidden-file" type="file" accept="application/json" />

Â  <script>
Â  Â  (function(){
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  // 1. DOM References and Constants
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  const overlay = document.getElementById('modal-overlay');
Â  Â  Â  const deleteOverlay = document.getElementById('delete-overlay');
Â  Â  Â  const deleteCancelBtn = document.getElementById('delete-cancel');
Â  Â  Â  const deleteConfirmBtn = document.getElementById('delete-confirm-btn');
Â  Â  Â  const deleteDetailsDiv = document.getElementById('delete-record-details');
Â  Â  Â  const resetOverlay = document.getElementById('reset-overlay');Â 
Â  Â  Â  const resetCancelBtn = document.getElementById('reset-cancel');Â 
Â  Â  Â  const resetConfirmBtn = document.getElementById('reset-confirm-btn');Â 
Â  Â  Â  const title = document.getElementById('modal-title');
Â  Â  Â  const accountSelect = document.getElementById('entry-account');
Â  Â  Â  const saveBtn = document.getElementById('modal-save');
Â  Â  Â  const cancelBtn = document.getElementById('modal-cancel');
Â  Â  Â  const dateInput = document.getElementById('entry-date');
Â  Â  Â  const descInput = document.getElementById('entry-desc');
Â  Â  Â  const amtInput = document.getElementById('entry-amount');
Â  Â  Â  const recordsSection = document.getElementById('records-section');
Â  Â  Â  const recordsHead = recordsSection.querySelector('.records-head');
Â  Â  Â  const logOverlay = document.getElementById('log-overlay');
Â  Â  Â  const logClose = document.getElementById('log-close');
Â  Â  Â  const btnLog = document.getElementById('btn-log');
Â  Â  Â  const btnReset = document.getElementById('btn-reset');
Â  Â  Â  const filterSearch = document.getElementById('filter-search');
Â  Â  Â  const filterAccount = document.getElementById('filter-account');
Â  Â  Â  const filterFrom = document.getElementById('filter-from');
Â  Â  Â  const filterTo = document.getElementById('filter-to');
Â  Â  Â  const btnBackup = document.getElementById('btn-backup');
Â  Â  Â  const btnRestore = document.getElementById('btn-restore');
Â  Â  Â  const btnRestoreSheet = document.getElementById('btn-restore-sheet');Â 
Â  Â  Â  const btnExport = document.getElementById('btn-export');
Â  Â  Â  const themeToggle = document.getElementById('theme-toggle');Â 
Â  Â  Â  const restoreFileInput = document.getElementById('restore-file');
Â  Â  Â Â 
Â  Â  Â  const quickFilterButtons = {
Â  Â  Â  Â  Â  today: document.getElementById('quick-today'),
Â  Â  Â  Â  Â  yesterday: document.getElementById('quick-yesterday'),
Â  Â  Â  Â  Â  month: document.getElementById('quick-month'),
Â  Â  Â  Â  Â  fiscal: document.getElementById('quick-fiscal')
Â  Â  Â  };

Â  Â  Â  const STORAGE_KEY = 'homeledger_v1_data_v1';
Â  Â  Â  const PENDING_SYNC_KEY = 'homeledger_pending_sync_v1';Â 
Â  Â  Â  const THEME_KEY = 'homeledger_theme_v1';
Â  Â  Â  const SORT_KEY = 'homeledger_sort_v1';
Â  Â  Â  const VERSION_TAG = 'HomeLedger v1.5.3';Â 
Â  Â  Â  let store = { records: [], logs: [] };
Â  Â  Â  let pendingSyncQueue = [];Â 
Â  Â  Â  let currentSort = { key: 'date', order: 'desc' };


Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  // 2. GOOGLE SHEETS SYNC LOGIC
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  // MAKE SURE TO UPDATE THIS URL AFTER DEPLOYING YOUR APPS SCRIPT
Â  Â  Â  const GOOGLE_SHEETS_WEBHOOK = 'https://script.google.com/macros/s/AKfycbzFsmbBc9RPcDUDL97TAhGXl5bSpkZO47_EMIUIznZ1PSRf4vvb0En9sRGP3pSz381X/exec';Â 

Â  Â  Â  // NEW HELPER FUNCTION: Add to Queue
Â  Â  Â  function addToPendingQueue(record, recordStatus) {
Â  Â  Â  Â  Â  const existingIndex = pendingSyncQueue.findIndex(item => item.id === record.guid);
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  const sheetData = {
Â  Â  Â  Â  Â  Â  Â  id: record.guid,
Â  Â  Â  Â  Â  Â  Â  date: record.date,
Â  Â  Â  Â  Â  Â  Â  description: record.desc,
Â  Â  Â  Â  Â  Â  Â  amount: record.sign === 'expense' ? -Number(record.amount) : Number(record.amount),Â 
Â  Â  Â  Â  Â  Â  Â  account: record.account || 'N/A',
Â  Â  Â  Â  Â  Â  Â  status: recordStatus
Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  if (existingIndex > -1) {
Â  Â  Â  Â  Â  Â  Â  pendingSyncQueue[existingIndex] = sheetData;
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  pendingSyncQueue.push(sheetData);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  saveToStorage();
Â  Â  Â  Â  Â  addLog(`[${nowTsForLog()}] ğŸ’¾ Pending Sync: ${recordStatus} request for ${record.desc}. Added to queue.`);
Â  Â  Â  }

Â  Â  Â  // MODIFIED sendRecordToSheets
Â  Â  Â  async function sendRecordToSheets(record, recordStatus = 'Active') {Â 
Â  Â  Â  Â  Â  if (!record || record.amount === 0) return;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  const sheetData = {
Â  Â  Â  Â  Â  Â  Â  id: record.guid,
Â  Â  Â  Â  Â  Â  Â  date: record.date,
Â  Â  Â  Â  Â  Â  Â  description: record.desc,
Â  Â  Â  Â  Â  Â  Â  amount: record.sign === 'expense' ? -Number(record.amount) : Number(record.amount),Â 
Â  Â  Â  Â  Â  Â  Â  account: record.account || 'N/A',
Â  Â  Â  Â  Â  Â  Â  status: recordStatus
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  async function attemptFetch(data) {
Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  await fetch(GOOGLE_SHEETS_WEBHOOK, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mode: 'no-cors',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Content-Type': 'text/plain',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(data)
Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  return true;Â 
Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Sheet Sync Failed (Network Error - Check Internet/URL):', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  const success = await attemptFetch(sheetData);

Â  Â  Â  Â  Â  if (success) {
Â  Â  Â  Â  Â  Â  Â  console.log('Sheets Sync: Request sent successfully.');
Â  Â  Â  Â  Â  Â  Â  const index = pendingSyncQueue.findIndex(item => item.id === record.guid);
Â  Â  Â  Â  Â  Â  Â  if(index > -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â pendingSyncQueue.splice(index, 1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â saveToStorage();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â addLog(`[${nowTsForLog()}] âœ… Sync Success: ${recordStatus} request for ${record.desc} completed and removed from queue.`);
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  // Add to Queue if sync fails
Â  Â  Â  Â  Â  Â  Â  addToPendingQueue(record, recordStatus);
Â  Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  // -------------------------------------------------------------------


Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  // 3. Helper FunctionsÂ 
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  function pad(n){ return String(n).padStart(2,'0'); }
Â  Â  Â  function nowTsForLog(){
Â  Â  Â  Â  const d = new Date();
Â  Â  Â  Â  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
Â  Â  Â  }
Â  Â  Â  function formatAmount(n,sign){
Â  Â  Â  Â  return (sign==='positive'?'Rs ':'Rs ') + Number(n).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
Â  Â  Â  }
Â  Â  Â  function isoFormat(d){
Â  Â  Â  Â  Â  const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), dd = String(d.getDate()).padStart(2,'0');
Â  Â  Â  Â  Â  return `${y}-${m}-${dd}`;
Â  Â  Â  }
Â  Â  Â  function isoToday(){
Â  Â  Â  Â  const d = new Date();
Â  Â  Â  Â  return isoFormat(d);
Â  Â  Â  }
Â  Â  Â  function capitalize(s){ return s.charAt(0).toUpperCase() + s.slice(1); }
Â  Â  Â Â 
Â  Â  Â  function getFiscalYearDates(){
Â  Â  Â  Â  Â  const d = new Date();
Â  Â  Â  Â  Â  const year = d.getFullYear();
Â  Â  Â  Â  Â  const month = d.getMonth();Â 
Â  Â  Â  Â  Â  if (month >= 6) { startYear = year; endYear = year + 1; }Â 
Â  Â  Â  Â  Â  else { startYear = year - 1; endYear = year; }
Â  Â  Â  Â  Â  const fromDate = new Date(startYear, 6, 1);Â 
Â  Â  Â  Â  Â  const toDate = new Date(endYear, 5, 30);Â  Â 
Â  Â  Â  Â  Â  return { from: isoFormat(fromDate), to: isoFormat(toDate) };
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  function seedSampleData() {
Â  Â  Â  Â  Â  return [];Â 
Â  Â  Â  }

    // ***************************************************************
    // ********* FIX APPLIED HERE: saveRecordToLocal (Helper) ********
    // ***************************************************************
    function saveRecordToLocal(record) {
        let records = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        
        // Find the index in the actual records array (not the whole store object)
        const existingIndex = records.records.findIndex(r => r.guid === record.guid);
        
        // Convert Sheet data format back to App format (amount, sign)
        // Note: The Sheet data being restored already contains 'amount' and 'account' which we can use directly.
        
        // Check if the restored record has a 'sign' property. If not, infer it.
        const restoredRecord = {
            ...record,
            amount: String(record.amount), // Ensure it's a string amount for local storage consistency
            // Infer sign based on account type if not explicitly provided (Good practice)
            sign: (record.account === 'Income' || record.account === 'Loan') ? 'positive' : 'expense'
        };


        if (existingIndex > -1) {
            records.records[existingIndex] = restoredRecord; // Update existing
        } else {
            records.records.push(restoredRecord); // Add new
        }
        
        // Re-save the entire store object
        localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
        // Note: This logic assumes records are stored directly in STORAGE_KEY OR that loadFromStorage returns the internal structure.
        // Given your loadFromStorage logic, we must ensure we update the main store object:
        // loadFromStorage logic: if(parsed.records) store.records = parsed.records; 
        
        // Since we are modifying a separate array (records), let's ensure the main store object is updated:
        loadFromStorage();
    }
    // ***************************************************************


Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  // 4. Persistence & Theme
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  function saveToStorage(){
Â  Â  Â  Â  try{Â 
Â  Â  Â  Â  Â  Â  if (store.records.length > 0 || store.logs.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem(STORAGE_KEY);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (pendingSyncQueue.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem(PENDING_SYNC_KEY, JSON.stringify(pendingSyncQueue));
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem(PENDING_SYNC_KEY);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  localStorage.setItem(SORT_KEY, JSON.stringify(currentSort));
Â  Â  Â  Â  }catch(e){}
Â  Â  Â  }
Â  Â  Â  function loadFromStorage(){
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  const raw = localStorage.getItem(STORAGE_KEY);
Â  Â  Â  Â  Â  if(raw){Â 
Â  Â  Â  Â  Â  Â  Â  const parsed = JSON.parse(raw);Â 
Â  Â  Â  Â  Â  Â  Â  if(parsed.records) store.records = parsed.records;Â 
Â  Â  Â  Â  Â  Â  Â  if(parsed.logs) store.logs = parsed.logs;Â 
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  const rawPending = localStorage.getItem(PENDING_SYNC_KEY);
Â  Â  Â  Â  Â  if(rawPending) {
Â  Â  Â  Â  Â  Â  Â  pendingSyncQueue = JSON.parse(rawPending);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  const rawSort = localStorage.getItem(SORT_KEY);
Â  Â  Â  Â  Â  if(rawSort) currentSort = JSON.parse(rawSort);

Â  Â  Â  Â  }catch(e){}
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  function applyTheme(theme){
Â  Â  Â  Â  if(theme === 'light') {
Â  Â  Â  Â  Â  Â  document.body.setAttribute('data-theme','light');
Â  Â  Â  Â  Â  Â  themeToggle.title = 'Switch to Dark Mode';
Â  Â  Â  Â  Â  Â  themeToggle.textContent = '';Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  document.body.removeAttribute('data-theme');
Â  Â  Â  Â  Â  Â  themeToggle.title = 'Switch to Light Mode';
Â  Â  Â  Â  Â  Â  themeToggle.textContent = '';Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  try{ localStorage.setItem(THEME_KEY, theme); }catch(e){}
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  function toggleTheme(){
Â  Â  Â  Â  const cur = localStorage.getItem(THEME_KEY) || 'dark';
Â  Â  Â  Â  const next = (cur === 'dark') ? 'light' : 'dark';
Â  Â  Â  Â  applyTheme(next);
Â  Â  Â  Â  addLog(`[${nowTsForLog()}] Theme changed to ${next}`);
Â  Â  Â  }

Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  // 5. Rendering, Logging, and SummaryÂ 
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â Â 
Â  Â  Â  function calculateGlobalTotals(){
Â  Â  Â  Â  Â  let income = 0, loan = 0, expense = 0;
Â  Â  Â  Â  Â  store.records.forEach(r=>{
Â  Â  Â  Â  Â  Â  Â  const amount = Number(r.amount || 0);
Â  Â  Â  Â  Â  Â  Â  if(r.account === 'Income') income += amount;
Â  Â  Â  Â  Â  Â  Â  else if(r.account === 'Loan') loan += amount;
Â  Â  Â  Â  Â  Â  Â  else if(r.account === 'Expense') expense += amount;
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  const globalBalance = (income + loan) - expense;

Â  Â  Â  Â  Â  // --- 1. Only Update Current Balance (Total) ---
Â  Â  Â  Â  Â  document.getElementById('current-balance').textContent = 'Rs ' + globalBalance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  applyFilters(); // Trigger filtering and rendering of all other summaries/list
Â  Â  Â  Â  Â  saveToStorage();
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  function recalcSummaryAndRender(dateFilteredList, fullFilteredList) {
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // 1. Calculate Income/Loan/Expense Summary Totals based on DATE FILTERED LIST
Â  Â  Â  Â  Â  let income = 0, loan = 0, expense = 0;
Â  Â  Â  Â  Â  dateFilteredList.forEach(r=>{
Â  Â  Â  Â  Â  Â  Â  const amount = Number(r.amount || 0);
Â  Â  Â  Â  Â  Â  Â  if(r.account === 'Income') income += amount;
Â  Â  Â  Â  Â  Â  Â  else if(r.account === 'Loan') loan += amount;
Â  Â  Â  Â  Â  Â  Â  else if(r.account === 'Expense') expense += amount;
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // --- Update Income/Loan/Expense with DATE FILTERED amounts ---
Â  Â  Â  Â  Â  document.getElementById('sum-income').textContent = 'Rs ' + income.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
Â  Â  Â  Â  Â  document.getElementById('sum-loan').textContent = 'Rs ' + loan.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
Â  Â  Â  Â  Â  document.getElementById('sum-expense').textContent = 'Rs ' + expense.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

Â  Â  Â  Â  Â  // 2. Calculate Filtered Balance based on FULL FILTERED LIST
Â  Â  Â  Â  Â  let filteredIncome = 0, filteredLoan = 0, filteredExpense = 0;
Â  Â  Â  Â  Â  fullFilteredList.forEach(r => {
Â  Â  Â  Â  Â  Â  Â  const amount = Number(r.amount || 0);
Â  Â  Â  Â  Â  Â  Â  if(r.account === 'Income') filteredIncome += amount;
Â  Â  Â  Â  Â  Â  Â  else if(r.account === 'Loan') filteredLoan += amount;
Â  Â  Â  Â  Â  Â  Â  else if(r.account === 'Expense') filteredExpense += amount;
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  const filteredBalance = (filteredIncome + filteredLoan) - filteredExpense;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // --- Update Filtered Balance ---
Â  Â  Â  Â  Â  document.getElementById('summary-filtered-balance').textContent = 'Rs ' + filteredBalance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

Â  Â  Â  Â  Â  // 3. Render Records
Â  Â  Â  Â  Â  renderRecords(fullFilteredList);
Â  Â  Â  }

Â  Â  Â  function renderRecords(list) {
Â  Â  Â  Â  Â  // 1. Apply Sorting
Â  Â  Â  Â  Â  list.sort(sortRecords);
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // 2. Create HTML
Â  Â  Â  Â  Â  let html = '';
Â  Â  Â  Â  Â  if (list.length === 0) {
Â  Â  Â  Â  Â  Â  Â  html = '<div class="empty-state">No records found matching the filters.</div>';
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  list.forEach(r => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  const color = r.account === 'Income' ? 'var(--success)' : r.account === 'Loan' ? 'var(--warning)' : 'var(--danger)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  const amountDisplay = formatAmount(r.amount, r.sign);
Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="record-row" data-id="${r.guid}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>${r.date}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>${r.account}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>${r.desc}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="color:${color};font-weight:700;text-align:right">${amountDisplay}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="record-actions" style="text-align:center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="edit" data-id="${r.guid}" title="Edit">âœï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="delete" data-id="${r.guid}" title="Delete">ğŸ—‘ï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // 3. Insert HTML after header
Â  Â  Â  Â  Â  const existingRows = recordsSection.querySelectorAll('.record-row');
Â  Â  Â  Â  Â  existingRows.forEach(row => row.remove());
Â  Â  Â  Â  Â  recordsHead.insertAdjacentHTML('afterend', html);
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  function renderLog() {
Â  Â  Â  Â  Â  const logModalContent = document.getElementById('activity-log-modal');
Â  Â  Â  Â  Â  const logHtml = store.logs.map(log => `<div class="log-item">${log}</div>`).reverse().join('');
Â  Â  Â  Â  Â  logModalContent.innerHTML = logHtml;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  function addLog(message){
Â  Â  Â  Â  Â  store.logs.push(message);
Â  Â  Â  Â  Â  if(store.logs.length > 50) store.logs.shift(); // Keep log size manageable
Â  Â  Â  Â  Â  saveToStorage();
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  function renderLedger() {
Â  Â  Â  Â  Â  calculateGlobalTotals(); // Triggers applyFilters and subsequent rendering
Â  Â  Â  Â  Â  updateSortArrows();
Â  Â  Â  }
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â Â 
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  // 6. Sorting Logic
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  function updateSortArrows() {
Â  Â  Â  Â  Â  recordsHead.querySelectorAll('div').forEach(div => {
Â  Â  Â  Â  Â  Â  Â  div.removeAttribute('data-sort-order');
Â  Â  Â  Â  Â  Â  Â  if (div.getAttribute('data-sort-key') === currentSort.key) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  div.setAttribute('data-sort-order', currentSort.order);
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  }

Â  Â  Â  function sortRecords(a, b) {
Â  Â  Â  Â  Â  const key = currentSort.key;
Â  Â  Â  Â  Â  const order = currentSort.order === 'asc' ? 1 : -1;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  let valA = a[key];
Â  Â  Â  Â  Â  let valB = b[key];

Â  Â  Â  Â  Â  if (key === 'date') {
Â  Â  Â  Â  Â  Â  Â  // Date is already in ISO format (YYYY-MM-DD), so string comparison works
Â  Â  Â  Â  Â  } else if (key === 'amount') {
Â  Â  Â  Â  Â  Â  Â  // Convert amount to number for numerical sorting
Â  Â  Â  Â  Â  Â  Â  valA = Number(valA);
Â  Â  Â  Â  Â  Â  Â  valB = Number(valB);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  // Default to locale-aware string comparison for account/description
Â  Â  Â  Â  Â  Â  Â  valA = String(valA).toLowerCase();
Â  Â  Â  Â  Â  Â  Â  valB = String(valB).toLowerCase();
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  if (valA < valB) return -1 * order;
Â  Â  Â  Â  Â  if (valA > valB) return 1 * order;
Â  Â  Â  Â  Â  return 0; // Values are equal
Â  Â  Â  }
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â Â 
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  // 7. Filtering Logic
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  function applyFilters() {
Â  Â  Â  Â  Â  const searchVal = filterSearch.value.toLowerCase().trim();
Â  Â  Â  Â  Â  const accountVal = filterAccount.value;
Â  Â  Â  Â  Â  const fromDate = filterFrom.value;
Â  Â  Â  Â  Â  const toDate = filterTo.value;

Â  Â  Â  Â  Â  // 1. Date Filtering (for Summary)
Â  Â  Â  Â  Â  const dateFilteredList = store.records.filter(r => {
Â  Â  Â  Â  Â  Â  Â  const rDate = r.date;
Â  Â  Â  Â  Â  Â  Â  const isAfterFrom = !fromDate || rDate >= fromDate;
Â  Â  Â  Â  Â  Â  Â  const isBeforeTo = !toDate || rDate <= toDate;
Â  Â  Â  Â  Â  Â  Â  return isAfterFrom && isBeforeTo;
Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  // 2. Full Filtering (for Records List)
Â  Â  Â  Â  Â  const fullFilteredList = dateFilteredList.filter(r => {
Â  Â  Â  Â  Â  Â  Â  // Account Filter
Â  Â  Â  Â  Â  Â  Â  const accountMatch = accountVal === 'All Accounts' || r.account === accountVal;
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  // Search Filter
Â  Â  Â  Â  Â  Â  Â  const searchMatch = !searchVal || 
Â  Â  Â  Â  Â  Â  Â  Â  Â  r.desc.toLowerCase().includes(searchVal) || 
Â  Â  Â  Â  Â  Â  Â  Â  Â  String(r.amount).includes(searchVal);
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  return accountMatch && searchMatch;
Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  recalcSummaryAndRender(dateFilteredList, fullFilteredList);
Â  Â  Â  }

Â  Â  Â  function updateQuickFilterUI(activeButtonId) {
Â  Â  Â  Â  Â  Object.values(quickFilterButtons).forEach(btn => btn.classList.remove('active'));
Â  Â  Â  Â  Â  if (activeButtonId) {
Â  Â  Â  Â  Â  Â  Â  const activeBtn = document.getElementById(activeButtonId);
Â  Â  Â  Â  Â  Â  Â  if (activeBtn) activeBtn.classList.add('active');
Â  Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  // -------------------------------------------------------------------

Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  // 8. CRUD Logic (Main Logic)
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  let currentEditId = null;
Â  Â  Â  let currentEditAccountType = 'expense';

Â  Â  Â  function showModal(actionType, record = null) {
Â  Â  Â  Â  Â  currentEditId = record ? record.guid : null;
Â  Â  Â  Â  Â  currentEditAccountType = actionType;

Â  Â  Â  Â  Â  // Reset
Â  Â  Â  Â  Â  title.textContent = capitalize(actionType) + ' Entry';
Â  Â  Â  Â  Â  dateInput.value = isoToday();
Â  Â  Â  Â  Â  descInput.value = '';
Â  Â  Â  Â  Â  amtInput.value = '';
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // Set Account Type
Â  Â  Â  Â  Â  accountSelect.value = capitalize(actionType);
Â  Â  Â  Â  Â  accountSelect.disabled = true;

Â  Â  Â  Â  Â  // Update Save button color
Â  Â  Â  Â  Â  saveBtn.className = `btn-save ${actionType}`;

Â  Â  Â  Â  Â  if (record) {
Â  Â  Â  Â  Â  Â  Â  title.textContent = 'Edit Record';
Â  Â  Â  Â  Â  Â  Â  dateInput.value = record.date;
Â  Â  Â  Â  Â  Â  Â  accountSelect.value = record.account;
Â  Â  Â  Â  Â  Â  Â  descInput.value = record.desc;
Â  Â  Â  Â  Â  Â  Â  amtInput.value = record.amount;
Â  Â  Â  Â  Â  Â  Â  accountSelect.disabled = false; // Allow editing account type for existing records
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  // Update Save button colour based on current account type
Â  Â  Â  Â  Â  Â  Â  const currentSign = record.account.toLowerCase();
Â  Â  Â  Â  Â  Â  Â  saveBtn.className = `btn-save ${currentSign === 'income' || currentSign === 'loan' ? currentSign : 'expense'}`;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  overlay.classList.add('show');
Â  Â  Â  Â  Â  dateInput.focus();
Â  Â  Â  }

Â  Â  Â  function hideModal() {
Â  Â  Â  Â  Â  overlay.classList.remove('show');
Â  Â  Â  }

Â  Â  Â  function showDeleteModal(record) {
Â  Â  Â  Â  Â  deleteConfirmBtn.dataset.id = record.guid;
Â  Â  Â  Â  Â  deleteDetailsDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  <strong>Date:</strong> ${record.date}<br>
Â  Â  Â  Â  Â  Â  Â  <strong>Account:</strong> ${record.account}<br>
Â  Â  Â  Â  Â  Â  Â  <strong>Description:</strong> ${record.desc}<br>
Â  Â  Â  Â  Â  Â  Â  <strong>Amount:</strong> ${formatAmount(record.amount, record.sign)}
Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  deleteOverlay.classList.add('show');
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  function hideDeleteModal() {
Â  Â  Â  Â  Â  deleteOverlay.classList.remove('show');
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  function showResetModal() {
Â  Â  Â  Â  Â  resetOverlay.classList.add('show');
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  function hideResetModal() {
Â  Â  Â  Â  Â  resetOverlay.classList.remove('show');
Â  Â  Â  }


Â  Â  Â  function saveEntry() {
Â  Â  Â  Â  Â  const date = dateInput.value;
Â  Â  Â  Â  Â  const account = accountSelect.value;
Â  Â  Â  Â  Â  const desc = descInput.value.trim();
Â  Â  Â  Â  Â  const amount = Number(amtInput.value);

Â  Â  Â  Â  Â  if (!date || !desc || isNaN(amount) || amount <= 0) {
Â  Â  Â  Â  Â  Â  Â  alert('Please fill in all fields with valid data.');
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  const sign = (account === 'Income' || account === 'Loan') ? 'positive' : 'expense';
Â  Â  Â  Â  Â  let logMessage;
Â  Â  Â  Â  Â  let status = 'Active';Â 

Â  Â  Â  Â  Â  if (currentEditId) {
Â  Â  Â  Â  Â  Â  Â  const index = store.records.findIndex(r => r.guid === currentEditId);
Â  Â  Â  Â  Â  Â  Â  if (index > -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  // EDIT RECORD
Â  Â  Â  Â  Â  Â  Â  Â  Â  logMessage = `Edit: ${store.records[index].desc} -> ${desc} on ${date} (Rs ${amount.toFixed(2)})`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  status = 'Edit';Â // Set status to Edit
Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  store.records[index] = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  date: date,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  account: account,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  desc: desc,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  amount: amount.toFixed(2),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sign: sign,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  guid: currentEditId
Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  // Send to sheet with 'Edit' status
Â  Â  Â  Â  Â  Â  Â  Â  Â  sendRecordToSheets(store.records[index], status);
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  // NEW RECORD
Â  Â  Â  Â  Â  Â  Â  const newId = crypto.randomUUID();
Â  Â  Â  Â  Â  Â  Â  const newRecord = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  date: date,
Â  Â  Â  Â  Â  Â  Â  Â  Â  account: account,
Â  Â  Â  Â  Â  Â  Â  Â  Â  desc: desc,
Â  Â  Â  Â  Â  Â  Â  Â  Â  amount: amount.toFixed(2),
Â  Â  Â  Â  Â  Â  Â  Â  Â  sign: sign,
Â  Â  Â  Â  Â  Â  Â  Â  Â  guid: newId
Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  logMessage = `New ${capitalize(account)}: ${desc} on ${date} (Rs ${amount.toFixed(2)})`;
Â  Â  Â  Â  Â  Â  Â  status = 'Active'; // New records are 'Active'
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  store.records.unshift(newRecord);
Â  Â  Â  Â  Â  Â  Â  // Send to sheet with 'Active' status
Â  Â  Â  Â  Â  Â  Â  sendRecordToSheets(newRecord, status);
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  addLog(`[${nowTsForLog()}] ${logMessage}`);
Â  Â  Â  Â  Â  hideModal();
Â  Â  Â  Â  Â  renderLedger();
Â  Â  Â  }

Â  Â  Â  function deleteEntry(id) {
Â  Â  Â  Â  Â  const index = store.records.findIndex(r => r.guid === id);
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  if (index > -1) {
Â  Â  Â  Â  Â  Â  Â  const recordToDelete = store.records[index];
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  // Send to sheet with 'Deleted' status
Â  Â  Â  Â  Â  Â  Â  sendRecordToSheets(recordToDelete, 'Deleted');
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  // Remove from local store
Â  Â  Â  Â  Â  Â  Â  store.records.splice(index, 1);
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  addLog(`[${nowTsForLog()}] Deleted: ${recordToDelete.desc} (Rs ${recordToDelete.amount})`);
Â  Â  Â  Â  Â  Â  Â  hideDeleteModal();
Â  Â  Â  Â  Â  Â  Â  renderLedger();
Â  Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  // -------------------------------------------------------------------


Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  // 9. Sync/Backup/Restore Functions
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â Â 
Â  Â  Â  // ***************************************************************
Â  Â  Â  // ********* FIX APPLIED HERE: restoreSheetRecords ***************
Â  Â  Â  // ***************************************************************
Â  Â  Â  function restoreSheetRecords() {
Â  Â  Â  Â  Â  // Get the Google App Script URL from the input field (using the hardcoded one for consistency)
Â  Â  Â  Â  Â  const sheetUrl = GOOGLE_SHEETS_WEBHOOK;
Â  Â  Â  Â  Â  if (!sheetUrl) {
Â  Â  Â  Â  Â  Â  Â  alert('Google Sheet Web App URL is missing in the code.');
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // Show loading state (You need to add a loading indicator element in your HTML/CSS if it doesn't exist)
Â  Â  Â  Â  Â  // document.getElementById('loading').style.display = 'block'; // Commented out as 'loading' element is not in HTML

Â  Â  Â  Â  Â  // Construct the URL with action=getall and JSONP callback
Â  Â  Â  Â  Â  const scriptUrl = sheetUrl + '?action=getall&callback=handleRestoreResponse';

Â  Â  Â  Â  Â  // Inject the script tag to perform the JSONP call
Â  Â  Â  Â  Â  const script = document.createElement('script');
Â  Â  Â  Â  Â  script.src = scriptUrl;
Â  Â  Â  Â  Â  script.id = 'restore_script_tag'; // ID added for easy removal
Â  Â  Â  Â  Â  document.head.appendChild(script);
Â  Â  Â  Â  Â  addLog(`[${nowTsForLog()}] Initiated Restore from Sheet...`);
Â  Â  Â  }

Â  Â  Â  // ***************************************************************
Â  Â  Â  // ********* FIX APPLIED HERE: handleRestoreResponse *************
Â  Â  Â  // ***************************************************************
Â  Â  Â  window.handleRestoreResponse = function(response) {
Â  Â  Â  Â  Â  // Remove the temporary script tag
Â  Â  Â  Â  Â  const scriptTag = document.getElementById('restore_script_tag');
Â  Â  Â  Â  Â  if (scriptTag) scriptTag.remove();

Â  Â  Â  Â  Â  // Hide loading state (Commented out as 'loading' element is not in HTML)
Â  Â  Â  Â  Â  // document.getElementById('loading').style.display = 'none';

Â  Â  Â  Â  Â  if (response.error) {
Â  Â  Â  Â  Â  Â  Â  alert('Error restoring data from sheet: ' + response.error);
Â  Â  Â  Â  Â  Â  Â  addLog(`[${nowTsForLog()}] âŒ Sheet Restore Failed: ${response.error}`);
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  let recordsRestored = 0;
Â  Â  Â  Â  Â  const allRecords = response.records || [];

Â  Â  Â  Â  Â  // Clear current records before restoring
Â  Â  Â  Â  Â  store.records = []; // Clear the in-memory array

Â  Â  Â  Â  Â  // Restore the records that are 'Active' or 'Edit'
Â  Â  Â  Â  Â  allRecords.forEach(record => {
Â  Â  Â  Â  Â  Â  Â  // *** CORE FIX: 'Edit' status ko shamil kiya gaya hai ***
Â  Â  Â  Â  Â  Â  Â  // Note: App Script is sending 'status' and 'status_normalized'
Â  Â  Â  Â  Â  Â  Â  const statusToCheck = String(record.status_normalized || record.status).toUpperCase();
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  if (statusToCheck === 'ACTIVE' || statusToCheck === 'EDIT') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  // Restore the record to local store
                    // We need to convert the sheet format back to local format (with 'sign')
                    const accountType = record.account;
                    const sign = (accountType === 'Income' || accountType === 'Loan') ? 'positive' : 'expense';

                    const newRecord = {
                        date: record.date,
                        account: accountType,
                        desc: record.desc,
                        amount: String(record.amount), // Amount is a string in local storage
                        sign: sign,
                        guid: record.guid
                    };
Â  Â  Â  Â  Â  Â  Â  Â  Â  store.records.push(newRecord);
Â  Â  Â  Â  Â  Â  Â  Â  Â  recordsRestored++;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  addLog(`[${nowTsForLog()}] âœ… Sheet Restore Success: ${recordsRestored} records loaded.`);

Â  Â  Â  Â  Â  if (recordsRestored > 0) {
Â  Â  Â  Â  Â  Â  Â  alert(`Successfully restored ${recordsRestored} records from Google Sheet.`);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  alert('Successfully restored 0 active records from Google Sheet.');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // Refresh the app UI
Â  Â  Â  Â  Â  renderLedger();
Â  Â  Â  }
Â  Â  Â  // ***************************************************************

Â  Â  Â  async function processPendingQueue() {
Â  Â  Â  Â  Â  if (pendingSyncQueue.length === 0) return;

Â  Â  Â  Â  Â  addLog(`[${nowTsForLog()}] âš™ï¸ Starting sync for ${pendingSyncQueue.length} pending records...`);
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // Copy the queue to process, to prevent modifying the array while looping
Â  Â  Â  Â  Â  const queueToProcess = [...pendingSyncQueue];
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  for (let item of queueToProcess) {
Â  Â  Â  Â  Â  Â  Â  // Find the corresponding record in the store.records array
Â  Â  Â  Â  Â  Â  Â  const record = store.records.find(r => r.guid === item.id);
Â  Â  Â  Â  Â  Â  Â  if (record) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  // Re-send the record with its original status
Â  Â  Â  Â  Â  Â  Â  Â  Â  await sendRecordToSheets(record, item.status);
Â  Â  Â  Â  Â  Â  Â  } else if (item.status === 'Deleted') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  // If deleted locally and pending 'Deleted' sync, try to send it again
Â  Â  Â  Â  Â  Â  Â  Â  Â  // Reconstruct a dummy record just enough to send the delete request
Â  Â  Â  Â  Â  Â  Â  Â  Â  const dummyRecord = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  guid: item.id,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  amount: 0, // Amount is irrelevant for delete sync
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  desc: 'Deleted Record',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  date: isoToday(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sign: 'expense'
Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  await sendRecordToSheets(dummyRecord, 'Deleted');
Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  // Record not found locally and status is not deleted, so remove it from queue as an error
Â  Â  Â  Â  Â  Â  Â  Â  Â  const index = pendingSyncQueue.findIndex(r => r.id === item.id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (index > -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pendingSyncQueue.splice(index, 1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveToStorage();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addLog(`[${nowTsForLog()}] ğŸ—‘ï¸ Removed orphan record ${item.id} from sync queue.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  addLog(`[${nowTsForLog()}] ğŸ Sync process finished. ${pendingSyncQueue.length} records remaining.`);
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  function backupToJSON() {
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  const data = JSON.stringify(store, null, 2);
Â  Â  Â  Â  Â  Â  Â  const blob = new Blob([data], { type: 'application/json' });
Â  Â  Â  Â  Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  Â  Â  Â  Â  a.href = url;
Â  Â  Â  Â  Â  Â  Â  a.download = `homeledger_backup_${isoToday()}.json`;
Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(a);
Â  Â  Â  Â  Â  Â  Â  a.click();
Â  Â  Â  Â  Â  Â  Â  document.body.removeChild(a);
Â  Â  Â  Â  Â  Â  Â  URL.revokeObjectURL(url);
Â  Â  Â  Â  Â  Â  Â  addLog(`[${nowTsForLog()}] âœ… Backup complete.`);
Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  alert('Backup failed: ' + e.message);
Â  Â  Â  Â  Â  Â  Â  addLog(`[${nowTsForLog()}] âŒ Backup Failed: ${e.message}`);
Â  Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  function restoreFromJSONFile(file) {
Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  reader.onload = function(e) {
Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  const restoredStore = JSON.parse(e.target.result);
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (restoredStore.records && Array.isArray(restoredStore.records)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  store = restoredStore;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveToStorage();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderLedger();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(`Successfully restored ${store.records.length} records from file.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addLog(`[${nowTsForLog()}] âœ… Restored ${store.records.length} records from local file.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('Invalid backup file structure.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('Failed to restore data: ' + error.message);
Â  Â  Â  Â  Â  Â  Â  Â  Â  addLog(`[${nowTsForLog()}] âŒ Restore Failed: ${error.message}`);
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  reader.readAsText(file);
Â  Â  Â  }

Â  Â  Â  function resetAllData() {
Â  Â  Â  Â  Â  localStorage.removeItem(STORAGE_KEY);
Â  Â  Â  Â  Â  localStorage.removeItem(PENDING_SYNC_KEY);
Â  Â  Â  Â  Â  store = { records: [], logs: [] };
Â  Â  Â  Â  Â  pendingSyncQueue = [];
Â  Â  Â  Â  Â  renderLedger();
Â  Â  Â  Â  Â  hideResetModal();
Â  Â  Â  Â  Â  alert('All data has been deleted and the app has been reset.');
Â  Â  Â  Â  Â  // Optionally: reload the page to ensure all state is cleared
Â  Â  Â  Â  Â  // window.location.reload(); 
Â  Â  Â  }
Â  Â  Â  // -------------------------------------------------------------------


Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  // 10. Event Listeners and Initialization
Â  Â  Â  // -------------------------------------------------------------------
Â  Â  Â  function init() {
Â  Â  Â  Â  Â  // Load data and theme
Â  Â  Â  Â  Â  loadFromStorage();
Â  Â  Â  Â  Â  const savedTheme = localStorage.getItem(THEME_KEY) || 'dark';
Â  Â  Â  Â  Â  applyTheme(savedTheme);

Â  Â  Â  Â  Â  // Check for initial data and seed if empty
Â  Â  Â  Â  Â  if (store.records.length === 0) {
Â  Â  Â  Â  Â  Â  Â  store.records = seedSampleData();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // Render the full ledger
Â  Â  Â  Â  Â  renderLedger();
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // Initial sync attempt
Â  Â  Â  Â  Â  processPendingQueue();
Â  Â  Â  }

Â  Â  Â  // --- General Action Listeners ---
Â  Â  Â  document.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  // Modal Buttons (Add/Edit)
Â  Â  Â  Â  Â  if (e.target.classList.contains('big-btn')) {
Â  Â  Â  Â  Â  Â  Â  showModal(e.target.dataset.action);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // Record Actions (Edit/Delete)
Â  Â  Â  Â  Â  if (e.target.dataset.action === 'edit' || e.target.dataset.action === 'delete') {
Â  Â  Â  Â  Â  Â  Â  const recordId = e.target.dataset.id;
Â  Â  Â  Â  Â  Â  Â  const record = store.records.find(r => r.guid === recordId);
Â  Â  Â  Â  Â  Â  Â  if (record) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (e.target.dataset.action === 'edit') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showModal(record.account.toLowerCase(), record);
Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showDeleteModal(record);
Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  // --- Modal Listeners ---
Â  Â  Â  saveBtn.addEventListener('click', saveEntry);
Â  Â  Â  cancelBtn.addEventListener('click', hideModal);
Â  Â  Â  deleteCancelBtn.addEventListener('click', hideDeleteModal);
Â  Â  Â  deleteConfirmBtn.addEventListener('click', (e) => deleteEntry(e.target.dataset.id));
Â  Â  Â  accountSelect.addEventListener('change', (e) => {
Â  Â  Â  Â  Â  // Update save button color when editing
Â  Â  Â  Â  Â  const currentSign = e.target.value.toLowerCase();
Â  Â  Â  Â  Â  saveBtn.className = `btn-save ${currentSign === 'income' || currentSign === 'loan' ? currentSign : 'expense'}`;
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  // --- Top Menu Listeners ---
Â  Â  Â  themeToggle.addEventListener('click', toggleTheme);
Â  Â  Â  btnLog.addEventListener('click', () => { renderLog(); logOverlay.classList.add('show'); });
Â  Â  Â  logClose.addEventListener('click', () => logOverlay.classList.remove('show'));
Â  Â  Â  btnReset.addEventListener('click', showResetModal);
Â  Â  Â  resetCancelBtn.addEventListener('click', hideResetModal);
Â  Â  Â  resetConfirmBtn.addEventListener('click', resetAllData);
Â  Â  Â  btnBackup.addEventListener('click', backupToJSON);
Â  Â  Â  btnRestore.addEventListener('click', () => restoreFileInput.click());
Â  Â  Â  btnRestoreSheet.addEventListener('click', restoreSheetRecords);
Â  Â  Â Â 
Â  Â  Â  // --- Restore File Listener ---
Â  Â  Â  restoreFileInput.addEventListener('change', (e) => {
Â  Â  Â  Â  Â  const file = e.target.files[0];
Â  Â  Â  Â  Â  if (file) restoreFromJSONFile(file);
Â  Â  Â  Â  Â  e.target.value = ''; // Clear file input
Â  Â  Â  });

Â  Â  Â  // --- Export CSV Listener ---
Â  Â  Â  btnExport.addEventListener('click', () => {
Â  Â  Â  Â  Â  const csv = [
Â  Â  Â  Â  Â  Â  Â  'Date,Account,Description,Amount,Sign,GUID',
Â  Â  Â  Â  Â  Â  Â  ...store.records.map(r => `${r.date},"${r.account}","${r.desc}",${r.amount},${r.sign},${r.guid}`)
Â  Â  Â  Â  Â  ].join('\n');
Â  Â  Â  Â  Â  const blob = new Blob([csv], { type: 'text/csv' });
Â  Â  Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  Â  Â  a.href = url;
Â  Â  Â  Â  Â  a.download = `homeledger_export_${isoToday()}.csv`;
Â  Â  Â  Â  Â  document.body.appendChild(a);
Â  Â  Â  Â  Â  a.click();
Â  Â  Â  Â  Â  document.body.removeChild(a);
Â  Â  Â  Â  Â  URL.revokeObjectURL(url);
Â  Â  Â  Â  Â  addLog(`[${nowTsForLog()}] âœ… Export to CSV complete.`);
Â  Â  Â  });

Â  Â  Â  // --- Filter Listeners ---
Â  Â  Â  filterSearch.addEventListener('input', applyFilters);
Â  Â  Â  filterAccount.addEventListener('change', () => { updateQuickFilterUI(null); applyFilters(); });
Â  Â  Â  filterFrom.addEventListener('change', () => { updateQuickFilterUI(null); applyFilters(); });
Â  Â  Â  filterTo.addEventListener('change', () => { updateQuickFilterUI(null); applyFilters(); });
Â  Â  Â Â 
Â  Â  Â  // --- Quick Filter Logic ---
Â  Â  Â  quickFilterButtons.today.addEventListener('click', () => {
Â  Â  Â  Â  Â  const today = isoToday();
Â  Â  Â  Â  Â  filterFrom.value = today;
Â  Â  Â  Â  Â  filterTo.value = today;
Â  Â  Â  Â  Â  updateQuickFilterUI('quick-today');
Â  Â  Â  Â  Â  applyFilters();
Â  Â  Â  });
Â  Â  Â  quickFilterButtons.yesterday.addEventListener('click', () => {
Â  Â  Â  Â  Â  const d = new Date();
Â  Â  Â  Â  Â  d.setDate(d.getDate() - 1);
Â  Â  Â  Â  Â  const yesterday = isoFormat(d);
Â  Â  Â  Â  Â  filterFrom.value = yesterday;
Â  Â  Â  Â  Â  filterTo.value = yesterday;
Â  Â  Â  Â  Â  updateQuickFilterUI('quick-yesterday');
Â  Â  Â  Â  Â  applyFilters();
Â  Â  Â  });
Â  Â  Â  quickFilterButtons.month.addEventListener('click', () => {
Â  Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  Â  const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
Â  Â  Â  Â  Â  filterFrom.value = isoFormat(firstDayOfMonth);
Â  Â  Â  Â  Â  filterTo.value = isoToday();
Â  Â  Â  Â  Â  updateQuickFilterUI('quick-month');
Â  Â  Â  Â  Â  applyFilters();
Â  Â  Â  });
Â  Â  Â  quickFilterButtons.fiscal.addEventListener('click', () => {
Â  Â  Â  Â  Â  const dates = getFiscalYearDates();
Â  Â  Â  Â  Â  filterFrom.value = dates.from;
Â  Â  Â  Â  Â  filterTo.value = dates.to;
Â  Â  Â  Â  Â  updateQuickFilterUI('quick-fiscal');
Â  Â  Â  Â  Â  applyFilters();
Â  Â  Â  });

Â  Â  Â  // --- Sorting Listeners ---
Â  Â  Â  recordsHead.querySelectorAll('div').forEach(div => {
Â  Â  Â  Â  Â  div.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  const key = e.target.dataset.sortKey;
Â  Â  Â  Â  Â  Â  Â  if (key) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentSort.key === key) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentSort.key = key;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentSort.order = 'desc'; // Default to descending for date/amount
Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  renderLedger();
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  });

Â  Â  Â  // Initialize the app
Â  Â  Â  init();
Â  Â  })();
Â  </script>
</body>
</html>
